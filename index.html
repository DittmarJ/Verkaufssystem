<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kassensystem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .pos-container {
            width: 100%;
            max-width: 1024px;
            height: 768px; /* Fixed height for the entire POS system screen */
            background-color: #1a1a1a;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 5px solid #000;
        }
        .header-bar {
            background-color: #383838;
            color: #ccc;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            border-top-left-radius: 1.2rem;
            border-top-right-radius: 1.2rem;
            border-bottom: 1px solid #4a4a4a;
            height: 60px; /* Fixed height for the header */
        }
        .header-bar .user-badge {
            background-color: #007bff;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .header-bar .status-item {
            margin-left: 1.5rem;
            font-weight: 600;
        }
        .header-bar .change-display {
            color: #66ff66;
            font-weight: bold;
            font-size: 1.1rem;
            margin-left: 0.5rem;
        }
        .main-content {
            flex-grow: 1; /* Takes remaining height after header and footer */
            display: flex;
            padding: 1rem;
            gap: 1rem;
        }
        .left-panel {
            background-color: #2e2e2e;
            width: 350px; /* Fixed width for the left panel */
            flex-shrink: 0; /* Prevents it from shrinking */
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            color: #eee;
            border: 1px solid #4a4a4a;
            height: 100%; /* Takes 100% of main-content's height */
        }
        .order-list-header {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0.25rem;
            font-weight: bold;
            border-bottom: 1px solid #5a5a5a;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #bbb;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        .order-list-container {
            flex-grow: 1; /* Takes all available vertical space in left-panel */
            overflow-y: auto; /* Enable scrolling for overflow */
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0.25rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.1s ease;
        }
        .order-item:hover {
            background-color: #3b3b3b;
        }
        .order-item .qty { width: 10%; text-align: left; }
        .order-item .name { width: 60%; text-align: left; }
        .order-item .price { width: 30%; text-align: right; }
        .summary-section {
            padding-top: 1rem;
            font-size: 1.1rem;
            border-top: 1px solid #5a5a5a;
            flex-shrink: 0; /* Prevent summary from shrinking */
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        .summary-item.subtotal {
            font-size: 1.1rem;
            color: #ccc;
        }
        .summary-item.total {
            font-weight: bold;
            font-size: 1.5rem;
            color: #ffcc00;
        }
        .summary-item.cash {
            font-size: 1.1rem;
            color: #ccc;
        }
        .summary-item.change {
            font-weight: bold;
            font-size: 1.5rem;
            color: #66ff66;
        }
        .right-panel {
            flex: 1; /* Takes all remaining width */
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.7rem;
            align-content: start;
            height: 100%; /* Takes 100% of main-content's height */
        }
        .product-button {
            background-color: #555;
            color: white;
            padding: 1rem 0.5rem;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            height: 75px;
        }
        .product-button:hover {
            background-color: #666;
        }
        /* Color classes for dynamic categories */
        .product-button.yellow { background-color: #ffc107; color: #333; }
        .product-button.orange { background-color: #fd7e14; }
        .product-button.purple { background-color: #6f42c1; }
        .product-button.green { background-color: #28a745; }
        .product-button.blue { background-color: #007bff; }
        .product-button.red { background-color: #dc3545; }
        .product-button.light-blue { background-color: #17a2b8; }
        .product-button.pink { background-color: #e83e8c; }
        .product-button.gray { background-color: #6c757d; }


        .bottom-panel-container {
            background-color: #2e2e2e;
            padding: 1rem;
            border-bottom-left-radius: 1.2rem;
            border-bottom-right-radius: 1.2rem;
            color: white;
            border-top: 1px solid #4a4a4a;
            height: 300px; /* Sufficient height for dynamic content */
        }

        .input-display-area {
            display: flex;
            align-items: center;
            background-color: #1a1a1a;
            border-radius: 0.5rem;
            margin-bottom: 0.7rem;
            border: 1px solid #4a4a4a;
            min-height: 2.5rem; /* ~40px */
            padding-right: 1rem; /* Padding for the display text */
        }

        .input-display-line {
            flex-grow: 1; /* Takes up remaining space */
            color: #66ff66;
            font-size: 2rem;
            font-weight: bold;
            text-align: right;
            padding: 0.5rem 0; /* Padding handled by parent */
        }

        .clear-input-button {
            background-color: #dc3545; /* Red color for Clear */
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-left: 0.5rem; /* Space between button and display */
            height: 40px; /* Match height of input display roughly */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .clear-input-button:hover {
            background-color: #c82333;
        }

        .bottom-panel {
            display: grid;
            grid-template-columns: repeat(3, 0.8fr) 1fr 1.2fr;
            gap: 0.7rem;
        }
        
        .num-button, .action-button {
            height: 60px; /* Smaller consistent height for all buttons */
            border-radius: 0.75rem; /* Ensure rounded corners for consistency */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            padding: 0.5rem; /* Reduced padding for smaller buttons */
        }

        .num-button {
            background-color: #505050;
            font-size: 1.2rem; /* Smaller font size for numbers */
        }
        .num-button:hover {
            background-color: #606060;
        }
        .num-button.decimal {
            font-size: 1.8rem; /* Slightly larger font for decimal comma */
        }

        .action-button {
            background-color: #444;
            font-size: 1.2rem; /* Standard font size for action buttons (now smaller overall) */
        }
        .action-button:hover {
            background-color: #555;
        }

        .action-button[data-input="X"],
        .action-button[data-action="function"][data-function="zws"],
        .action-button[data-action="function"][data-function="bar"] {
            font-size: 1.6rem; /* Larger font size to make them stand out */
        }
        
        .action-button.yellow-func { background-color: #ffc107; color: #333; }
        .action-button.purple-func { background-color: #6f42c1; }
        .action-button.bar-func { background-color: #66ff66; color: #333; }

        /* New Order Button Styling */
        .new-order-button {
            background-color: #28a745; /* Green color */
            color: white;
            font-weight: bold;
            font-size: 2rem;
            padding: 1.5rem;
            border-radius: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
            height: 100%; /* Take full height of its container */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .new-order-button:hover {
            background-color: #218838;
        }

        /* Message Box Styling */
        .message-box-overlay, .admin-login-overlay, .kasse-select-overlay, .live-display-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box, .admin-login-box, .kasse-select-box, .live-display-box {
            background-color: #333;
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 2px solid #555;
        }
        .message-box h3, .admin-login-box h3, .kasse-select-box h3, .live-display-box h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #ffcc00;
        }
        .message-box p, .admin-login-box p, .kasse-select-box p, .live-display-box p {
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        .message-box button, .admin-login-box button, .kasse-select-box button, .live-display-box button {
            background-color: #007bff;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .message-box button:hover, .admin-login-box button:hover, .kasse-select-box button:hover, .live-display-box button:hover {
            background-color: #0056b3;
        }
        .admin-login-box input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            font-size: 1rem;
        }
        .admin-login-box button {
            margin: 0 10px;
        }
        .kasse-select-box .kasse-buttons button {
            display: block;
            width: 80%;
            margin: 1rem auto;
            font-size: 1.5rem;
            padding: 1rem;
            background-color: #28a745;
            color: white;
            border-radius: 0.75rem;
        }
        .kasse-select-box .kasse-buttons button:hover {
            background-color: #218838;
        }
        .live-display-box input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            font-size: 1rem;
            text-align: center;
        }


        /* Admin Configuration Panel Specific Styles */
        .admin-config-panel {
            grid-template-columns: repeat(2, 1fr);
            overflow-y: auto;
        }
        .admin-config-section {
            background-color: #3b3b3b;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        .admin-config-section h4 {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #ffcc00;
        }
        .admin-config-section input, .admin-config-section select {
            width: calc(100% - 20px);
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
        }
        .admin-config-section button {
            background-color: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 5px;
            margin-right: 5px;
        }
        .admin-config-section button.delete {
            background-color: #dc3545;
        }
        .admin-config-section button:hover {
            background-color: #218838;
        }
        .admin-config-section button.delete:hover {
            background-color: #c82333;
        }
        .admin-config-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 5px;
            margin-top: 10px;
        }
        .admin-config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #4a4a4a;
        }
        .admin-config-item:last-child {
            border-bottom: none;
        }
        .admin-config-item button {
            padding: 3px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        /* Admin Main Menu specific styles */
        .admin-main-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            height: 100%; /* Take full height of right-panel */
        }
        .admin-main-menu .menu-button {
            width: 80%;
            max-width: 300px;
            height: 80px;
            font-size: 1.5rem;
            background-color: #007bff;
            color: white;
            border-radius: 1rem;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .admin-main-menu .menu-button:hover {
            background-color: #0056b3;
        }


        /* Wertbon Print Style */
        @media print {
            body > *:not(#print-area-temp) { /* Hide everything except the print area */
                display: none !important;
            }
            #print-area-temp {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm; /* Standard receipt width */
                padding: 10mm;
                font-family: 'monospace';
                font-size: 14px; /* Increased font size */
                line-height: 1.4;
                color: #000;
                box-sizing: border-box;
                page-break-after: always; /* Force a page break after each bon */
            }
            #print-area-temp:last-child {
                page-break-after: auto; /* No page break after the very last bon */
            }
            #print-area-temp .wertbon-print-area {
                width: 100%; /* Ensure inner bons take full width of print area */
                page-break-inside: avoid; /* Avoid breaking individual bons across pages */
            }

            /* Specific styles for elements within wertbon-print-area when printing */
            .wertbon-print-area h2,
            .wertbon-print-area h3 {
                text-align: center;
                margin-bottom: 5px;
            }
            .wertbon-print-area img {
                display: block; /* Ensure image is a block element for centering */
                margin: 0 auto; /* Center image */
            }
            .wertbon-print-area p {
                margin: 5px 0; /* Adjust paragraph margins */
            }
            .wertbon-print-area .dashed-line {
                border-top: 1px dashed #000;
                margin: 15px 0;
            }
            .wertbon-print-area .item-line {
                font-size: 1.2em;
                font-weight: bold;
            }
            .wertbon-print-area .italic-note {
                font-style: italic;
                font-size: 0.9em; /* Smaller for "Bspw." */
            }
            .wertbon-print-area .small-note {
                font-size: 0.9em;
                margin-top: 10px;
            }
            .wertbon-print-area .thank-you {
                font-size: 1.1em;
                font-weight: bold;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="pos-container">
        <div class="header-bar">
            <div class="flex items-center gap-2">
                <span class="user-badge" id="cashierBadge">Kasse: Nicht ausgewählt</span>
                <span id="displayUserId" class="text-sm text-gray-400 ml-2">[UserID: Laden...] (Kat./Prod. Geteilt)</span>
                <button id="liveDisplayLinkBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-full text-sm ml-4">Live Display Link</button>
                <button id="adminLoginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-full text-sm ml-4">Admin Login</button>
                <button id="adminLogoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full text-sm ml-4 hidden">Admin Logout</button>
                <span id="adminModeStatus" class="text-green-400 text-sm ml-2 hidden">Admin-Modus AN</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="status-item">REG</span>
                <span class="status-item">RÜCKGELD</span>
                <span id="changeHeader" class="change-display">€0.00</span>
                <span id="currentTime" class="status-item"></span>
                <span id="currentDate" class="status-item"></span>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="order-list-header">
                    <span class="qty">Menge</span>
                    <span class="name">Artikel</span>
                    <span class="price">Preis</span>
                </div>
                <div class="order-list-container" id="orderList">
                    </div>
                <div class="summary-section">
                    <div class="summary-item subtotal">
                        <span>ZWISCHENSUMME</span>
                        <span id="subtotalAmount">€0.00</span>
                    </div>
                    <div class="summary-item total">
                        <span>TOTAL</span>
                        <span id="totalAmount">€0.00</span>
                    </div>
                    <div class="summary-item cash">
                        <span>BAR</span>
                        <span id="cashAmount">€0.00</span>
                    </div>
                    <div class="summary-item change">
                        <span>RÜCKGELD</span>
                        <span id="changeAmount">€0.00</span>
                    </div>
                </div>
            </div>

            <div class="right-panel" id="rightPanel">
                <div id="loadingMessage" class="col-span-4 text-center text-gray-400 text-lg hidden">Lade Daten...</div>
            </div>
        </div>

        <div class="bottom-panel-container">
            <div class="input-display-area">
                <div id="inputDisplay" class="input-display-line"></div>
                <button id="clearInputButton" class="clear-input-button">C</button>
            </div>
            
            <div id="keypadArea" class="bottom-panel">
                <button class="num-button" data-input="7">7</button>
                <button class="num-button" data-input="8">8</button>
                <button class="num-button" data-input="9">9</button>
                <button class="num-button" data-input="0">0</button>
                <button class="action-button yellow-func" data-input="X">X</button>

                <button class="num-button" data-input="4">4</button>
                <button class="num-button" data-input="5">5</button>
                <button class="num-button" data-input="6">6</button>
                <button class="num-button" data-input="00">00</button>
                <button class="action-button purple-func" data-action="function" data-function="zws">ZWS</button>

                <button class="num-button" data-input="1">1</button>
                <button class="num-button" data-input="2">2</button>
                <button class="num-button" data-input="3">3</button>
                <button class="num-button decimal" data-input=".">,</button>
                <button class="action-button bar-func" data-action="function" data-function="bar">BAR</button>
            </div>

            <div id="newOrderArea" class="hidden" style="height: calc(100% - 2.5rem - 0.7rem);">
                <button id="newOrderButton" class="new-order-button">NEUE BESTELLUNG</button>
            </div>
        </div>
    </div>

    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <h3 id="messageBoxTitle">Nachricht</h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxClose">OK</button>
        </div>
    </div>

    <div id="adminLoginOverlay" class="admin-login-overlay hidden">
        <div class="admin-login-box">
            <h3>Admin Login</h3>
            <input type="text" id="adminUsername" placeholder="Benutzername" value="admin">
            <input type="password" id="adminPassword" placeholder="Passwort" value="admin123">
            <button id="loginBtn">Login</button>
            <button id="cancelLoginBtn">Abbrechen</button>
        </div>
    </div>

    <div id="kasseSelectOverlay" class="kasse-select-overlay">
        <div class="kasse-select-box">
            <h3>Kasse auswählen</h3>
            <p>Bitte wählen Sie Ihre Kasse aus:</p>
            <div class="kasse-buttons">
                <button data-kasse-id="Kasse1">Kasse 1</button>
                <button data-kasse-id="Kasse2">Kasse 2</button>
                <button data-kasse-id="Kasse3">Kasse 3</button>
            </div>
        </div>
    </div>

    <div id="liveDisplayOverlay" class="live-display-overlay hidden">
        <div class="live-display-box">
            <h3>Live Display Link</h3>
            <p>Öffne diesen Link auf dem zweiten iPad:</p>
            <input type="text" id="liveDisplayUrl" readonly>
            <button id="copyLiveDisplayUrlBtn">Link kopieren</button>
            <button id="closeLiveDisplayBtn">Schließen</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase app and services
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous until authenticated
        let selectedKasseId = null; // Stores the selected Kasse ID

        // Firebase Configuration - REPLACE with your actual Firebase project config
        const firebaseConfig = {
          apiKey: "AIzaSyAyO_3QNTZq2IOdvBMm6ZLHYFv96H9F50I",
          authDomain: "verkaufssoftware.firebaseapp.com",
          projectId: "verkaufssoftware",
          storageBucket: "verkaufssoftware.firebasestorage.app",
          messagingSenderId: "268747007466",
          appId: "1:268747007466:web:c84a529f27a0f6849a3e93",
          measurementId: "G-RMX5KJK543"
        };
        // For GitHub deployment, use your projectId as appId
        const appId = firebaseConfig.projectId;


        // DOM Elements
        const orderList = document.getElementById('orderList');
        const subtotalAmount = document.getElementById('subtotalAmount');
        const totalAmount = document.getElementById('totalAmount');
        const cashAmount = document.getElementById('cashAmount');
        const changeAmount = document.getElementById('changeAmount');
        const changeHeader = document.getElementById('changeHeader');
        const currentDateElem = document.getElementById('currentDate');
        const currentTimeElem = document.getElementById('currentTime');
        const displayUserId = document.getElementById('displayUserId'); 
        const cashierBadge = document.getElementById('cashierBadge'); // New: Kasse display

        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxClose = document.getElementById('messageBoxClose');

        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const adminModeStatus = document.getElementById('adminModeStatus');
        const adminLoginOverlay = document.getElementById('adminLoginOverlay');
        const adminUsernameInput = document.getElementById('adminUsername');
        const adminPasswordInput = document.getElementById('adminPassword');
        const loginBtn = document.getElementById('loginBtn');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn'); 

        const kasseSelectOverlay = document.getElementById('kasseSelectOverlay'); // New: Kasse select modal
        const kasseButtons = kasseSelectOverlay.querySelector('.kasse-buttons'); // Container for Kasse buttons

        const rightPanel = document.getElementById('rightPanel');
        const inputDisplay = document.getElementById('inputDisplay'); // Input display element
        const clearInputButton = document.getElementById('clearInputButton'); // New C button

        const keypadArea = document.getElementById('keypadArea'); // Numeric keypad and function buttons area
        const newOrderArea = document.getElementById('newOrderArea'); // "Neue Bestellung" button area
        const newOrderButton = document.getElementById('newOrderButton'); // The "Neue Bestellung" button

        // Live Display Elements
        const liveDisplayLinkBtn = document.getElementById('liveDisplayLinkBtn');
        const liveDisplayOverlay = document.getElementById('liveDisplayOverlay');
        const liveDisplayUrlInput = document.getElementById('liveDisplayUrl');
        const copyLiveDisplayUrlBtn = document.getElementById('copyLiveDisplayUrlBtn');
        const closeLiveDisplayBtn = document.getElementById('closeLiveDisplayBtn');
        const loadingMessage = document.getElementById('loadingMessage'); // Loading message


        // State variables
        let currentOrder = [];
        let multiplier = 1;
        let currentInput = '0.00'; // Initialize with "0.00"
        let cashGiven = 0;
        let isAdminMode = false;
        let currentCategory = null; // Stores the currently selected category for product display
        let currentAdminView = 'main'; // Tracks the current admin view: 'main', 'categories', 'products', 'sellers'

        // POS Data (now dynamically loaded from Firebase)
        let posData = {
            "categories": [],
            "products": {}, // Products will be grouped by category ID in this object
            "sellers": [] // New: Array to store seller data
        };

        // State to track if Firestore listeners have been set up
        let firestoreListenersSetup = false;

        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            try {
                if (firebaseConfig && Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    console.log("Firebase initialized.");

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            displayUserId.textContent = `[UserID: ${userId}] (Kat./Prod. Geteilt)`;
                            console.log("User authenticated. Current userId:", userId);
                            // Only show Kasse selection if not already selected
                            if (!selectedKasseId) {
                                kasseSelectOverlay.classList.remove('hidden');
                            } else {
                                // If Kasse was already selected (e.g., page refresh), set up listeners directly
                                if (!firestoreListenersSetup) {
                                    console.log("Authentication successful, Kasse already selected, calling setupFirestoreListeners.");
                                    setupFirestoreListeners();
                                    firestoreListenersSetup = true;
                                }
                            }
                        } else {
                            console.log("No user, attempting anonymous sign-in...");
                            await signInAnonymously(auth);
                        }
                    });
                } else {
                    showError("Firebase-Konfiguration fehlt oder ist unvollständig. Bitte überprüfen Sie die 'firebaseConfig'.");
                    loadingMessage.textContent = "Fehler: Firebase-Konfiguration fehlt.";
                    loadingMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Fehler bei der Firebase-Initialisierung:", error);
                showError("Fehler bei der Firebase-Initialisierung: " + error.message);
                loadingMessage.textContent = "Fehler: Firebase nicht initialisiert.";
                loadingMessage.classList.remove('hidden');
            }
        }

        // --- Firestore Data Loading and Listeners ---
        function setupFirestoreListeners() {
            console.log("Setting up Firestore listeners...");

            // Listener for Categories (shared for all users)
            onSnapshot(collection(db, "categories"), (snapshot) => {
                const categories = [];
                snapshot.forEach(doc => {
                    categories.push({ id: doc.id, ...doc.data() });
                });
                posData.categories = categories.sort((a, b) => a.order - b.order); // Sort by 'order' field
                console.log("Categories loaded:", posData.categories);
                if (currentAdminView === 'categories') {
                    renderAdminCategories();
                } else if (!isAdminMode) {
                    renderCategories();
                }
            }, (error) => {
                console.error("Error fetching categories:", error);
                showError("Fehler beim Laden der Kategorien: " + error.message);
            });

            // Listener for Products (shared for all users)
            onSnapshot(collection(db, "products"), (snapshot) => {
                const products = {};
                snapshot.forEach(doc => {
                    const product = { id: doc.id, ...doc.data() };
                    if (!products[product.categoryId]) {
                        products[product.categoryId] = [];
                    }
                    products[product.categoryId].push(product);
                });
                // Sort products within each category by their 'order' field
                for (const categoryId in products) {
                    products[categoryId].sort((a, b) => a.order - b.order);
                }
                posData.products = products;
                console.log("Products loaded:", posData.products);
                if (currentAdminView === 'products') {
                    renderAdminProducts();
                } else if (!isAdminMode && currentCategory) {
                    renderProducts(currentCategory);
                }
            }, (error) => {
                console.error("Error fetching products:", error);
                showError("Fehler beim Laden der Produkte: " + error.message);
            });

            // Listener for Sellers (shared for all users)
            onSnapshot(collection(db, "sellers"), (snapshot) => {
                const sellers = [];
                snapshot.forEach(doc => {
                    sellers.push({ id: doc.id, ...doc.data() });
                });
                posData.sellers = sellers.sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically by name
                console.log("Sellers loaded:", posData.sellers);
                if (currentAdminView === 'sellers') {
                    renderAdminSellers();
                }
            }, (error) => {
                console.error("Error fetching sellers:", error);
                showError("Fehler beim Laden der Verkäufer: " + error.message);
            });

            loadingMessage.classList.add('hidden'); // Hide loading message once listeners are set
        }


        // --- UI Rendering Functions ---

        // Render Categories (main screen)
        function renderCategories() {
            rightPanel.innerHTML = ''; // Clear existing content
            if (isAdminMode) return; // Don't render categories in admin mode

            posData.categories.forEach(category => {
                const button = document.createElement('button');
                button.classList.add('product-button');
                if (category.color) {
                    button.classList.add(category.color);
                }
                button.textContent = category.name;
                button.onclick = () => renderProducts(category);
                rightPanel.appendChild(button);
            });
        }

        // Render Products for a selected category
        function renderProducts(category) {
            currentCategory = category; // Store the current category
            rightPanel.innerHTML = ''; // Clear existing content

            // Back button
            const backButton = document.createElement('button');
            backButton.classList.add('product-button', 'blue', 'col-span-4'); // Make it span all columns
            backButton.textContent = `← Zurück zu Kategorien`;
            backButton.onclick = () => {
                currentCategory = null; // Clear current category
                renderCategories();
            };
            rightPanel.appendChild(backButton);

            const productsInCategory = posData.products[category.id] || [];
            productsInCategory.forEach(product => {
                const button = document.createElement('button');
                button.classList.add('product-button');
                if (category.color) {
                    button.classList.add(category.color); // Products inherit category color
                }
                button.innerHTML = `${product.name}<br>€${product.price.toFixed(2)}`;
                button.onclick = () => addProductToOrder(product);
                rightPanel.appendChild(button);
            });
        }

        // Update Order List Display
        function updateOrderList() {
            orderList.innerHTML = '';
            let subtotal = 0;
            currentOrder.forEach((item, index) => {
                const orderItem = document.createElement('div');
                orderItem.classList.add('order-item', 'flex', 'items-center', 'justify-between', 'text-white', 'text-sm', 'border-b', 'border-gray-600', 'py-1');
                orderItem.innerHTML = `
                    <span class="qty">${item.quantity}</span>
                    <span class="name">${item.name}</span>
                    <span class="price">€${(item.price * item.quantity).toFixed(2)}</span>
                `;
                orderItem.dataset.index = index; // Store index for deletion
                orderItem.addEventListener('click', (event) => {
                    // Check if a specific input is active (like 'X' for quantity override)
                    if (multiplier !== 1 || currentInput !== '0.00') {
                        // If input is active, clicking item means applying multiplier/value to this item
                        applyInputToOrderItem(index);
                    } else {
                        // Otherwise, treat as delete
                        deleteOrderItem(index);
                    }
                });
                orderList.appendChild(orderItem);
                subtotal += item.price * item.quantity;
            });
            subtotalAmount.textContent = `€${subtotal.toFixed(2)}`;
            totalAmount.textContent = `€${subtotal.toFixed(2)}`;
            calculateChange(); // Recalculate change after order update
        }

        // Update input display
        function updateInputDisplay() {
            // Remove leading zero if not a decimal or only "0.00"
            let displayedInput = currentInput;
            if (currentInput.length > 1 && currentInput.startsWith('0') && !currentInput.startsWith('0.')) {
                displayedInput = currentInput.substring(1);
            }
            inputDisplay.textContent = `€${displayedInput}`;
            // Update header change display to reflect current input as potential cash given
            const total = parseFloat(totalAmount.textContent.replace('€', ''));
            const cash = parseFloat(displayedInput);
            const change = cash - total;
            changeHeader.textContent = `€${change.toFixed(2)}`;
        }

        // Show a custom message box
        function showMessage(title, content, callback = null) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = content;
            messageBoxOverlay.classList.remove('hidden');
            messageBoxClose.onclick = () => {
                messageBoxOverlay.classList.add('hidden');
                if (callback) callback();
            };
        }

        // Show error message
        function showError(message) {
            showMessage("Fehler", message);
        }

        // --- Core POS Logic ---

        // Add product to current order
        function addProductToOrder(product) {
            let qtyToAdd = multiplier;
            if (currentInput !== '0.00' && currentInput !== '') {
                const inputVal = parseFloat(currentInput.replace(',', '.'));
                if (!isNaN(inputVal) && inputVal > 0) {
                    // If input is a number, assume it's the quantity
                    qtyToAdd = inputVal;
                    currentInput = '0.00'; // Reset input after use
                    updateInputDisplay();
                }
            }
            
            const existingItem = currentOrder.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity += qtyToAdd;
            } else {
                currentOrder.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: qtyToAdd,
                    categoryId: product.categoryId // Store category ID for receipt
                });
            }
            multiplier = 1; // Reset multiplier after adding product
            updateOrderList();
            updateLiveDisplay(); // Update live display
        }

        // Delete order item
        function deleteOrderItem(index) {
            if (index >= 0 && index < currentOrder.length) {
                currentOrder.splice(index, 1);
                updateOrderList();
                updateLiveDisplay(); // Update live display
            }
        }

        // Apply input value as quantity or price override to a specific item
        function applyInputToOrderItem(index) {
            if (index >= 0 && index < currentOrder.length) {
                let item = currentOrder[index];
                let inputVal = parseFloat(currentInput.replace(',', '.'));

                if (isNaN(inputVal) || inputVal <= 0) {
                    showMessage("Ungültige Eingabe", "Bitte geben Sie eine gültige Zahl für die Menge oder den Preis ein.");
                    return;
                }

                if (multiplier === 1 && currentInput !== '0.00') {
                    // If 'X' not pressed, assume direct quantity override
                    item.quantity = inputVal;
                } else if (multiplier > 1) {
                    // If 'X' was pressed, this means multiplier for quantity
                    item.quantity = multiplier; // Set the quantity to the multiplier value
                }
                
                // Reset multiplier and input after applying
                multiplier = 1;
                currentInput = '0.00';
                updateInputDisplay();
                updateOrderList();
                updateLiveDisplay();
            }
        }


        // Handle numeric and decimal input
        function handleNumInput(value) {
            if (currentInput === '0.00' || currentInput === '0') {
                if (value === '.') {
                    currentInput = '0.';
                } else {
                    currentInput = value;
                }
            } else {
                if (value === '.' && currentInput.includes('.')) {
                    // Do nothing if decimal already exists
                    return;
                }
                currentInput += value;
            }
            updateInputDisplay();
        }

        // Handle function buttons (X, ZWS, BAR)
        function handleFunction(func) {
            switch (func) {
                case 'X':
                    // Set multiplier if a number is in the input display
                    const qty = parseFloat(currentInput.replace(',', '.'));
                    if (!isNaN(qty) && qty > 0) {
                        multiplier = qty;
                        currentInput = '0.00'; // Clear input after setting multiplier
                        updateInputDisplay();
                        showMessage("Menge gesetzt", `Nächster Artikel wird ${multiplier}x hinzugefügt.`, () => {}); // Show temporary message
                    } else {
                        showMessage("Ungültige Menge", "Bitte geben Sie eine Zahl für die Menge ein, bevor Sie 'X' drücken.");
                    }
                    break;
                case 'zws': // Zwischensumme / Subtotal
                    // This is handled by updateOrderList, nothing specific here for now
                    break;
                case 'bar': // Barzahlung
                    processPayment();
                    break;
            }
        }

        // Process payment
        async function processPayment() {
            if (currentOrder.length === 0) {
                showMessage("Leere Bestellung", "Es gibt keine Artikel im Warenkorb zum Bezahlen.");
                return;
            }

            const total = parseFloat(totalAmount.textContent.replace('€', ''));
            let cashGivenValue = parseFloat(currentInput.replace(',', '.'));

            if (isNaN(cashGivenValue) || cashGivenValue === 0) {
                cashGivenValue = total; // Assume exact payment if no cash input
            }

            cashGiven = cashGivenValue;
            cashAmount.textContent = `€${cashGiven.toFixed(2)}`;
            calculateChange();

            const change = parseFloat(changeAmount.textContent.replace('€', ''));

            if (change < 0) {
                showMessage("Zahlung unzureichend", `Es fehlen noch €${Math.abs(change).toFixed(2)}.`);
                return;
            }

            // Record transaction
            await recordTransaction(total, cashGiven, change);

            // Print receipt
            await printReceipt(total, cashGiven, change);

            // Clear order and reset POS
            currentOrder = [];
            multiplier = 1;
            currentInput = '0.00';
            cashGiven = 0;
            updateOrderList();
            updateInputDisplay();
            cashAmount.textContent = `€0.00`;
            changeAmount.textContent = `€0.00`;
            changeHeader.textContent = `€0.00`;

            // Show "Neue Bestellung" button
            keypadArea.classList.add('hidden');
            newOrderArea.classList.remove('hidden');

            updateLiveDisplay(); // Clear live display after payment
        }

        // Calculate and display change
        function calculateChange() {
            const total = parseFloat(totalAmount.textContent.replace('€', ''));
            const change = cashGiven - total;
            changeAmount.textContent = `€${change.toFixed(2)}`;
            changeHeader.textContent = `€${change.toFixed(2)}`;
        }

        // Record transaction in Firebase
        async function recordTransaction(total, cashGiven, change) {
            if (!db || !userId || !selectedKasseId) {
                console.error("Firebase DB, User ID, or Kasse ID not available. Cannot record transaction.");
                showMessage("Fehler", "Transaktion konnte nicht gespeichert werden (Firebase-Verbindungsproblem).");
                return;
            }

            const transactionRef = doc(collection(db, "transactions")); // Auto-generate ID
            const timestamp = new Date();

            const transactionData = {
                id: transactionRef.id,
                cashierId: userId,
                kasseId: selectedKasseId, // Save selected Kasse ID
                timestamp: timestamp.toISOString(),
                total: total,
                cashGiven: cashGiven,
                change: change,
                items: currentOrder.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                }))
            };

            try {
                await setDoc(transactionRef, transactionData);
                console.log("Transaction recorded:", transactionData);
            } catch (e) {
                console.error("Error recording transaction: ", e);
                showMessage("Fehler", "Transaktion konnte nicht gespeichert werden: " + e.message);
            }
        }

        // Print receipt
        async function printReceipt(total, cashGiven, change) {
            const printArea = document.createElement('div');
            printArea.id = 'print-area-temp'; // ID for print styles
            printArea.classList.add('wertbon-print-area'); // Class for receipt-specific print styles

            const logoUrl = 'https://i.imgur.com/your-logo.png'; // Replace with your logo URL

            let receiptContent = `
                <img src="${logoUrl}" alt="Logo" style="max-width: 80%; margin-bottom: 10px;">
                <h2>Bon</h2>
                <h3>${new Date().toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit' })} ${new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}</h3>
                <p>Kasse: ${selectedKasseId}</p>
                <p class="dashed-line"></p>
                <p>Artikel:</p>
            `;

            currentOrder.forEach(item => {
                receiptContent += `<p class="item-line">${item.quantity}x ${item.name} €${(item.price * item.quantity).toFixed(2)}</p>`;
            });

            receiptContent += `
                <p class="dashed-line"></p>
                <p class="item-line"><strong>SUMME: €${total.toFixed(2)}</strong></p>
                <p class="item-line">BAR: €${cashGiven.toFixed(2)}</p>
                <p class="item-line">RÜCKGELD: €${change.toFixed(2)}</p>
                <p class="dashed-line"></p>
                <p class="italic-note">Bspw. Inkl. MwSt. - Keine Garantie - Keine Rücknahme</p>
                <p class="small-note">Vielen Dank für Ihren Besuch!</p>
                <p class="thank-you">Bis bald!</p>
            `;
            printArea.innerHTML = receiptContent;

            // Append to body (hidden by print CSS)
            document.body.appendChild(printArea);

            // Trigger print
            window.print();

            // Remove the print area after printing
            document.body.removeChild(printArea);
        }

        // --- Live Display Functionality (Customer Display) ---
        let liveDisplayDocRef = null;

        async function updateLiveDisplay() {
            if (!db || !selectedKasseId) {
                console.warn("Cannot update live display: DB or Kasse ID not selected.");
                return;
            }

            if (!liveDisplayDocRef) {
                liveDisplayDocRef = doc(db, "liveDisplays", selectedKasseId);
            }

            const total = parseFloat(totalAmount.textContent.replace('€', ''));
            const itemsForDisplay = currentOrder.map(item => ({
                name: item.name,
                quantity: item.quantity,
                totalPrice: (item.price * item.quantity).toFixed(2)
            }));

            try {
                await setDoc(liveDisplayDocRef, {
                    kasseId: selectedKasseId,
                    total: total.toFixed(2),
                    items: itemsForDisplay,
                    timestamp: new Date().toISOString()
                }, { merge: true }); // Use merge to avoid overwriting other fields
                console.log("Live display updated for Kasse:", selectedKasseId);
            } catch (e) {
                console.error("Error updating live display:", e);
                // Optionally show a less intrusive message, or log only
            }
        }


        // --- Admin Functions ---

        async function toggleAdminMode() {
            if (isAdminMode) {
                // Logout from admin mode
                isAdminMode = false;
                adminLogoutBtn.classList.add('hidden');
                adminModeStatus.classList.add('hidden');
                adminLoginBtn.classList.remove('hidden');
                showMessage("Admin-Modus", "Admin-Modus beendet.");
                // Return to main POS view
                currentAdminView = 'main';
                if (currentCategory) {
                    renderProducts(currentCategory); // Go back to current category if one was selected
                } else {
                    renderCategories(); // Otherwise, show main categories
                }
            } else {
                // Show login modal
                adminLoginOverlay.classList.remove('hidden');
            }
        }

        async function handleAdminLogin() {
            const username = adminUsernameInput.value;
            const password = adminPasswordInput.value;

            // In a real application, this would involve server-side authentication
            // For this example, we'll use a hardcoded check (NOT SECURE FOR PRODUCTION)
            if (username === "admin" && password === "admin123") {
                isAdminMode = true;
                adminLoginOverlay.classList.add('hidden');
                adminLoginBtn.classList.add('hidden');
                adminLogoutBtn.classList.remove('hidden');
                adminModeStatus.classList.remove('hidden');
                showMessage("Admin-Modus", "Admin-Modus aktiviert.");
                renderAdminMainMenu();
            } else {
                showMessage("Login fehlgeschlagen", "Ungültiger Benutzername oder Passwort.");
            }
            adminUsernameInput.value = 'admin'; // Reset or keep default for convenience
            adminPasswordInput.value = 'admin123'; // Reset or keep default
        }

        function renderAdminMainMenu() {
            currentAdminView = 'main';
            rightPanel.innerHTML = `
                <div class="admin-main-menu col-span-4">
                    <button class="menu-button" data-view="categories">Kategorien verwalten</button>
                    <button class="menu-button" data-view="products">Produkte verwalten</button>
                    <button class="menu-button" data-view="sellers">Verkäufer verwalten</button>
                    <button class="menu-button yellow-func" data-view="back-to-pos">Zurück zur Kasse</button>
                </div>
            `;
            rightPanel.querySelectorAll('.menu-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const view = event.target.dataset.view;
                    if (view === 'categories') {
                        renderAdminCategories();
                    } else if (view === 'products') {
                        renderAdminProducts();
                    } else if (view === 'sellers') {
                        renderAdminSellers();
                    } else if (view === 'back-to-pos') {
                        isAdminMode = false; // Exit admin mode
                        adminLogoutBtn.classList.add('hidden');
                        adminModeStatus.classList.add('hidden');
                        adminLoginBtn.classList.remove('hidden');
                        if (currentCategory) {
                            renderProducts(currentCategory);
                        } else {
                            renderCategories();
                        }
                    }
                });
            });
        }

        // Admin: Categories Management
        function renderAdminCategories() {
            currentAdminView = 'categories';
            rightPanel.innerHTML = `
                <div class="admin-config-panel col-span-4 grid grid-cols-2 gap-4 overflow-y-auto">
                    <div class="admin-config-section">
                        <h4>Neue Kategorie hinzufügen</h4>
                        <input type="text" id="newCategoryName" placeholder="Kategoriename">
                        <input type="text" id="newCategoryColor" placeholder="Farbe (z.B. blue, red, #RRGGBB)">
                        <input type="number" id="newCategoryOrder" placeholder="Reihenfolge" value="0">
                        <button id="addCategoryBtn">Hinzufügen</button>
                    </div>
                    <div class="admin-config-section">
                        <h4>Kategorien bearbeiten/löschen</h4>
                        <div id="categoryList" class="admin-config-list">
                            </div>
                    </div>
                    <button class="product-button blue col-span-2" onclick="renderAdminMainMenu()">← Zurück zum Admin-Menü</button>
                </div>
            `;
            document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
            updateCategoryList();
        }

        async function updateCategoryList() {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';
            posData.categories.forEach(category => {
                const item = document.createElement('div');
                item.classList.add('admin-config-item');
                item.innerHTML = `
                    <span>${category.name} (${category.order || 0})</span>
                    <div>
                        <button class="edit" data-id="${category.id}" data-name="${category.name}" data-color="${category.color || ''}" data-order="${category.order || 0}">Bearbeiten</button>
                        <button class="delete" data-id="${category.id}">Löschen</button>
                    </div>
                `;
                categoryList.appendChild(item);
            });
            categoryList.querySelectorAll('.edit').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const currentName = e.target.dataset.name;
                    const currentColor = e.target.dataset.color;
                    const currentOrder = e.target.dataset.order;
                    const newName = prompt("Neuen Kategorienamen eingeben:", currentName);
                    if (newName !== null && newName.trim() !== "") {
                        const newColor = prompt("Neue Farbe eingeben (optional, z.B. blue, #RRGGBB):", currentColor);
                        const newOrder = prompt("Neue Reihenfolge eingeben (Zahl):", currentOrder);
                        updateCategory(id, newName, newColor, newOrder ? parseInt(newOrder) : 0);
                    }
                });
            });
            categoryList.querySelectorAll('.delete').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    if (confirm("Sicher, dass diese Kategorie gelöscht werden soll? Produkte in dieser Kategorie werden NICHT gelöscht, aber ihnen wird die Kategorie-ID entzogen.")) {
                        deleteCategory(id);
                    }
                });
            });
        }

        async function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const color = document.getElementById('newCategoryColor').value.trim();
            const order = parseInt(document.getElementById('newCategoryOrder').value) || 0;

            if (name === "") {
                showMessage("Fehler", "Kategoriename darf nicht leer sein.");
                return;
            }
            if (!db) {
                showMessage("Fehler", "Firebase DB nicht verfügbar.");
                return;
            }

            try {
                const categoryRef = doc(collection(db, "categories")); // Auto-generate ID
                await setDoc(categoryRef, { name, color, order });
                document.getElementById('newCategoryName').value = '';
                document.getElementById('newCategoryColor').value = '';
                document.getElementById('newCategoryOrder').value = '0';
                showMessage("Erfolg", "Kategorie hinzugefügt.");
            } catch (e) {
                console.error("Error adding category:", e);
                showMessage("Fehler", "Kategorie konnte nicht hinzugefügt werden: " + e.message);
            }
        }

        async function updateCategory(id, newName, newColor, newOrder) {
            if (!db) {
                showMessage("Fehler", "Firebase DB nicht verfügbar.");
                return;
            }
            try {
                await updateDoc(doc(db, "categories", id), { name: newName, color: newColor, order: newOrder });
                showMessage("Erfolg", "Kategorie aktualisiert.");
            } catch (e) {
                console.error("Error updating category:", e);
                showMessage("Fehler", "Kategorie konnte nicht aktualisiert werden: " + e.message);
            }
        }

        async function deleteCategory(id) {
            if (!db) {
                showMessage("Fehler", "Firebase DB nicht verfügbar.");
                return;
            }
            try {
                await deleteDoc(doc(db, "categories", id));
                // Optional: Update products that belonged to this category (set categoryId to null or default)
                const q = query(collection(db, "products"), where("categoryId", "==", id));
                const querySnapshot = await getDocs(q);
                const batch = db.batch();
                querySnapshot.forEach((docSnap) => {
                    batch.update(docSnap.ref, { categoryId: null }); // Or a default category ID
                });
                await batch.commit();

                showMessage("Erfolg", "Kategorie gelöscht.");
            } catch (e) {
                console.error("Error deleting category:", e);
                showMessage("Fehler", "Kategorie konnte nicht gelöscht werden: " + e.message);
            }
        }


        // Admin: Products Management
        function renderAdminProducts() {
            currentAdminView = 'products';
            const categoryOptions = posData.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');

            rightPanel.innerHTML = `
                <div class="admin-config-panel col-span-4 grid grid-cols-2 gap-4 overflow-y-auto">
                    <div class="admin-config-section">
                        <h4>Neues Produkt hinzufügen</h4>
                        <input type="text" id="newProductName" placeholder="Produktname">
                        <input type="number" id="newProductPrice" placeholder="Preis (z.B. 1.50)" step="0.01">
                        <select id="newProductCategory">
                            <option value="">Kategorie auswählen</option>
                            ${categoryOptions}
                        </select>
                        <input type="number" id="newProductOrder" placeholder="Reihenfolge" value="0">
                        <button id="addProductBtn">Hinzufügen</button>
                    </div>
                    <div class="admin-config-section">
                        <h4>Produkte bearbeiten/löschen</h4>
                        <select id="filterProductCategory">
                            <option value="">Alle Kategorien</option>
                            ${categoryOptions}
                        </select>
                        <div id="productList" class="admin-config-list">
                            </div>
                    </div>
                    <button class="product-button blue col-span-2" onclick="renderAdminMainMenu()">← Zurück zum Admin-Menü</button>
                </div>
            `;
            document.getElementById('addProductBtn').addEventListener('click', addProduct);
            document.getElementById('filterProductCategory').addEventListener('change', updateProductList);
            updateProductList();
        }

        async function updateProductList() {
            const productList = document.getElementById('productList');
            const filterCategoryId = document.getElementById('filterProductCategory').value;
            productList.innerHTML = '';

            let productsToDisplay = [];
            if (filterCategoryId) {
                productsToDisplay = posData.products[filterCategoryId] || [];
            } else {
                // Flatten all products if no category filter
                for (const categoryId in posData.products) {
                    productsToDisplay = productsToDisplay.concat(posData.products[categoryId]);
                }
                productsToDisplay.sort((a, b) => a.name.localeCompare(b.name)); // Sort all products by name
            }

            productsToDisplay.forEach(product => {
                const item = document.createElement('div');
                item.classList.add('admin-config-item');
                const categoryName = posData.categories.find(cat => cat.id === product.categoryId)?.name || 'Ohne Kategorie';
                item.innerHTML = `
                    <span>${product.name} (€${product.price.toFixed(2)}) - ${categoryName} (${product.order || 0})</span>
                    <div>
                        <button class="edit" data-id="${product.id}" data-name="${product.name}" data-price="${product.price}" data-category-id="${product.categoryId || ''}" data-order="${product.order || 0}">Bearbeiten</button>
                        <button class="delete" data-id="${product.id}">Löschen</button>
                    </div>
                `;
                productList.appendChild(item);
            });

            productList.querySelectorAll('.edit').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const currentName = e.target.dataset.name;
                    const currentPrice = parseFloat(e.target.dataset.price);
                    const currentCategoryId = e.target.dataset.categoryId;
                    const currentOrder = e.target.dataset.order;

                    const newName = prompt("Neuen Produktnamen eingeben:", currentName);
                    if (newName !== null && newName.trim() !== "") {
                        let newPrice = prompt("Neuen Preis eingeben:", currentPrice.toFixed(2));
                        newPrice = parseFloat(newPrice);
                        if (isNaN(newPrice) || newPrice < 0) {
                            showMessage("Fehler", "Ungültiger Preis.");
                            return;
                        }

                        const newCategoryId = await new Promise(resolve => {
                            const modal = document.createElement('div');
                            modal.classList.add('message-box-overlay');
                            modal.innerHTML = `
                                <div class="message-box">
                                    <h3>Kategorie für Produkt wählen</h3>
                                    <select id="selectCategoryForProduct">
                                        <option value="">Keine Kategorie</option>
                                        ${posData.categories.map(cat => `<option value="${cat.id}" ${cat.id === currentCategoryId ? 'selected' : ''}>${cat.name}</option>`).join('')}
                                    </select>
                                    <button id="confirmCategoryBtn">Bestätigen</button>
                                    <button id="cancelCategoryBtn">Abbrechen</button>
                                </div>
                            `;
                            document.body.appendChild(modal);

                            document.getElementById('confirmCategoryBtn').onclick = () => {
                                const selectedCat = document.getElementById('selectCategoryForProduct').value;
                                document.body.removeChild(modal);
                                resolve(selectedCat);
                            };
                            document.getElementById('cancelCategoryBtn').onclick = () => {
                                document.body.removeChild(modal);
                                resolve(currentCategoryId); // Keep current category if cancelled
                            };
                        });
                        
                        const newOrder = prompt("Neue Reihenfolge eingeben (Zahl):", currentOrder);

                        updateProduct(id, newName, newPrice, newCategoryId, newOrder ? parseInt(newOrder) : 0);
                    }
                });
            });
            productList.querySelectorAll('.delete').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    if (confirm("Sicher, dass dieses Produkt gelöscht werden soll?")) {
                        deleteProduct(id);
                    }
                });
            });
        }

        async function addProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);
            const categoryId = document.getElementById('newProductCategory').value;
            const order = parseInt(document.getElementById('newProductOrder').value) || 0;

            if (name === "" || isNaN(price) || price < 0) {
                showMessage("Fehler", "Produktname und Preis sind erforderlich (Preis muss >= 0 sein).");
                return;
            }
            if (!db) {
                showMessage("Fehler", "Firebase DB nicht verfügbar.");
                return;
            }

            try {
                const productRef = doc(collection(db, "products")); // Auto-generate ID
                await setDoc(productRef, { name, price, categoryId, order });
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductPrice').value = '';
                document.getElementById('newProductCategory').value = '';
                document.getElementById('newProductOrder').value = '0';
                showMessage("Erfolg", "Produkt hinzugefügt.");
            } catch (e) {
                console.error("Error adding product:", e);
                showMessage("Fehler", "Produkt konnte nicht hinzugefügt werden: " + e.message);
            }
        }

        async function updateProduct(id, newName, newPrice, newCategoryId, newOrder) {
            if (!db) {
                showMessage("Fehler", "Firebase DB nicht verfügbar.");
                return;
            }
            try {
                await updateDoc(doc(db, "products", id), { name: newName, price: newPrice, categoryId: newCategoryId, order: newOrder });
                showMessage("Erfolg", "Produkt aktualisiert.");
            } catch (e) {
                console.error("Error updating product:", e);
                showMessage("Fehler", "Produkt konnte nicht aktualisiert werden: " + e.message);
            }
        }

        async function deleteProduct(id) {
            if (!db) {
                showMessage("Fehler", "Firebase DB nicht verfügbar.");
                return;
            }
            try {
                await deleteDoc(doc(db, "products", id));
                showMessage("Erfolg", "Produkt gelöscht.");
            } catch (e) {
                console.error("Error deleting product:", e);
                showMessage("Fehler", "Produkt konnte nicht gelöscht werden: " + e.message);
            }
        }

        // Admin: Sellers Management
        function renderAdminSellers() {
            currentAdminView = 'sellers';
            rightPanel.innerHTML = `
                <div class="admin-config-panel col-span-4 grid grid-cols-2 gap-4 overflow-y-auto">
                    <div class="admin-config-section">
                        <h4>Neuen Verkäufer hinzufügen</h4>
                        <input type="text" id="newSellerName" placeholder="Verkäufername">
                        <input type="password" id="newSellerPIN" placeholder="PIN (4-stellig)">
                        <button id="addSellerBtn">Hinzufügen</button>
                    </div>
                    <div class="admin-config-section">
                        <h4>Verkäufer bearbeiten/löschen</h4>
                        <div id="sellerList" class="admin-config-list">
                            </div>
                    </div>
                    <button class="product-button blue col-span-2" onclick="renderAdminMainMenu()">← Zurück zum Admin-Menü</button>
                </div>
            `;
            document.getElementById('addSellerBtn').addEventListener('click', addSeller);
            updateSellerList();
        }

        async function updateSellerList() {
            const sellerList = document.getElementById('sellerList');
            sellerList.innerHTML = '';
            posData.sellers.forEach(seller => {
                const item = document.createElement('div');
                item.classList.add('admin-config-item');
                item.innerHTML = `
                    <span>${seller.name}</span>
                    <div>
                        <button class="edit" data-id="${seller.id}" data-name="${seller.name}">Bearbeiten</button>
                        <button class="delete" data-id="${seller.id}">Löschen</button>
                    </div>
                `;
                sellerList.appendChild(item);
            });
            sellerList.querySelectorAll('.edit').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const currentName = e.target.dataset.name;
                    const newName = prompt("Neuen Verkäufernamen eingeben:", currentName);
                    if (newName !== null && newName.trim() !== "") {
                        let newPIN = prompt("Neue PIN eingeben (leer lassen für keine Änderung):");
                        if (newPIN !== null && newPIN.trim() !== "" && !/^\d{4}$/.test(newPIN)) {
                            showMessage("Fehler", "PIN muss 4 Ziffern lang sein oder leer gelassen werden.");
                            return;
                        }
                        updateSeller(id, newName, newPIN.trim() === "" ? undefined : newPIN); // Pass undefined if no change
                    }
                });
            });
            sellerList.querySelectorAll('.delete').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    if (confirm("Sicher, dass dieser Verkäufer gelöscht werden soll?")) {
                        deleteSeller(id);
                    }
                });
            });
        }

        async function addSeller() {
            const name = document.getElementById('newSellerName').value.trim();
            const pin = document.getElementById('newSellerPIN').value.trim();

            if (name === "") {
                showMessage("Fehler", "Verkäufername darf nicht leer sein.");
                return;
            }
            if (!/^\d{4}$/.test(pin)) {
                showMessage("Fehler", "PIN muss 4 Ziffern lang sein.");
                return;
            }
            if (!db) {
                showMessage("Fehler", "Firebase DB nicht verfügbar.");
                return;
            }

            try {
                const sellerRef = doc(collection(db, "sellers")); // Auto-generate ID
                await setDoc(sellerRef, { name, pin });
                document.getElementById('newSellerName').value = '';
                document.getElementById('newSellerPIN').value = '';
                showMessage("Erfolg", "Verkäufer hinzugefügt.");
            } catch (e) {
                console.error("Error adding seller:", e);
                showMessage("Fehler", "Verkäufer konnte nicht hinzugefügt werden: " + e.message);
            }
        }

        async function updateSeller(id, newName, newPIN) {
            if (!db) {
                showMessage("Fehler", "Firebase DB nicht verfügbar.");
                return;
            }
            const updateData = { name: newName };
            if (newPIN !== undefined) { // Only update PIN if it was provided
                updateData.pin = newPIN;
            }
            try {
                await updateDoc(doc(db, "sellers", id), updateData);
                showMessage("Erfolg", "Verkäufer aktualisiert.");
            } catch (e) {
                console.error("Error updating seller:", e);
                showMessage("Fehler", "Verkäufer konnte nicht aktualisiert werden: " + e.message);
            }
        }

        async function deleteSeller(id) {
            if (!db) {
                showMessage("Fehler", "Firebase DB nicht verfügbar.");
                return;
            }
            try {
                await deleteDoc(doc(db, "sellers", id));
                showMessage("Erfolg", "Verkäufer gelöscht.");
            } catch (e) {
                console.error("Error deleting seller:", e);
                showMessage("Fehler", "Verkäufer konnte nicht gelöscht werden: " + e.message);
            }
        }


        // --- Event Listeners ---

        // Numeric and Action Buttons
        document.querySelectorAll('.num-button').forEach(button => {
            button.addEventListener('click', (e) => {
                handleNumInput(e.target.dataset.input);
            });
        });

        document.querySelectorAll('.action-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const actionType = e.target.dataset.action;
                if (actionType === 'function') {
                    handleFunction(e.target.dataset.function);
                } else if (e.target.dataset.input === 'X') {
                    handleFunction('X');
                }
            });
        });

        // Clear Input Button
        clearInputButton.addEventListener('click', () => {
            currentInput = '0.00';
            multiplier = 1; // Also reset multiplier
            updateInputDisplay();
            changeHeader.textContent = `€0.00`; // Reset change in header
        });

        // New Order Button
        newOrderButton.addEventListener('click', () => {
            newOrderArea.classList.add('hidden');
            keypadArea.classList.remove('hidden');
            if (currentCategory) {
                renderProducts(currentCategory); // Go back to the last selected category
            } else {
                renderCategories(); // Or to the main categories view
            }
            updateLiveDisplay(); // Clear live display content when starting new order
        });

        // Admin Login/Logout Buttons
        adminLoginBtn.addEventListener('click', toggleAdminMode);
        adminLogoutBtn.addEventListener('click', toggleAdminMode);
        loginBtn.addEventListener('click', handleAdminLogin);
        cancelLoginBtn.addEventListener('click', () => {
            adminLoginOverlay.classList.add('hidden');
            adminUsernameInput.value = 'admin'; // Reset to default
            adminPasswordInput.value = 'admin123'; // Reset to default
        });

        // Kasse Selection Buttons
        kasseButtons.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                selectedKasseId = event.target.dataset.kasseId;
                cashierBadge.textContent = `Kasse: ${selectedKasseId}`;
                kasseSelectOverlay.classList.add('hidden');
                console.log("Kasse selected:", selectedKasseId);
                if (!firestoreListenersSetup) {
                    setupFirestoreListeners();
                    firestoreListenersSetup = true;
                }
                updateLiveDisplay(); // Initialize live display for selected Kasse
            }
        });

        // Live Display Link Button
        liveDisplayLinkBtn.addEventListener('click', () => {
            if (!selectedKasseId) {
                showMessage("Kasse auswählen", "Bitte wählen Sie zuerst eine Kasse aus, um den Live-Display-Link zu generieren.");
                return;
            }
            // Construct the URL for the live display (assuming it's on a different page, e.g., live-display.html)
            const liveDisplayUrl = `${window.location.origin}/live-display.html?kasseId=${selectedKasseId}&userId=${userId}`;
            liveDisplayUrlInput.value = liveDisplayUrl;
            liveDisplayOverlay.classList.remove('hidden');
        });

        copyLiveDisplayUrlBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(liveDisplayUrlInput.value);
                showMessage("Kopiert!", "Der Link wurde in die Zwischenablage kopiert.");
            } catch (err) {
                console.error('Fehler beim Kopieren des Links: ', err);
                showMessage("Fehler", "Konnte Link nicht kopieren. Bitte manuell kopieren.");
            }
        });

        closeLiveDisplayBtn.addEventListener('click', () => {
            liveDisplayOverlay.classList.add('hidden');
        });


        // --- Initial Setup ---
        function initializePOS() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000); // Update time every second
            initializeFirebase(); // Start Firebase initialization and auth
        }

        // Update current time and date in header
        function updateCurrentTime() {
            const now = new Date();
            currentTimeElem.textContent = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            currentDateElem.textContent = now.toLocaleDateString('de-DE');
        }

        // Call initialization function when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializePOS);
    </script>
</body>
</html>
