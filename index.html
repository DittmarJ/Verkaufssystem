<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kassensystem</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .pos-container {
            width: 100%;
            max-width: 1024px;
            height: 768px; /* Fixed height for the entire POS system screen */
            background-color: #1a1a1a;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 5px solid #000;
        }
        .header-bar {
            background-color: #383838;
            color: #ccc;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            border-top-left-radius: 1.2rem;
            border-top-right-radius: 1.2rem;
            border-bottom: 1px solid #4a4a4a;
            height: 60px; /* Fixed height for the header */
        }
        .header-bar .user-badge {
            background-color: #007bff;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .header-bar .status-item {
            margin-left: 1.5rem;
            font-weight: 600;
        }
        .header-bar .change-display {
            color: #66ff66;
            font-weight: bold;
            font-size: 1.1rem;
            margin-left: 0.5rem;
        }
        .main-content {
            flex-grow: 1; /* Takes remaining height after header and footer */
            display: flex;
            padding: 1rem;
            gap: 1rem;
        }
        .left-panel {
            background-color: #2e2e2e;
            width: 350px; /* Fixed width for the left panel */
            flex-shrink: 0; /* Prevents it from shrinking */
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            color: #eee;
            border: 1px solid #4a4a4a;
            height: 100%; /* Takes 100% of main-content's height */
        }
        .order-list-header {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0.25rem;
            font-weight: bold;
            border-bottom: 1px solid #5a5a5a;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #bbb;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        .order-list-container {
            flex-grow: 1; /* Takes all available vertical space in left-panel */
            overflow-y: auto; /* Enable scrolling for overflow */
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0.25rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.1s ease;
        }
        .order-item:hover {
            background-color: #3b3b3b;
        }
        .order-item .qty { width: 10%; text-align: left; }
        .order-item .name { width: 60%; text-align: left; }
        .order-item .price { width: 30%; text-align: right; }
        .summary-section {
            padding-top: 1rem;
            font-size: 1.1rem;
            border-top: 1px solid #5a5a5a;
            flex-shrink: 0; /* Prevent summary from shrinking */
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        .summary-item.subtotal {
            font-size: 1.1rem;
            color: #ccc;
        }
        .summary-item.total {
            font-weight: bold;
            font-size: 1.5rem;
            color: #ffcc00;
        }
        .summary-item.cash {
            font-size: 1.1rem;
            color: #ccc;
        }
        .summary-item.change {
            font-weight: bold;
            font-size: 1.5rem;
            color: #66ff66;
        }
        .right-panel {
            flex: 1; /* Takes all remaining width */
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.7rem;
            align-content: start;
            height: 100%; /* Takes 100% of main-content's height */
        }
        .product-button {
            background-color: #555;
            color: white;
            padding: 1rem 0.5rem;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            height: 75px;
        }
        .product-button:hover {
            background-color: #666;
        }
        /* Color classes for dynamic categories */
        .product-button.yellow { background-color: #ffc107; color: #333; }
        .product-button.orange { background-color: #fd7e14; }
        .product-button.purple { background-color: #6f42c1; }
        .product-button.green { background-color: #28a745; }
        .product-button.blue { background-color: #007bff; }
        .product-button.red { background-color: #dc3545; }
        .product-button.light-blue { background-color: #17a2b8; }
        .product-button.pink { background-color: #e83e8c; }
        .product-button.gray { background-color: #6c757d; }


        .bottom-panel-container {
            background-color: #2e2e2e;
            padding: 1rem;
            border-bottom-left-radius: 1.2rem;
            border-bottom-right-radius: 1.2rem;
            color: white;
            border-top: 1px solid #4a4a4a;
            height: 300px; /* Sufficient height for dynamic content */
        }

        .input-display-area {
            display: flex;
            align-items: center;
            background-color: #1a1a1a;
            border-radius: 0.5rem;
            margin-bottom: 0.7rem;
            border: 1px solid #4a4a4a;
            min-height: 2.5rem; /* ~40px */
            padding-right: 1rem; /* Padding for the display text */
        }

        .input-display-line {
            flex-grow: 1; /* Takes up remaining space */
            color: #66ff66;
            font-size: 2rem;
            font-weight: bold;
            text-align: right;
            padding: 0.5rem 0; /* Padding handled by parent */
        }

        .clear-input-button {
            background-color: #dc3545; /* Red color for Clear */
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-left: 0.5rem; /* Space between button and display */
            height: 40px; /* Match height of input display roughly */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .clear-input-button:hover {
            background-color: #c82333;
        }

        .bottom-panel {
            display: grid;
            grid-template-columns: repeat(3, 0.8fr) 1fr 1.2fr;
            gap: 0.7rem;
        }
        
        .num-button, .action-button {
            height: 60px; /* Smaller consistent height for all buttons */
            border-radius: 0.75rem; /* Ensure rounded corners for consistency */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            padding: 0.5rem; /* Reduced padding for smaller buttons */
        }

        .num-button {
            background-color: #505050;
            font-size: 1.2rem; /* Smaller font size for numbers */
        }
        .num-button:hover {
            background-color: #606060;
        }
        .num-button.decimal {
            font-size: 1.8rem; /* Slightly larger font for decimal comma */
        }

        .action-button {
            background-color: #444;
            font-size: 1.2rem; /* Standard font size for action buttons (now smaller overall) */
        }
        .action-button:hover {
            background-color: #555;
        }

        .action-button[data-input="X"],
        .action-button[data-action="function"][data-function="zws"],
        .action-button[data-action="function"][data-function="bar"] {
            font-size: 1.6rem; /* Larger font size to make them stand out */
        }
        
        .action-button.yellow-func { background-color: #ffc107; color: #333; }
        .action-button.purple-func { background-color: #6f42c1; }
        .action-button.bar-func { background-color: #66ff66; color: #333; }

        /* New Order Button Styling */
        .new-order-button {
            background-color: #28a745; /* Green color */
            color: white;
            font-weight: bold;
            font-size: 2rem;
            padding: 1.5rem;
            border-radius: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
            height: 100%; /* Take full height of its container */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .new-order-button:hover {
            background-color: #218838;
        }

        /* Message Box Styling */
        .message-box-overlay, .admin-login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box, .admin-login-box {
            background-color: #333;
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 2px solid #555;
        }
        .message-box h3, .admin-login-box h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #ffcc00;
        }
        .message-box p, .admin-login-box p {
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        .message-box button, .admin-login-box button {
            background-color: #007bff;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .message-box button:hover, .admin-login-box button:hover {
            background-color: #0056b3;
        }
        .admin-login-box input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            font-size: 1rem;
        }
        .admin-login-box button {
            margin: 0 10px;
        }

        /* Admin Configuration Panel Specific Styles */
        .admin-config-panel {
            grid-template-columns: repeat(2, 1fr);
            overflow-y: auto;
        }
        .admin-config-section {
            background-color: #3b3b3b;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        .admin-config-section h4 {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #ffcc00;
        }
        .admin-config-section input, .admin-config-section select {
            width: calc(100% - 20px);
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
        }
        .admin-config-section button {
            background-color: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 5px;
            margin-right: 5px;
        }
        .admin-config-section button.delete {
            background-color: #dc3545;
        }
        .admin-config-section button:hover {
            background-color: #218838;
        }
        .admin-config-section button.delete:hover {
            background-color: #c82333;
        }
        .admin-config-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 5px;
            margin-top: 10px;
        }
        .admin-config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #4a4a4a;
        }
        .admin-config-item:last-child {
            border-bottom: none;
        }
        .admin-config-item button {
            padding: 3px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        /* Admin Main Menu specific styles */
        .admin-main-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            height: 100%; /* Take full height of right-panel */
        }
        .admin-main-menu .menu-button {
            width: 80%;
            max-width: 300px;
            height: 80px;
            font-size: 1.5rem;
            background-color: #007bff;
            color: white;
            border-radius: 1rem;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .admin-main-menu .menu-button:hover {
            background-color: #0056b3;
        }


        /* Wertbon Print Style */
        @media print {
            body * {
                visibility: hidden;
            }
            .wertbon-print-area, .wertbon-print-area * {
                visibility: visible;
            }
            .wertbon-print-area {
                position: relative; /* Changed to relative for stacking */
                left: 0;
                top: 0;
                width: 80mm; /* Common receipt printer width */
                padding: 10mm;
                font-family: 'monospace';
                font-size: 12px;
                line-height: 1.4;
                color: #000;
                page-break-after: always; /* Ensure each bon is on a new page */
            }
            .wertbon-print-area:last-child {
                page-break-after: auto; /* No page break after the last one */
            }
            .wertbon-print-area h2, .wertbon-print-area h3 {
                text-align: center;
                margin-bottom: 5px;
            }
            .wertbon-print-area table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            .wertbon-print-area th, .wertbon-print-area td {
                padding: 2px 0;
                border-bottom: 1px dashed #ccc;
                text-align: left;
            }
            .wertbon-print-area td:nth-child(2) {
                text-align: right;
            }
            .wertbon-print-area .total-line {
                font-weight: bold;
                border-top: 2px solid #000;
            }
            .wertbon-print-area .summary-line {
                display: flex;
                justify-content: space-between;
                padding: 2px 0;
            }
            .wertbon-print-area .thank-you {
                text-align: center;
                margin-top: 15px;
                font-size: 14px;
                font-weight: bold;
            }
        }
    </style>
</head>
<body>
    <div class="pos-container">
        <!-- Header Bar -->
        <div class="header-bar">
            <div class="flex items-center gap-2">
                <span class="user-badge">Frau Becker</span>
                <button id="adminLoginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-full text-sm ml-4">Admin Login</button>
                <button id="adminLogoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full text-sm ml-4 hidden">Admin Logout</button>
                <span id="adminModeStatus" class="text-green-400 text-sm ml-2 hidden">Admin-Modus AN</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="status-item">REG</span>
                <span class="status-item">RÜCKGELD</span>
                <span id="changeHeader" class="change-display">€0.00</span>
                <span id="currentTime" class="status-item"></span>
                <span id="currentDate" class="status-item"></span>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Left Panel (Order List & Summary) -->
            <div class="left-panel">
                <div class="order-list-header">
                    <span class="qty">Menge</span>
                    <span class="name">Artikel</span>
                    <span class="price">Preis</span>
                </div>
                <div class="order-list-container" id="orderList">
                    <!-- Order items will be dynamically added here -->
                </div>
                <div class="summary-section">
                    <div class="summary-item subtotal">
                        <span>ZWISCHENSUMME</span>
                        <span id="subtotalAmount">€0.00</span>
                    </div>
                    <div class="summary-item total">
                        <span>TOTAL</span>
                        <span id="totalAmount">€0.00</span>
                    </div>
                    <div class="summary-item cash">
                        <span>BAR</span>
                        <span id="cashAmount">€0.00</span>
                    </div>
                    <div class="summary-item change">
                        <span>RÜCKGELD</span>
                        <span id="changeAmount">€0.00</span>
                    </div>
                </div>
            </div>

            <!-- Right Panel (Categories/Products/Admin Config) -->
            <div class="right-panel" id="rightPanel">
                <!-- Content will be rendered dynamically here -->
                <div id="loadingMessage" class="col-span-4 text-center text-gray-400 text-lg hidden">Lade Daten...</div>
            </div>
        </div>

        <!-- Bottom Panel Container (includes input display and buttons) -->
        <div class="bottom-panel-container">
            <!-- Input Display Area with Clear Button -->
            <div class="input-display-area">
                <div id="inputDisplay" class="input-display-line"></div>
                <button id="clearInputButton" class="clear-input-button">C</button>
            </div>
            
            <!-- Keypad Area - initially visible -->
            <div id="keypadArea" class="bottom-panel">
                <!-- Row 1 -->
                <button class="num-button" data-input="7">7</button>
                <button class="num-button" data-input="8">8</button>
                <button class="num-button" data-input="9">9</button>
                <button class="num-button" data-input="0">0</button>
                <button class="action-button yellow-func" data-input="X">X</button>

                <!-- Row 2 -->
                <button class="num-button" data-input="4">4</button>
                <button class="num-button" data-input="5">5</button>
                <button class="num-button" data-input="6">6</button>
                <button class="num-button" data-input="00">00</button>
                <button class="action-button purple-func" data-action="function" data-function="zws">ZWS</button>

                <!-- Row 3 -->
                <button class="num-button" data-input="1">1</button>
                <button class="num-button" data-input="2">2</button>
                <button class="num-button" data-input="3">3</button>
                <button class="num-button decimal" data-input=".">,</button>
                <button class="action-button bar-func" data-action="function" data-function="bar">BAR</button>
            </div>

            <!-- New Order Area - initially hidden -->
            <div id="newOrderArea" class="hidden" style="height: calc(100% - 2.5rem - 0.7rem);">
                <button id="newOrderButton" class="new-order-button">NEUE BESTELLUNG</button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box (Kept for other messages like login success/failure, etc.) -->
    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <h3 id="messageBoxTitle">Nachricht</h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxClose">OK</button>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginOverlay" class="admin-login-overlay hidden">
        <div class="admin-login-box">
            <h3>Admin Login</h3>
            <input type="text" id="adminUsername" placeholder="Benutzername" value="admin">
            <input type="password" id="adminPassword" placeholder="Passwort" value="admin123">
            <button id="loginBtn">Login</button>
            <button id="cancelLoginBtn">Abbrechen</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase app and services
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous until authenticated

        // Global variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // DOM Elements
        const orderList = document.getElementById('orderList');
        const subtotalAmount = document.getElementById('subtotalAmount');
        const totalAmount = document.getElementById('totalAmount');
        const cashAmount = document.getElementById('cashAmount');
        const changeAmount = document.getElementById('changeAmount');
        const changeHeader = document.getElementById('changeHeader');
        const currentDateElem = document.getElementById('currentDate');
        const currentTimeElem = document.getElementById('currentTime');

        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxClose = document.getElementById('messageBoxClose');

        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const adminModeStatus = document.getElementById('adminModeStatus');
        const adminLoginOverlay = document.getElementById('adminLoginOverlay');
        const adminUsernameInput = document.getElementById('adminUsername');
        const adminPasswordInput = document.getElementById('adminPassword');
        const loginBtn = document.getElementById('loginBtn');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn'); 

        const rightPanel = document.getElementById('rightPanel');
        const inputDisplay = document.getElementById('inputDisplay'); // Input display element
        const clearInputButton = document.getElementById('clearInputButton'); // New C button
        const loadingMessage = document.getElementById('loadingMessage'); // Loading message

        const keypadArea = document.getElementById('keypadArea'); // Numeric keypad and function buttons area
        const newOrderArea = document.getElementById('newOrderArea'); // "Neue Bestellung" button area
        const newOrderButton = document.getElementById('newOrderButton'); // The "Neue Bestellung" button

        // State variables
        let currentOrder = [];
        let currentInput = '0.00'; // Initialize with "0.00"
        let multiplier = 1;
        let cashGiven = 0;
        let isAdminMode = false;
        let currentCategory = null; // Stores the currently selected category for product display
        let currentAdminView = 'main'; // Tracks the current admin view: 'main', 'categories', 'products', 'sellers'

        // POS Data (now dynamically loaded from Firebase)
        let posData = {
            "categories": [],
            "products": {}, // Products will be grouped by category ID in this object
            "sellers": [] // New: Array to store seller data
        };

        // State to track if Firestore listeners have been set up
        let firestoreListenersSetup = false;

        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Listen for authentication state changes
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            // User is signed in.
                            userId = user.uid;
                            console.log("Firebase initialized and user authenticated:", userId);
                            if (!firestoreListenersSetup) {
                                setupFirestoreListeners(); // Start listening to data changes once user is known
                                firestoreListenersSetup = true;
                            }
                        } else {
                            // No user is signed in, attempt to sign in (only if listeners haven't been tried to be set up)
                            if (!firestoreListenersSetup) {
                                try {
                                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== '') {
                                        console.log("Attempting signInWithCustomToken...");
                                        await signInWithCustomToken(auth, __initial_auth_token);
                                    } else {
                                        console.log("No custom token, attempting signInAnonymously...");
                                        await signInAnonymously(auth);
                                    }
                                } catch (signInError) {
                                    console.warn("Custom token sign-in failed. Attempting anonymous sign-in as fallback:", signInError);
                                    try {
                                        await signInAnonymously(auth); // Try anonymous sign-in if custom fails
                                    } catch (anonSignInError) {
                                        console.error("Anonymous sign-in also failed:", anonSignInError);
                                        userId = 'anonymous_fallback'; // Completely fail and go to non-persistent mode
                                        console.warn("Authentication failed, proceeding without persistent data storage for this session.");
                                        renderCategories();
                                        renderOrder();
                                        inputDisplay.textContent = currentInput;
                                    } finally {
                                        firestoreListenersSetup = true; // Mark as setup to avoid repeated attempts
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.warn("Firebase configuration not provided. Data will not be persisted.");
                    renderCategories();
                    renderOrder();
                    inputDisplay.textContent = currentInput;
                }
            } catch (error) {
                console.error("Fatal error during Firebase app initialization:", error);
                showMessageBox('Fehler', 'Schwerwiegender Fehler beim Initialisieren von Firebase. Die App wird ohne Datenspeicherung gestartet.');
                renderCategories();
                renderOrder();
                inputDisplay.textContent = currentInput;
            }
        }

        // --- Firestore Data Listeners ---
        function setupFirestoreListeners() {
            if (!db || !userId || userId === 'anonymous_fallback') { // Also check for fallback ID
                console.warn("Firestore or User ID not available for listeners or in fallback mode.");
                return;
            }

            loadingMessage.classList.remove('hidden'); // Show loading message
            rightPanel.innerHTML = ''; // Clear right panel while loading

            // Listener for Categories
            const categoriesRef = collection(db, `artifacts/${appId}/users/${userId}/categories`);
            onSnapshot(categoriesRef, (snapshot) => {
                const fetchedCategories = [];
                snapshot.forEach(doc => {
                    fetchedCategories.push({ id: doc.id, ...doc.data() });
                });
                posData.categories = fetchedCategories;
                if (!isAdminMode) {
                    renderCategories();
                } else {
                    if (currentAdminView === 'categories') {
                        renderAdminCategoryManagement(); // Re-render if in category admin view
                    } else if (currentAdminView === 'products') {
                        renderAdminProductManagement(); // Re-render to update category dropdown
                    }
                }
                loadingMessage.classList.add('hidden');
            }, (error) => {
                console.error("Error fetching categories:", error);
                showMessageBox('Fehler', 'Kategorien konnten nicht geladen werden.');
                loadingMessage.classList.add('hidden');
            });

            // Listener for Products
            const productsRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
            onSnapshot(productsRef, (snapshot) => {
                const fetchedProducts = {};
                snapshot.forEach(doc => {
                    const productData = doc.data();
                    if (productData.categoryId) {
                        if (!fetchedProducts[productData.categoryId]) {
                            fetchedProducts[productData.categoryId] = [];
                        }
                        fetchedProducts[productData.categoryId].push({ id: doc.id, name: productData.name, price: productData.price });
                    }
                });
                posData.products = fetchedProducts;
                if (!isAdminMode) {
                    if (currentCategory) {
                         renderProducts(currentCategory);
                    } else {
                        renderCategories();
                    }
                } else {
                    if (currentAdminView === 'products') {
                        renderAdminProductManagement(); // Re-render if in product admin view
                    }
                }
                loadingMessage.classList.add('hidden');
            }, (error) => {
                console.error("Error fetching products:", error);
                showMessageBox('Fehler', 'Produkte konnten nicht geladen werden.');
                loadingMessage.classList.add('hidden');
            });

            // Listener for Sellers
            const sellersRef = collection(db, `artifacts/${appId}/users/${userId}/sellers`);
            onSnapshot(sellersRef, (snapshot) => {
                const fetchedSellers = [];
                snapshot.forEach(doc => {
                    fetchedSellers.push({ id: doc.id, ...doc.data() });
                });
                posData.sellers = fetchedSellers;
                if (isAdminMode && currentAdminView === 'sellers') {
                    renderAdminSellerManagement(); // Re-render if in seller admin view
                }
                loadingMessage.classList.add('hidden');
            }, (error) => {
                console.error("Error fetching sellers:", error);
                showMessageBox('Fehler', 'Verkäufer konnten nicht geladen werden.');
                loadingMessage.classList.add('hidden');
            });
        }

        // --- Firebase Data Operations (CRUD) ---

        /**
         * Adds or updates a category in Firestore.
         * @param {object} category - { id, name, color, standName }
         */
        async function saveCategoryToFirestore(category) {
            if (!db || !userId || userId === 'anonymous_fallback') {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Daten können nicht gespeichert werden.');
                return;
            }
            try {
                const categoryDocRef = doc(db, `artifacts/${appId}/users/${userId}/categories`, category.id);
                await setDoc(categoryDocRef, { name: category.name, color: category.color, standName: category.standName || '' });
            } catch (e) {
                console.error("Error saving category: ", e);
                showMessageBox('Fehler', `Fehler beim Speichern der Kategorie: ${e.message}`);
            }
        }

        /**
         * Deletes a category from Firestore.
         * @param {string} categoryId - The ID of the category to delete.
         */
        async function deleteCategoryFromFirestore(categoryId) {
            if (!db || !userId || userId === 'anonymous_fallback') {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Daten können nicht gelöscht werden.');
                return;
            }
            try {
                const categoryDocRef = doc(db, `artifacts/${appId}/users/${userId}/categories`, categoryId);
                await deleteDoc(categoryDocRef);

                // Also delete associated products
                const productsToDeleteQuery = query(collection(db, `artifacts/${appId}/users/${userId}/products`), where("categoryId", "==", categoryId));
                const productSnapshot = await getDocs(productsToDeleteQuery);
                const deletePromises = [];
                productSnapshot.forEach((productDoc) => {
                    deletePromises.push(deleteDoc(productDoc.ref));
                });
                await Promise.all(deletePromises);
            } catch (e) {
                console.error("Error deleting category: ", e);
                showMessageBox('Fehler', `Fehler beim Löschen der Kategorie: ${e.message}`);
            }
        }

        /**
         * Adds or updates a product in Firestore.
         * @param {object} product - { categoryId, name, price }
         */
        async function saveProductToFirestore(product) {
            if (!db || !userId || userId === 'anonymous_fallback') {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Daten können nicht gespeichert werden.');
                return;
            }
            try {
                // Auto-generate ID for new products
                const productDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/products`));
                await setDoc(productDocRef, product);
            } catch (e) {
                console.error("Error saving product: ", e);
                showMessageBox('Fehler', `Fehler beim Speichern des Produkts: ${e.message}`);
            }
        }

        /**
         * Deletes a product from Firestore.
         * @param {string} productId - The ID of the product document to delete.
         */
        async function deleteProductFromFirestore(productId) {
            if (!db || !userId || userId === 'anonymous_fallback') {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Daten können nicht gelöscht werden.');
                return;
            }
            try {
                const productDocRef = doc(db, `artifacts/${appId}/users/${userId}/products`, productId);
                await deleteDoc(productDocRef);
            } catch (e) {
                console.error("Error deleting product: ", e);
                showMessageBox('Fehler', `Fehler beim Löschen des Produkts: ${e.message}`);
            }
        }

        /**
         * Adds or updates a seller in Firestore.
         * @param {object} seller - { id, name }
         */
        async function saveSellerToFirestore(seller) {
            if (!db || !userId || userId === 'anonymous_fallback') {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Daten können nicht gespeichert werden.');
                return;
            }
            try {
                const sellerDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/sellers`));
                await setDoc(sellerDocRef, { name: seller.name });
            } catch (e) {
                console.error("Error saving seller: ", e);
                showMessageBox('Fehler', `Fehler beim Speichern des Verkäufers: ${e.message}`);
            }
        }

        /**
         * Deletes a seller from Firestore.
         * @param {string} sellerId - The ID of the seller document to delete.
         */
        async function deleteSellerFromFirestore(sellerId) {
            if (!db || !userId || userId === 'anonymous_fallback') {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Daten können nicht gelöscht werden.');
                return;
            }
            try {
                const sellerDocRef = doc(db, `artifacts/${appId}/users/${userId}/sellers`, sellerId);
                await deleteDoc(sellerDocRef);
            } catch (e) {
                console.error("Error deleting seller: ", e);
                showMessageBox('Fehler', `Fehler beim Löschen des Verkäufers: ${e.message}`);
            }
        }

        // --- UI Functions ---

        /**
         * Displays a custom message box.
         * @param {string} title - The title of the message box.
         * @param {string} message - The content of the message.
         */
        function showMessageBox(title, message) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBoxOverlay.classList.remove('hidden');
        }

        // Event Listener for the message box close button
        messageBoxClose.addEventListener('click', () => {
            messageBoxOverlay.classList.add('hidden');
        });

        // Function to update date and time
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            currentDateElem.textContent = now.toLocaleDateString('de-DE', dateOptions);
            currentTimeElem.textContent = now.toLocaleTimeString('de-DE', timeOptions);
        }

        // Initialize date and time and update every second
        updateDateTime();
        setInterval(updateDateTime, 1000);

        /**
         * Adds an item to the current order or updates its quantity.
         * @param {string} name - The name of the item.
         * @param {number} price - The price of the item.
         */
        function addItemToOrder(name, price) {
            const existingItemIndex = currentOrder.findIndex(item => item.name === name);

            if (existingItemIndex > -1) {
                currentOrder[existingItemIndex].quantity += multiplier;
            } else {
                currentOrder.push({
                    name: name,
                    price: parseFloat(price),
                    quantity: multiplier
                });
            }
            multiplier = 1; // Reset multiplier after adding item
            currentInput = '0.00'; // Reset input display to 0.00 after adding item
            inputDisplay.textContent = currentInput;
            renderOrder();
        }

        /**
         * Renders the current order list and updates summary totals.
         */
        function renderOrder() {
            orderList.innerHTML = '';
            let subtotal = 0;

            currentOrder.forEach((item, index) => {
                const itemTotal = item.quantity * item.price;
                subtotal += itemTotal;

                const orderItemDiv = document.createElement('div');
                orderItemDiv.classList.add('order-item');
                orderItemDiv.innerHTML = `
                    <span class="qty">${item.quantity}</span>
                    <span class="name">${item.name.toUpperCase()}</span>
                    <span class="price">€${itemTotal.toFixed(2)}</span>
                `;
                orderItemDiv.addEventListener('click', () => {
                    removeItemFromOrder(index);
                });
                orderList.appendChild(orderItemDiv);
            });

            subtotalAmount.textContent = `€${subtotal.toFixed(2)}`;
            totalAmount.textContent = `€${subtotal.toFixed(2)}`;
            calculateChange();
        }

        /**
         * Removes an item from the order by its index.
         * @param {number} index - The index of the item to remove.
         */
        function removeItemFromOrder(index) {
            if (index >= 0 && index < currentOrder.length) {
                currentOrder.splice(index, 1);
                renderOrder();
            } else {
                console.error('Ungültiger Artikelindex zum Entfernen.');
            }
        }

        /**
         * Calculates change based on cash given and total amount.
         */
        function calculateChange() {
            const total = parseFloat(totalAmount.textContent.replace('€', ''));
            let change = 0;
            if (cashGiven >= total) {
                change = cashGiven - total;
            } else {
                change = 0;
            }
            changeAmount.textContent = `€${change.toFixed(2)}`;
            changeHeader.textContent = `€${change.toFixed(2)}`;
        }

        /**
         * Handles numeric input from the keypad, implementing the "shift left" behavior.
         * @param {string} input - The digit or function ('X', '.', '00').
         */
        function handleNumericInput(input) {
            if (input === 'X') {
                if (currentInput !== '0.00' && currentInput !== '' && parseFloat(currentInput) > 0) {
                    multiplier = parseFloat(currentInput);
                    showMessageBox('Multiplikator', `Menge auf ${multiplier} gesetzt.`);
                    currentInput = '0.00';
                } else {
                    showMessageBox('Fehler', 'Bitte geben Sie zuerst eine Zahl für den Multiplikator ein.');
                }
            } else if (input === '.') {
                if (!currentInput.includes('.')) {
                    currentInput += '.'; // Allow manual decimal input
                }
            } else { // Handle digits '0'-'9', '00'
                // Remove existing decimal and leading zeros to get cents as a string
                let centsString = currentInput.replace('.', '').replace(/^0+/, '');
                if (centsString === '') centsString = '0'; // Handle case where input was just "0.00"

                if (input === '00') {
                    centsString += '00';
                } else {
                    centsString += input;
                }

                // Ensure a minimum length for proper decimal formatting (e.g., "5" becomes "005")
                while (centsString.length < 3) {
                    centsString = '0' + centsString;
                }

                // Format back to "X.XX"
                const euro = centsString.substring(0, centsString.length - 2);
                const cent = centsString.substring(centsString.length - 2);
                currentInput = `${euro === '' ? '0' : euro}.${cent}`;
            }
            inputDisplay.textContent = currentInput; // Update input display
        }


        /**
         * Handles actions of function buttons.
         * @param {string} func - The name of the function called.
         */
        function handleFunctionButton(func) {
            const total = parseFloat(totalAmount.textContent.replace('€', ''));

            switch (func) {
                case 'bar':
                    let receivedAmount = 0;
                    if (currentInput !== '' && currentInput !== '0.00') {
                        receivedAmount = parseFloat(currentInput);
                        if (isNaN(receivedAmount)) {
                             showMessageBox('Fehler', 'Ungültiger Betrag eingegeben.');
                             return;
                        }
                    } else {
                        receivedAmount = total;
                    }
                    
                    cashGiven = receivedAmount;
                    cashAmount.textContent = `€${cashGiven.toFixed(2)}`;
                    calculateChange();

                    currentInput = '0.00';
                    inputDisplay.textContent = currentInput;

                    if (cashGiven >= total) {
                        printWertbon(currentOrder); // Pass only currentOrder to print individual receipts
                        keypadArea.classList.add('hidden');
                        newOrderArea.classList.remove('hidden');
                    } else {
                        showMessageBox('Fehler', 'Nicht genug Bargeld.');
                    }
                    break;
                case 'zws':
                    showMessageBox('Zwischensumme', `Die aktuelle Zwischensumme beträgt: €${subtotalAmount.textContent.replace('€', '')}.`);
                    break;
                default:
                    showMessageBox('Fehler', `Unbekannte Funktion "${func}" aufgerufen.`);
            }
        }

        /**
         * Generates and prints a Wertbon (receipt) for each item individually if quantity > 1.
         * All generated bons are combined into a single print job.
         * @param {Array} order - The current order items.
         */
        function printWertbon(order) {
            const now = new Date();
            const dateString = now.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }); // "28.07.2025" or similar
            const currentYear = now.getFullYear();
            let allWertbonsHtml = '';

            // Function to find category stand name by product name
            const getProductCategoryStandName = (productName) => {
                for (const categoryId in posData.products) {
                    const product = posData.products[categoryId].find(p => p.name === productName);
                    if (product) {
                        const category = posData.categories.find(c => c.id === categoryId);
                        return category ? category.standName : 'Unbekannter Stand';
                    }
                }
                return 'Unbekannter Stand';
            };

            order.forEach(item => {
                for (let i = 0; i < item.quantity; i++) { // Generate HTML for each individual item
                    const currentItemPrice = item.price; // Price per single item
                    const standName = getProductCategoryStandName(item.name);

                    const singleWertbonContent = `
                        <div class="wertbon-print-area">
                            <div style="text-align: center; margin-bottom: 10px;">
                                <!-- LMG Logo from GitHub -->
                                <img src="https://raw.githubusercontent.com/DittmarJ/Verkaufssystem/main/LMG_Logo.png" alt="LMG Logo" style="width: 100px; height: 50px;">
                                <!-- Removed Lise-Meitner-Gymnasium text here -->
                            </div>
                            <h2 style="font-size: 1.5em; font-weight: bold; text-align: center; margin-bottom: 10px;">Schulfest ${currentYear}</h2>
                            <p style="text-align: center;">Lise-Meitner-Gymnasium<br>Kantstraße 1<br>79639 Grenzach-Wyhlen</p>
                            <div style="border-top: 1px dashed #000; margin: 15px 0;"></div>

                            <p style="text-align: center; font-style: italic; margin-bottom: 5px;">Bspw.</p>
                            <p style="text-align: center; font-size: 1.2em; font-weight: bold;">
                                ${item.name} €${currentItemPrice.toFixed(2)}
                                <span style="font-size: 0.8em; font-weight: normal; display: block;">(eingegebenes)</span>
                            </p>
                            <div style="border-top: 1px dashed #000; margin: 15px 0;"></div>

                            <p style="text-align: center; margin-bottom: 5px;">Einlösbar beim:</p>
                            <p style="text-align: center; font-size: 1.2em; font-weight: bold;">${standName}</p>
                            <div style="border-top: 1px dashed #000; margin: 15px 0;"></div>

                            <p style="text-align: center; font-size: 0.9em; margin-top: 10px;">Der Wertbon ist nur am Schulfest ${dateString} gültig.</p>
                            <p style="text-align: center; font-size: 1.1em; font-weight: bold; margin-top: 10px;">Vielen Dank für Ihre Unterstützung!</p>
                        </div>
                    `;
                    allWertbonsHtml += singleWertbonContent; // Accumulate HTML for all bons
                }
            });

            // Open one print window and write all accumulated HTML to it
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write('<html><head><title>Wertbon</title>');
                printWindow.document.write('<style>');
                // Include print styles directly
                printWindow.document.write(`
                    @media print {
                        body { margin: 0; }
                        /* Ensure each .wertbon-print-area takes a new page */
                        .wertbon-print-area {
                            position: relative;
                            left: 0;
                            top: 0;
                            width: 80mm;
                            padding: 10mm;
                            font-family: monospace;
                            font-size: 12px;
                            line-height: 1.4;
                            color: #000;
                            box-sizing: border-box;
                            page-break-after: always; /* Force a page break after each bon */
                        }
                        .wertbon-print-area:last-child {
                            page-break-after: auto; /* No page break after the very last bon */
                        }
                        .wertbon-print-area h2, .wertbon-print-area h3 {
                            text-align: center;
                            margin-bottom: 5px;
                        }
                        .wertbon-print-area table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 10px;
                        }
                        .wertbon-print-area th, .wertbon-print-area td {
                            padding: 2px 0;
                            border-bottom: 1px dashed #ccc;
                            text-align: left;
                        }
                        .wertbon-print-area td:nth-child(2) {
                            text-align: right;
                        }
                        .wertbon-print-area .total-line {
                            font-weight: bold;
                            border-top: 2px solid #000;
                        }
                        .wertbon-print-area .summary-line {
                            display: flex;
                            justify-content: space-between;
                            padding: 2px 0;
                        }
                        .wertbon-print-area .thank-you {
                            text-align: center;
                            margin-top: 15px;
                            font-size: 14px;
                            font-weight: bold;
                        }
                    }
                `);
                printWindow.document.write('</style></head><body>');
                printWindow.document.write(allWertbonsHtml); // Write all generated bons
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                // A small delay to ensure content is rendered before printing
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            } else {
                showMessageBox('Fehler', 'Pop-up-Blocker verhindert den Druck des Wertbons. Bitte Pop-ups für diese Seite zulassen.');
            }
        }


        // Event listener for the new "C" button in the header
        clearInputButton.addEventListener('click', () => {
            currentInput = '0.00';
            cashGiven = 0;
            cashAmount.textContent = '€0.00';
            inputDisplay.textContent = currentInput;
            calculateChange();
        });

        // Event listener for the "Neue Bestellung" button
        newOrderButton.addEventListener('click', () => {
            currentOrder = [];
            currentInput = '0.00';
            multiplier = 1;
            cashGiven = 0;

            renderOrder();
            inputDisplay.textContent = currentInput;
            cashAmount.textContent = '€0.00';
            changeAmount.textContent = '€0.00';
            changeHeader.textContent = '€0.00';

            newOrderArea.classList.add('hidden');
            keypadArea.classList.remove('hidden');
        });


        // Event listener for all general buttons (product, category, function)
        rightPanel.addEventListener('click', (event) => {
            const button = event.target.closest('.product-button, .admin-action-button, .menu-button'); // Added .menu-button
            if (!button) return;

            if (isAdminMode) {
                const action = button.dataset.action;
                const type = button.dataset.type;
                const itemId = button.dataset.id; // For products and sellers, this will be the Firestore doc ID

                if (action === 'admin-menu') {
                    const menuOption = button.dataset.menuOption;
                    if (menuOption === 'categories') {
                        currentAdminView = 'categories';
                        renderAdminCategoryManagement();
                    } else if (menuOption === 'products') {
                        currentAdminView = 'products';
                        renderAdminProductManagement();
                    } else if (menuOption === 'sellers') {
                        currentAdminView = 'sellers';
                        renderAdminSellerManagement();
                    }
                } else if (action === 'back-to-admin-main') {
                    currentAdminView = 'main';
                    renderAdminConfig(); // This now renders the main admin menu
                } else if (action === 'delete-category') {
                     if (confirm(`Sind Sie sicher, dass Sie Kategorie "${itemId}" löschen möchten? Alle zugehörigen Produkte werden ebenfalls gelöscht.`)) {
                        deleteCategoryFromFirestore(itemId);
                    }
                } else if (action === 'delete-product') {
                    if (confirm(`Sind Sie sicher, dass Sie Produkt "${itemId}" löschen möchten?`)) {
                        deleteProductFromFirestore(itemId);
                    }
                } else if (action === 'delete-seller') { // New seller delete action
                    if (confirm(`Sind Sie sicher, dass Sie Verkäufer "${itemId}" löschen möchten?`)) {
                        deleteSellerFromFirestore(itemId);
                    }
                }
                return;
            }

            // Normal POS mode clicks
            const product = button.dataset.product;
            const price = button.dataset.price;
            const action = button.dataset.action;
            const categoryId = button.dataset.categoryId;

            if (product && price) {
                addItemToOrder(product, price);
            } else if (action === 'category' && categoryId) {
                if (currentInput !== '0.00' && currentInput !== '' && parseFloat(currentInput) > 0) {
                    multiplier = parseFloat(currentInput);
                    showMessageBox('Menge vor Auswahl gesetzt', `Menge für die nächste Produktauswahl auf ${multiplier} gesetzt.`);
                    currentInput = '0.00';
                    inputDisplay.textContent = currentInput;
                }
                currentCategory = categoryId;
                renderProducts(categoryId);
            } else if (action === 'function') {
                handleFunctionButton(button.dataset.function);
            } else if (action === 'back-to-categories') {
                renderCategories();
                currentCategory = null;
            }
        });

        // Event listener for bottom panel buttons (numeric and fixed actions)
        document.querySelectorAll('.bottom-panel button').forEach(button => {
            button.addEventListener('click', () => {
                const input = button.dataset.input;
                const action = button.dataset.action;
                const func = button.dataset.function;

                if (input) {
                    handleNumericInput(input);
                } else if (action === 'function') {
                    handleFunctionButton(func);
                }
            });
        });

        /**
         * Renders the category buttons in the right panel.
         * Only dynamically managed categories are shown.
         */
        function renderCategories() {
            rightPanel.innerHTML = '';
            rightPanel.style.gridTemplateColumns = 'repeat(4, 1fr)';

            if (posData.categories.length === 0 && !isAdminMode) {
                 rightPanel.innerHTML = '<div class="col-span-4 text-center text-gray-400 text-lg">Keine Kategorien gefunden. Loggen Sie sich als Admin ein, um Kategorien hinzuzufügen.</div>';
                 return;
            }

            posData.categories.forEach(category => {
                const button = document.createElement('button');
                button.classList.add('product-button', category.color);
                button.innerHTML = category.name;
                button.dataset.action = 'category';
                button.dataset.categoryId = category.id;
                rightPanel.appendChild(button);
            });
        }

        /**
         * Renders product buttons for a specific category in the right panel.
         * @param {string} categoryId - The ID of the selected category.
         */
        function renderProducts(categoryId) {
            rightPanel.innerHTML = '';
            rightPanel.style.gridTemplateColumns = 'repeat(4, 1fr)';

            const backButton = document.createElement('button');
            backButton.classList.add('product-button', 'bg-gray-700');
            backButton.innerHTML = 'Zurück zu<br>Kategorien';
            backButton.dataset.action = 'back-to-categories';
            rightPanel.appendChild(backButton);

            const products = posData.products[categoryId] || [];
            if (products.length === 0) {
                 const noProductsMessage = document.createElement('div');
                 noProductsMessage.classList.add('col-span-3', 'text-center', 'text-gray-400', 'text-sm', 'flex', 'items-center', 'justify-center');
                 noProductsMessage.innerHTML = 'Keine Produkte in dieser Kategorie.';
                 rightPanel.appendChild(noProductsMessage);
            } else {
                products.forEach(product => {
                    const button = document.createElement('button');
                    button.classList.add('product-button', 'bg-blue-600');
                    button.innerHTML = `${product.name}<br>€${product.price.toFixed(2)}`;
                    button.dataset.product = product.name;
                    button.dataset.price = product.price;
                    rightPanel.appendChild(button);
                });
            }
        }

        /**
         * Renders the admin main menu interface.
         */
        function renderAdminConfig() {
            isAdminMode = true;
            currentAdminView = 'main';
            rightPanel.innerHTML = '';
            rightPanel.style.gridTemplateColumns = '1fr';
            rightPanel.classList.remove('admin-config-panel'); // Remove previous grid layout
            
            const adminMenuDiv = document.createElement('div');
            adminMenuDiv.classList.add('admin-main-menu');

            const categoryBtn = document.createElement('button');
            categoryBtn.classList.add('menu-button');
            categoryBtn.textContent = 'Kategorieverwaltung';
            categoryBtn.dataset.action = 'admin-menu';
            categoryBtn.dataset.menuOption = 'categories';
            adminMenuDiv.appendChild(categoryBtn);

            const productBtn = document.createElement('button');
            productBtn.classList.add('menu-button');
            productBtn.textContent = 'Produktverwaltung';
            productBtn.dataset.action = 'admin-menu';
            productBtn.dataset.menuOption = 'products';
            adminMenuDiv.appendChild(productBtn);

            const sellerBtn = document.createElement('button');
            sellerBtn.classList.add('menu-button');
            sellerBtn.textContent = 'Verkäuferverwaltung';
            sellerBtn.dataset.action = 'admin-menu';
            sellerBtn.dataset.menuOption = 'sellers';
            adminMenuDiv.appendChild(sellerBtn);

            const backToPosButton = document.createElement('button');
            backToPosButton.classList.add('product-button', 'bg-gray-700', 'mt-8'); // Add margin top
            backToPosButton.innerHTML = 'Zurück zum Kassenmodus';
            backToPosButton.addEventListener('click', () => {
                isAdminMode = false;
                renderCategories();
                keypadArea.classList.remove('hidden');
                rightPanel.classList.remove('admin-config-panel');
            });
            adminMenuDiv.appendChild(backToPosButton);

            rightPanel.appendChild(adminMenuDiv);

            keypadArea.classList.add('hidden');
            newOrderArea.classList.add('hidden');
        }

        /**
         * Renders the category management interface within admin mode.
         */
        function renderAdminCategoryManagement() {
            currentAdminView = 'categories';
            rightPanel.innerHTML = '';
            rightPanel.style.gridTemplateColumns = '1fr'; // Single column for this view
            rightPanel.classList.add('admin-config-panel'); // Apply admin panel layout

            const backToAdminMenuButton = document.createElement('button');
            backToAdminMenuButton.classList.add('product-button', 'bg-gray-700', 'col-span-full', 'mb-4');
            backToAdminMenuButton.innerHTML = 'Zurück zum Admin-Menü';
            backToAdminMenuButton.dataset.action = 'back-to-admin-main';
            rightPanel.appendChild(backToAdminMenuButton);

            // Add Category Section
            const addCategorySection = document.createElement('div');
            addCategorySection.classList.add('admin-config-section');
            addCategorySection.innerHTML = `
                <h4>Kategorie hinzufügen</h4>
                <input type="text" id="newCategoryId" placeholder="Kategorie ID (z.B. brot)">
                <input type="text" id="newCategoryName" placeholder="Kategorie Name (z.B. Brot)">
                <input type="text" id="newCategoryColor" placeholder="Farbe (z.B. yellow, #HEX)">
                <input type="text" id="newCategoryStandName" placeholder="Stand Name (z.B. Getränkestand)">
                <button id="addCategoryBtn">Kategorie hinzufügen</button>
                <div class="admin-config-list" id="categoryListAdmin"></div>
            `;
            rightPanel.appendChild(addCategorySection);

            const addCategoryBtn = addCategorySection.querySelector('#addCategoryBtn');
            addCategoryBtn.addEventListener('click', addCategory);

            populateAdminLists(); // Populate lists specific to this view
        }

        /**
         * Renders the product management interface within admin mode.
         */
        function renderAdminProductManagement() {
            currentAdminView = 'products';
            rightPanel.innerHTML = '';
            rightPanel.style.gridTemplateColumns = '1fr'; // Single column for this view
            rightPanel.classList.add('admin-config-panel'); // Apply admin panel layout

            const backToAdminMenuButton = document.createElement('button');
            backToAdminMenuButton.classList.add('product-button', 'bg-gray-700', 'col-span-full', 'mb-4');
            backToAdminMenuButton.innerHTML = 'Zurück zum Admin-Menü';
            backToAdminMenuButton.dataset.action = 'back-to-admin-main';
            rightPanel.appendChild(backToAdminMenuButton);

            // Add Product Section
            const addProductSection = document.createElement('div');
            addProductSection.classList.add('admin-config-section');
            addProductSection.innerHTML = `
                <h4>Produkt hinzufügen</h4>
                <select id="selectCategoryForProduct"></select>
                <input type="text" id="newProductName" placeholder="Produkt Name">
                <input type="number" id="newProductPrice" placeholder="Preis" step="0.01">
                <button id="addProductBtn">Produkt hinzufügen</button>
                <div class="admin-config-list" id="productListAdmin"></div>
            `;
            rightPanel.appendChild(addProductSection);

            const addProductBtn = addProductSection.querySelector('#addProductBtn');
            addProductBtn.addEventListener('click', addProduct);

            populateAdminLists(); // Populate lists specific to this view
        }

        /**
         * Renders the seller management interface within admin mode.
         */
        function renderAdminSellerManagement() {
            currentAdminView = 'sellers';
            rightPanel.innerHTML = '';
            rightPanel.style.gridTemplateColumns = '1fr'; // Single column for this view
            rightPanel.classList.add('admin-config-panel'); // Apply admin panel layout

            const backToAdminMenuButton = document.createElement('button');
            backToAdminMenuButton.classList.add('product-button', 'bg-gray-700', 'col-span-full', 'mb-4');
            backToAdminMenuButton.innerHTML = 'Zurück zum Admin-Menü';
            backToAdminMenuButton.dataset.action = 'back-to-admin-main';
            rightPanel.appendChild(backToAdminMenuButton);

            // Add Seller Section
            const addSellerSection = document.createElement('div');
            addSellerSection.classList.add('admin-config-section');
            addSellerSection.innerHTML = `
                <h4>Verkäufer hinzufügen</h4>
                <input type="text" id="newSellerName" placeholder="Verkäufer Name">
                <button id="addSellerBtn">Verkäufer hinzufügen</button>
                <div class="admin-config-list" id="sellerListAdmin"></div>
            `;
            rightPanel.appendChild(addSellerSection);

            const addSellerBtn = addSellerSection.querySelector('#addSellerBtn');
            addSellerBtn.addEventListener('click', addSeller);

            populateAdminLists(); // Populate lists specific to this view
        }


        /**
         * Populates the category, product, and seller lists in the admin configuration interface
         * based on the current admin view.
         */
        function populateAdminLists() {
            const categoryListAdmin = document.getElementById('categoryListAdmin');
            const productListAdmin = document.getElementById('productListAdmin');
            const selectCategoryForProduct = document.getElementById('selectCategoryForProduct');
            const sellerListAdmin = document.getElementById('sellerListAdmin'); // New: Seller list element

            // Clear relevant lists based on current view
            if (categoryListAdmin) categoryListAdmin.innerHTML = '';
            if (productListAdmin) productListAdmin.innerHTML = '';
            if (selectCategoryForProduct) selectCategoryForProduct.innerHTML = '<option value="">Kategorie auswählen</option>';
            if (sellerListAdmin) sellerListAdmin.innerHTML = '';

            // Populate Category List (if visible)
            if (categoryListAdmin) {
                posData.categories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.classList.add('admin-config-item');
                    categoryItem.innerHTML = `
                        <span>${category.name} (${category.id}) - Stand: ${category.standName || 'N/A'}</span>
                        <div>
                            <button class="delete" data-type="category" data-id="${category.id}" data-action="delete-category">Löschen</button>
                        </div>
                    `;
                    categoryListAdmin.appendChild(categoryItem);
                });
            }

            // Populate Product Category Dropdown and Product List (if visible)
            if (selectCategoryForProduct) {
                posData.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    selectCategoryForProduct.appendChild(option);
                });
            }
            if (productListAdmin) {
                for (const categoryId in posData.products) {
                    posData.products[categoryId].forEach(product => {
                        const productItem = document.createElement('div');
                        productItem.classList.add('admin-config-item');
                        productItem.innerHTML = `
                            <span>${product.name} (€${product.price.toFixed(2)}) - ${posData.categories.find(c => c.id === categoryId)?.name || categoryId}</span>
                            <div>
                                <button class="delete" data-type="product" data-id="${product.id}" data-action="delete-product">Löschen</button>
                            </div>
                        `;
                        productListAdmin.appendChild(productItem);
                    });
                }
            }

            // Populate Seller List (if visible)
            if (sellerListAdmin) {
                posData.sellers.forEach(seller => {
                    const sellerItem = document.createElement('div');
                    sellerItem.classList.add('admin-config-item');
                    sellerItem.innerHTML = `
                        <span>${seller.name}</span>
                        <div>
                            <button class="delete" data-type="seller" data-id="${seller.id}" data-action="delete-seller">Löschen</button>
                        </div>
                    `;
                    sellerListAdmin.appendChild(sellerItem);
                });
            }
        }

        /**
         * Adds a new category to posData and Firestore.
         */
        async function addCategory() {
            const id = document.getElementById('newCategoryId').value.trim();
            const name = document.getElementById('newCategoryName').value.trim();
            const color = document.getElementById('newCategoryColor').value.trim();
            const standName = document.getElementById('newCategoryStandName').value.trim(); // Get new field

            if (id && name && color && standName) { // Check for standName
                if (posData.categories.some(cat => cat.id === id)) {
                    showMessageBox('Fehler', 'Kategorie ID existiert bereits!');
                    return;
                }
                const newCategory = { id, name, color, standName }; // Include standName
                await saveCategoryToFirestore(newCategory); // Save to Firestore
                showMessageBox('Erfolg', `Kategorie "${name}" hinzugefügt.`);
                document.getElementById('newCategoryId').value = '';
                document.getElementById('newCategoryName').value = '';
                document.getElementById('newCategoryColor').value = '';
                document.getElementById('newCategoryStandName').value = ''; // Clear new field
            } else {
                showMessageBox('Fehler', 'Bitte alle Felder für die Kategorie ausfüllen.');
            }
        }

        /**
         * Adds a new product to posData and Firestore.
         */
        async function addProduct() {
            const categoryId = document.getElementById('selectCategoryForProduct').value;
            const name = document.getElementById('newProductName').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);

            if (categoryId && name && !isNaN(price) && price >= 0) {
                if (posData.products[categoryId] && posData.products[categoryId].some(prod => prod.name === name)) {
                    showMessageBox('Fehler', 'Produktname existiert bereits in dieser Kategorie!');
                    return;
                }
                const newProduct = { categoryId, name, price };
                await saveProductToFirestore(newProduct); // Save to Firestore
                showMessageBox('Erfolg', `Produkt "${name}" in "${posData.categories.find(c => c.id === categoryId)?.name}" hinzugefügt.`);
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductPrice').value = '';
            } else {
                showMessageBox('Fehler', 'Bitte alle Felder für das Produkt korrekt ausfüllen (Preis muss eine Zahl sein).');
            }
        }

        /**
         * Adds a new seller to posData and Firestore.
         */
        async function addSeller() {
            const name = document.getElementById('newSellerName').value.trim();
            if (name) {
                if (posData.sellers.some(seller => seller.name === name)) {
                    showMessageBox('Fehler', 'Verkäufer mit diesem Namen existiert bereits!');
                    return;
                }
                const newSeller = { name };
                await saveSellerToFirestore(newSeller);
                showMessageBox('Erfolg', `Verkäufer "${name}" hinzugefügt.`);
                document.getElementById('newSellerName').value = '';
            } else {
                showMessageBox('Fehler', 'Bitte geben Sie einen Namen für den Verkäufer ein.');
            }
        }


        // Admin Login/Logout Logic
        adminLoginBtn.addEventListener('click', () => {
            adminLoginOverlay.classList.remove('hidden');
        });

        cancelLoginBtn.addEventListener('click', () => {
            adminLoginOverlay.classList.add('hidden');
            adminUsernameInput.value = 'admin';
            adminPasswordInput.value = 'admin123';
        });

        loginBtn.addEventListener('click', () => {
            const username = adminUsernameInput.value;
            const password = adminPasswordInput.value;

            if (username === 'admin' && password === 'admin123') {
                isAdminMode = true;
                adminLoginOverlay.classList.add('hidden');
                adminLoginBtn.classList.add('hidden');
                adminLogoutBtn.classList.remove('hidden');
                adminModeStatus.classList.remove('hidden');
                showMessageBox('Login erfolgreich', 'Willkommen, Administrator!');
                renderAdminConfig(); // Render the main admin menu
            } else {
                showMessageBox('Login fehlgeschritten', 'Falscher Benutzername oder Passwort.');
            }
        });

        adminLogoutBtn.addEventListener('click', () => {
            isAdminMode = false;
            adminLoginBtn.classList.remove('hidden');
            adminLogoutBtn.classList.add('hidden');
            adminModeStatus.classList.add('hidden');
            showMessageBox('Abgemeldet', 'Sie wurden abgemeldet.');
            renderCategories(); // Go back to normal POS view
            keypadArea.classList.remove('hidden');
            newOrderArea.classList.add('hidden');
        });

        // Initial rendering of categories when the page loads
        initializeFirebase();
        renderOrder(); // Render initial empty order
        inputDisplay.textContent = currentInput; // Set initial display to 0.00
    </script>
</body>
</html>
