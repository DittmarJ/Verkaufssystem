<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kassensystem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .pos-container {
            width: 100%;
            max-width: 1024px;
            height: 768px; /* Fixed height for the entire POS system screen */
            background-color: #1a1a1a;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 5px solid #000;
        }
        .header-bar {
            background-color: #383838;
            color: #ccc;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            border-top-left-radius: 1.2rem;
            border-top-right-radius: 1.2rem;
            border-bottom: 1px solid #4a4a4a;
            height: 60px; /* Fixed height for the header */
        }
        .header-bar .user-badge {
            background-color: #007bff;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .header-bar .status-item {
            margin-left: 1.5rem;
            font-weight: 600;
        }
        .header-bar .change-display {
            color: #66ff66;
            font-weight: bold;
            font-size: 1.1rem;
            margin-left: 0.5rem;
        }
        .main-content {
            flex-grow: 1; /* Takes remaining height after header and footer */
            display: flex;
            padding: 1rem;
            gap: 1rem;
        }
        .left-panel {
            background-color: #2e2e2e;
            width: 350px; /* Fixed width for the left panel */
            flex-shrink: 0; /* Prevents it from shrinking */
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            color: #eee;
            border: 1px solid #4a4a4a;
            height: 100%; /* Takes 100% of main-content's height */
        }
        .order-list-header {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0.25rem;
            font-weight: bold;
            border-bottom: 1px solid #5a5a5a;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #bbb;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        .order-list-container {
            flex-grow: 1; /* Takes all available vertical space in left-panel */
            overflow-y: auto; /* Enable scrolling for overflow */
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0.25rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.1s ease;
        }
        .order-item:hover {
            background-color: #3b3b3b;
        }
        .order-item .qty { width: 10%; text-align: left; }
        .order-item .name { width: 60%; text-align: left; }
        .order-item .price { width: 30%; text-align: right; }
        .summary-section {
            padding-top: 1rem;
            font-size: 1.1rem;
            border-top: 1px solid #5a5a5a;
            flex-shrink: 0; /* Prevent summary from shrinking */
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        .summary-item.subtotal {
            font-size: 1.1rem;
            color: #ccc;
        }
        .summary-item.total {
            font-weight: bold;
            font-size: 1.5rem;
            color: #ffcc00;
        }
        .summary-item.cash {
            font-size: 1.1rem;
            color: #ccc;
        }
        .summary-item.change {
            font-weight: bold;
            font-size: 1.5rem;
            color: #66ff66;
        }
        .right-panel {
            flex: 1; /* Takes all remaining width */
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.7rem;
            align-content: start;
            height: 100%; /* Takes 100% of main-content's height */
        }
        .product-button {
            background-color: #555;
            color: white;
            padding: 1rem 0.5rem;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            height: 75px;
        }
        .product-button:hover {
            background-color: #666;
        }
        /* Color classes for dynamic categories */
        .product-button.yellow { background-color: #ffc107; color: #333; }
        .product-button.orange { background-color: #fd7e14; }
        .product-button.purple { background-color: #6f42c1; }
        .product-button.green { background-color: #28a745; }
        .product-button.blue { background-color: #007bff; }
        .product-button.red { background-color: #dc3545; }
        .product-button.light-blue { background-color: #17a2b8; }
        .product-button.pink { background-color: #e83e8c; }
        .product-button.gray { background-color: #6c757d; }

        .bottom-panel-container {
            background-color: #2e2e2e;
            padding: 1rem;
            border-bottom-left-radius: 1.2rem;
            border-bottom-right-radius: 1.2rem;
            color: white;
            border-top: 1px solid #4a4a4a;
            height: 300px; /* Sufficient height for dynamic content */
        }

        .input-display-area {
            display: flex;
            align-items: center;
            background-color: #1a1a1a;
            border-radius: 0.5rem;
            margin-bottom: 0.7rem;
            border: 1px solid #4a4a4a;
            min-height: 2.5rem; /* ~40px */
            padding-right: 1rem; /* Padding for the display text */
        }

        .input-display-line {
            flex-grow: 1; /* Takes up remaining space */
            color: #66ff66;
            font-size: 2rem;
            font-weight: bold;
            text-align: right;
            padding: 0.5rem 0; /* Padding handled by parent */
        }

        .clear-input-button {
            background-color: #dc3545; /* Red color for Clear */
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-left: 0.5rem; /* Space between button and display */
            height: 40px; /* Match height of input display roughly */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .clear-input-button:hover {
            background-color: #c82333;
        }

        .bottom-panel {
            display: grid;
            grid-template-columns: repeat(3, 0.8fr) 1fr 1.2fr;
            gap: 0.7rem;
        }
        
        .num-button, .action-button {
            height: 60px; /* Smaller consistent height for all buttons */
            border-radius: 0.75rem; /* Ensure rounded corners for consistency */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            padding: 0.5rem; /* Reduced padding for smaller buttons */
        }

        .num-button {
            background-color: #505050;
            font-size: 1.2rem; /* Smaller font size for numbers */
        }
        .num-button:hover {
            background-color: #606060;
        }
        .num-button.decimal {
            font-size: 1.8rem; /* Slightly larger font for decimal comma */
        }

        .action-button {
            background-color: #444;
            font-size: 1.2rem; /* Standard font size for action buttons (now smaller overall) */
        }
        .action-button:hover {
            background-color: #555;
        }

        .action-button[data-input="X"],
        .action-button[data-action="function"][data-function="zws"],
        .action-button[data-action="function"][data-function="bar"] {
            font-size: 1.6rem; /* Larger font size to make them stand out */
        }
        
        .action-button.yellow-func { background-color: #ffc107; color: #333; }
        .action-button.purple-func { background-color: #6f42c1; }
        .action-button.bar-func { background-color: #66ff66; color: #333; }

        /* New Order Button Styling */
        .new-order-button {
            background-color: #28a745; /* Green color */
            color: white;
            font-weight: bold;
            font-size: 2rem;
            padding: 1.5rem;
            border-radius: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
            height: 100%; /* Take full height of its container */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .new-order-button:hover {
            background-color: #218838;
        }

        /* Message Box Styling */
        .message-box-overlay, .admin-login-overlay, .live-display-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box, .admin-login-box, .live-display-box {
            background-color: #333;
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 2px solid #555;
        }
        .message-box h3, .admin-login-box h3, .live-display-box h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #ffcc00;
        }
        .message-box p, .admin-login-box p, .live-display-box p {
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        .message-box button, .admin-login-box button, .live-display-box button {
            background-color: #007bff;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .message-box button:hover, .admin-login-box button:hover, .live-display-box button:hover {
            background-color: #0056b3;
        }
        .admin-login-box input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            font-size: 1rem;
        }
        .admin-login-box button {
            margin: 0 10px;
        }
        .live-display-box input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            font-size: 1rem;
            text-align: center;
        }


        /* Admin Configuration Panel Specific Styles */
        .admin-config-panel {
            grid-template-columns: repeat(2, 1fr);
            overflow-y: auto;
        }
        .admin-config-section {
            background-color: #3b3b3b;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        .admin-config-section h4 {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #ffcc00;
        }
        .admin-config-section input, .admin-config-section select {
            width: calc(100% - 20px);
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
        }
        .admin-config-section button {
            background-color: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 5px;
            margin-right: 5px;
        }
        .admin-config-section button.delete {
            background-color: #dc3545;
        }
        .admin-config-section button:hover {
            background-color: #218838;
        }
        .admin-config-section button.delete:hover {
            background-color: #c82333;
        }
        .admin-config-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 5px;
            margin-top: 10px;
        }
        .admin-config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #4a4a4a;
        }
        .admin-config-item:last-child {
            border-bottom: none;
        }
        .admin-config-item button {
            padding: 3px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        /* Admin Main Menu specific styles */
        .admin-main-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            height: 100%; /* Take full height of right-panel */
        }
        .admin-main-menu .menu-button {
            width: 80%;
            max-width: 300px;
            height: 80px;
            font-size: 1.5rem;
            background-color: #007bff;
            color: white;
            border-radius: 1rem;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .admin-main-menu .menu-button:hover {
            background-color: #0056b3;
        }


        /* Receipt Print Style */
        @media print {
            body * {
                visibility: hidden;
            }
            .receipt-print-area, .receipt-print-area * {
                visibility: visible;
            }
            .receipt-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm; /* Common receipt printer width */
                padding: 10mm;
                font-family: 'monospace';
                font-size: 12px;
                line-height: 1.4;
                color: #000;
                box-sizing: border-box;
            }
            .receipt-print-area h2, .receipt-print-area h3 {
                text-align: center;
                margin-bottom: 5px;
            }
            .receipt-print-area h2 {
                font-size: 18px; /* Larger for the logo-like header */
                margin-bottom: 10px;
            }
            .receipt-print-area h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }
            .receipt-print-area .info-line {
                display: flex;
                justify-content: space-between;
                margin-bottom: 2px;
            }
            .receipt-print-area .separator {
                border-top: 1px dashed #000; /* Dashed line for items */
                margin: 5px 0;
            }
            .receipt-print-area .solid-separator {
                border-top: 2px solid #000; /* Solid line for totals */
                margin: 5px 0;
            }
            .receipt-print-area table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            .receipt-print-area th, .receipt-print-area td {
                padding: 2px 0;
                text-align: left;
            }
            .receipt-print-area th.right-align, .receipt-print-area td.right-align {
                text-align: right;
            }
            .receipt-print-area th.center-align, .receipt-print-area td.center-align {
                text-align: center;
            }
            .receipt-print-area .item-row td {
                border-bottom: 1px dashed #ccc;
            }
            .receipt-print-area .summary-row td {
                font-weight: bold;
            }
            .receipt-print-area .thank-you {
                text-align: center;
                margin-top: 15px;
                font-size: 14px;
                font-weight: bold;
            }
            .receipt-print-area .total-final {
                font-size: 16px;
                font-weight: bold;
                margin-top: 10px;
            }

            /* Wertbon Print Style */
            .wertbon-print-area {
                position: relative; /* Changed to relative for multiple bons */
                left: 0;
                top: 0;
                width: 80mm; /* Common receipt printer width */
                padding: 10mm;
                font-family: 'monospace';
                font-size: 12px;
                line-height: 1.4;
                color: #000;
                box-sizing: border-box;
                page-break-after: always; /* Force a page break after each bon */
                border: 1px solid #ccc; /* Add a subtle border for visual separation in print preview */
                margin-bottom: 10mm; /* Space between wertbons in print preview */
            }
            .wertbon-print-area:last-child {
                page-break-after: auto; /* No page break after the very last bon */
                margin-bottom: 0;
            }
            .wertbon-print-area h2, .wertbon-print-area h3 {
                text-align: center;
                margin-bottom: 5px;
            }
            .wertbon-print-area h2 {
                font-size: 18px; /* Larger for the logo-like header */
                margin-bottom: 10px;
            }
            .wertbon-print-area h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }
            .wertbon-print-area .info-line {
                display: flex;
                justify-content: space-between;
                margin-bottom: 2px;
            }
            .wertbon-print-area .item-name {
                font-size: 20px;
                font-weight: bold;
                text-align: center;
                margin: 20px 0;
                border: 2px solid #000; /* Border around the item name */
                padding: 10px;
            }
            .wertbon-print-area .thank-you {
                text-align: center;
                margin-top: 15px;
                font-size: 14px;
                font-weight: bold;
            }
            .wertbon-print-area .solid-separator {
                border-top: 2px solid #000; /* Solid line */
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="pos-container">
        <div class="header-bar">
            <div class="flex items-center gap-2">
                <span class="user-badge">Frau Becker</span>
                <span id="displayUserId" class="text-sm text-gray-400 ml-2">[UserID: Laden...] (Kat./Prod. Geteilt)</span>
                <button id="liveDisplayLinkBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-full text-sm ml-4">Live Display Link</button>
                <button id="adminLoginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-full text-sm ml-4">Admin Login</button>
                <button id="adminLogoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full text-sm ml-4 hidden">Admin Logout</button>
                <span id="adminModeStatus" class="text-green-400 text-sm ml-2 hidden">Admin-Modus AN</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="status-item">REG</span>
                <span class="status-item">RÜCKGELD</span>
                <span id="changeHeader" class="change-display">€0.00</span>
                <span id="currentTime" class="status-item"></span>
                <span id="currentDate" class="status-item"></span>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="order-list-header">
                    <span class="qty">Menge</span>
                    <span class="name">Artikel</span>
                    <span class="price">Preis</span>
                </div>
                <div class="order-list-container" id="orderList">
                </div>
                <div class="summary-section">
                    <div class="summary-item subtotal">
                        <span>ZWISCHENSUMME</span>
                        <span id="subtotalAmount">€0.00</span>
                    </div>
                    <div class="summary-item total">
                        <span>TOTAL</span>
                        <span id="totalAmount">€0.00</span>
                    </div>
                    <div class="summary-item cash">
                        <span>BAR</span>
                        <span id="cashAmount">€0.00</span>
                    </div>
                    <div class="summary-item change">
                        <span>RÜCKGELD</span>
                        <span id="changeAmount">€0.00</span>
                    </div>
                </div>
            </div>

            <div class="right-panel" id="rightPanel">
                <div id="loadingMessage" class="col-span-4 text-center text-gray-400 text-lg hidden">Lade Daten...</div>
            </div>
        </div>

        <div class="bottom-panel-container">
            <div class="input-display-area">
                <div id="inputDisplay" class="input-display-line"></div>
                <button id="clearInputButton" class="clear-input-button">C</button>
            </div>
            
            <div id="keypadArea" class="bottom-panel">
                <button class="num-button" data-input="7">7</button>
                <button class="num-button" data-input="8">8</button>
                <button class="num-button" data-input="9">9</button>
                <button class="num-button" data-input="0">0</button>
                <button class="action-button yellow-func" data-input="X">X</button>

                <button class="num-button" data-input="4">4</button>
                <button class="num-button" data-input="5">5</button>
                <button class="num-button" data-input="6">6</button>
                <button class="num-button" data-input="00">00</button>
                <button class="action-button purple-func" data-action="function" data-function="zws">ZWS</button>

                <button class="num-button" data-input="1">1</button>
                <button class="num-button" data-input="2">2</button>
                <button class="num-button" data-input="3">3</button>
                <button class="num-button decimal" data-input=".">,</button>
                <button class="action-button bar-func" data-action="function" data-function="bar">BAR</button>
            </div>

            <div id="newOrderArea" class="hidden" style="height: calc(100% - 2.5rem - 0.7rem); display: flex; gap: 1rem; padding: 1rem; box-sizing: border-box;">
                <button id="newOrderButton" class="new-order-button flex-1">NEUE BESTELLUNG</button>
                <button id="printWertbonsButton" class="new-order-button flex-1 bg-blue-600 hover:bg-blue-700">WERTBONS DRUCKEN</button>
            </div>
        </div>
    </div>

    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <h3 id="messageBoxTitle">Nachricht</h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxClose">OK</button>
        </div>
    </div>

    <div id="adminLoginOverlay" class="admin-login-overlay hidden">
        <div class="admin-login-box">
            <h3>Admin Login</h3>
            <input type="text" id="adminUsername" placeholder="Benutzername" value="admin">
            <input type="password" id="adminPassword" placeholder="Passwort" value="admin123">
            <button id="loginBtn">Login</button>
            <button id="cancelLoginBtn">Abbrechen</button>
        </div>
    </div>

    <div id="liveDisplayOverlay" class="live-display-overlay hidden">
        <div class="live-display-box">
            <h3>Live Display Link</h3>
            <p>Öffne diesen Link auf dem zweiten iPad:</p>
            <input type="text" id="liveDisplayUrl" readonly>
            <button id="copyLiveDisplayUrlBtn">Link kopieren</button>
            <button id="closeLiveDisplayBtn">Schließen</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase app and services
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous until authenticated

        // Firebase Configuration - REPLACE with your actual Firebase project config
        const firebaseConfig = {
          apiKey: "AIzaSyAyO_3QNTZq2IOdvBMm6ZLHYFv96H9F50I", // **YOUR_API_KEY**
          authDomain: "verkaufssoftware.firebaseapp.com",
          projectId: "verkaufssoftware",
          storageBucket: "verkaufssoftware.firebasestorage.app",
          messagingSenderId: "268747007466",
          appId: "1:268747007466:web:c84a529f27a0f6849a3e93", // **YOUR_APP_ID**
          measurementId: "G-RMX5KJK543"
        };
        // For GitHub deployment, use your projectId as appId
        const appId = firebaseConfig.projectId;


        // DOM Elements
        const orderList = document.getElementById('orderList');
        const subtotalAmount = document.getElementById('subtotalAmount');
        const totalAmount = document.getElementById('totalAmount');
        const cashAmount = document.getElementById('cashAmount');
        const changeAmount = document.getElementById('changeAmount');
        const changeHeader = document.getElementById('changeHeader');
        const currentDateElem = document.getElementById('currentDate');
        const currentTimeElem = document.getElementById('currentTime');
        const displayUserId = document.getElementById('displayUserId'); // New: Element to display userId

        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxClose = document.getElementById('messageBoxClose');

        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const adminModeStatus = document.getElementById('adminModeStatus');
        const adminLoginOverlay = document.getElementById('adminLoginOverlay');
        const adminUsernameInput = document.getElementById('adminUsername');
        const adminPasswordInput = document.getElementById('adminPassword');
        const loginBtn = document.getElementById('loginBtn');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn'); 

        const rightPanel = document.getElementById('rightPanel');
        const inputDisplay = document.getElementById('inputDisplay'); // Input display element
        const clearInputButton = document.getElementById('clearInputButton'); // New C button

        const keypadArea = document.getElementById('keypadArea'); // Numeric keypad and function buttons area
        const newOrderArea = document.getElementById('newOrderArea'); // "Neue Bestellung" button area
        const newOrderButton = document.getElementById('newOrderButton'); // The "Neue Bestellung" button
        const printWertbonsButton = document.getElementById('printWertbonsButton'); // New Wertbons button

        // Live Display Elements
        const liveDisplayLinkBtn = document.getElementById('liveDisplayLinkBtn');
        const liveDisplayOverlay = document.getElementById('liveDisplayOverlay');
        const liveDisplayUrlInput = document.getElementById('liveDisplayUrl');
        const copyLiveDisplayUrlBtn = document.getElementById('copyLiveDisplayUrlBtn');
        const closeLiveDisplayBtn = document.getElementById('closeLiveDisplayBtn');
        const loadingMessage = document.getElementById('loadingMessage'); // Loading message


        // State variables
        let currentOrder = [];
        let currentInput = '0.00'; // Initialize with "0.00"
        let multiplier = 1;
        let cashGiven = 0;
        let isAdminMode = false;
        let currentCategory = null; // Stores the currently selected category for product display
        let currentAdminView = 'main'; // Tracks the current admin view: 'main', 'categories', 'products', 'sellers'

        // POS Data (now dynamically loaded from Firebase)
        let posData = {
            "categories": [],
            "products": {}, // Products will be grouped by category ID in this object
            "sellers": [] // New: Array to store seller data
        };

        // State to track if Firestore listeners have been set up
        let firestoreListenersSetup = false;

        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            try {
                if (firebaseConfig && Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    console.log("Firebase initialized.");

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            displayUserId.textContent = `[UserID: ${userId}] (Kat./Prod. Geteilt)`;
                            console.log("User authenticated. Current userId:", userId);
                            if (!firestoreListenersSetup) {
                                console.log("Authentication successful, calling setupFirestoreListeners.");
                                setupFirestoreListeners();
                                firestoreListenersSetup = true;
                            }
                        } else {
                            // User is signed out. Sign in anonymously.
                            console.log("No user signed in. Attempting anonymous sign-in...");
                            await signInAnonymously(auth);
                            // The onAuthStateChanged listener will fire again with the new anonymous user
                        }
                    });
                } else {
                    console.error("Firebase configuration is missing or incomplete.");
                    showMessage('Fehler', 'Firebase-Konfiguration fehlt. Bitte überprüfen Sie Ihre Einstellungen.');
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage('Fehler', `Firebase Initialisierung fehlgeschlagen: ${error.message}`);
            }
        }

        // --- Firebase Data Listeners ---
        function setupFirestoreListeners() {
            // Listen for Categories
            onSnapshot(collection(db, 'categories'), (snapshot) => {
                posData.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                posData.categories.sort((a, b) => (a.order || 0) - (b.order || 0)); // Sort categories
                console.log("Categories updated:", posData.categories);
                if (currentAdminView === 'categories') {
                    renderAdminCategories();
                } else if (!isAdminMode) {
                    renderProductCategories();
                }
            }, (error) => {
                console.error("Error fetching categories:", error);
                showMessage('Fehler', 'Kategorien konnten nicht geladen werden.');
            });

            // Listen for Products
            onSnapshot(collection(db, 'products'), (snapshot) => {
                posData.products = {};
                snapshot.docs.forEach(doc => {
                    const product = { id: doc.id, ...doc.data() };
                    if (!posData.products[product.categoryId]) {
                        posData.products[product.categoryId] = [];
                    }
                    posData.products[product.categoryId].push(product);
                });
                // Sort products within each category if needed (e.g., by name)
                for (const categoryId in posData.products) {
                    posData.products[categoryId].sort((a, b) => a.name.localeCompare(b.name));
                }
                console.log("Products updated:", posData.products);
                if (currentAdminView === 'products') {
                    renderAdminProducts(currentCategory); // Re-render if in product admin view
                } else if (!isAdminMode) {
                    // Only re-render if a category is selected or if displaying default
                    if (currentCategory) {
                        renderProducts(currentCategory);
                    } else {
                        renderProductCategories(); // Or default product display
                    }
                }
            }, (error) => {
                console.error("Error fetching products:", error);
                showMessage('Fehler', 'Produkte konnten nicht geladen werden.');
            });

            // Listen for Sellers (for user management)
            onSnapshot(collection(db, 'sellers'), (snapshot) => {
                posData.sellers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Sellers updated:", posData.sellers);
                if (currentAdminView === 'sellers') {
                    renderAdminSellers();
                }
            }, (error) => {
                console.error("Error fetching sellers:", error);
                showMessage('Fehler', 'Verkäuferdaten konnten nicht geladen werden.');
            });
        }

        // --- Core POS Logic ---
        function formatCurrency(value) {
            return `€${parseFloat(value).toFixed(2).replace('.', ',')}`;
        }

        function updateOrderDisplay() {
            orderList.innerHTML = '';
            let subtotal = 0;
            currentOrder.forEach((item, index) => {
                const itemTotal = item.price * item.qty;
                subtotal += itemTotal;

                const itemDiv = document.createElement('div');
                itemDiv.classList.add('order-item');
                itemDiv.innerHTML = `
                    <span class="qty">${item.qty}x</span>
                    <span class="name">${item.name}</span>
                    <span class="price">${formatCurrency(itemTotal)}</span>
                `;
                itemDiv.dataset.index = index; // Store index for removal/editing
                itemDiv.addEventListener('click', () => editOrderItem(index));
                orderList.appendChild(itemDiv);
            });

            const total = subtotal; // No tax or discounts implemented yet
            const change = cashGiven > 0 ? cashGiven - total : 0;

            subtotalAmount.textContent = formatCurrency(subtotal);
            totalAmount.textContent = formatCurrency(total);
            cashAmount.textContent = formatCurrency(cashGiven);
            changeAmount.textContent = formatCurrency(change);
            changeHeader.textContent = formatCurrency(change);

            // Hide/show new order button area based on order status
            if (currentOrder.length > 0 && cashGiven >= total) {
                keypadArea.classList.add('hidden');
                newOrderArea.classList.remove('hidden');
            } else {
                keypadArea.classList.remove('hidden');
                newOrderArea.classList.add('hidden');
            }
        }

        function addProductToOrder(product) {
            let existingItem = currentOrder.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.qty += multiplier;
            } else {
                currentOrder.push({ ...product, qty: multiplier });
            }
            multiplier = 1; // Reset multiplier after adding
            inputDisplay.textContent = '0.00'; // Clear input display
            updateOrderDisplay();
            updateLiveDisplay();
        }

        function editOrderItem(index) {
            const item = currentOrder[index];
            if (item) {
                showMessage('Artikel Bearbeiten', `Menge für "${item.name}" ändern? Aktuell: ${item.qty}x`, [
                    {
                        text: 'Menge ändern',
                        handler: () => {
                            const newQty = prompt(`Neue Menge für "${item.name}" eingeben:`, item.qty);
                            if (newQty !== null && !isNaN(parseInt(newQty)) && parseInt(newQty) > 0) {
                                item.qty = parseInt(newQty);
                                updateOrderDisplay();
                                updateLiveDisplay();
                            } else if (newQty !== null && parseInt(newQty) === 0) {
                                // If new quantity is 0, offer to remove
                                if (confirm(`Soll "${item.name}" wirklich aus der Bestellung entfernt werden?`)) {
                                    currentOrder.splice(index, 1);
                                    updateOrderDisplay();
                                    updateLiveDisplay();
                                }
                            }
                        }
                    },
                    {
                        text: 'Artikel entfernen',
                        handler: () => {
                            if (confirm(`Soll "${item.name}" wirklich aus der Bestellung entfernt werden?`)) {
                                currentOrder.splice(index, 1);
                                updateOrderDisplay();
                                updateLiveDisplay();
                            }
                        }
                    },
                    {
                        text: 'Abbrechen',
                        handler: () => {} // Do nothing
                    }
                ]);
            }
        }

        function showMessage(title, message, buttons = [{ text: 'OK', handler: () => { messageBoxOverlay.classList.add('hidden'); } }]) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBoxClose.onclick = null; // Clear previous handlers
            messageBoxClose.replaceWith(messageBoxClose.cloneNode(true)); // Re-create to remove all event listeners
            document.getElementById('messageBoxClose').addEventListener('click', buttons[0].handler);

            // Clear previous custom buttons and add new ones
            const existingCustomButtons = messageBoxOverlay.querySelectorAll('.message-box button:not(#messageBoxClose)');
            existingCustomButtons.forEach(btn => btn.remove());

            if (buttons.length > 1) {
                buttons.forEach((btn, idx) => {
                    if (idx === 0) return; // Skip the first button as it's already handled by messageBoxClose
                    const newButton = document.createElement('button');
                    newButton.textContent = btn.text;
                    newButton.classList.add('ml-2'); // Add some margin
                    newButton.addEventListener('click', () => {
                        btn.handler();
                        messageBoxOverlay.classList.add('hidden'); // Close after any button click
                    });
                    messageBoxOverlay.querySelector('.message-box').appendChild(newButton);
                });
            }

            messageBoxOverlay.classList.remove('hidden');
        }

        // --- Input and Keypad Logic ---
        function updateInputDisplay(value) {
            currentInput = value;
            inputDisplay.textContent = currentInput.replace('.', ','); // Display comma for decimals
        }

        function handleNumberInput(num) {
            if (currentInput === '0.00' || currentInput === '0') {
                currentInput = num;
            } else {
                currentInput += num;
            }
            updateInputDisplay(currentInput);
        }

        function handleDecimalInput() {
            if (!currentInput.includes('.')) {
                currentInput += '.';
            }
            updateInputDisplay(currentInput);
        }

        function handleClearInput() {
            currentInput = '0.00';
            updateInputDisplay(currentInput);
        }

        function handleFunction(func) {
            const inputValue = parseFloat(currentInput.replace(',', '.'));

            if (func === 'X') {
                if (inputValue > 0) {
                    multiplier = inputValue;
                    currentInput = '0.00'; // Reset input display after setting multiplier
                    updateInputDisplay(currentInput);
                    showMessage('Multiplikator', `Nächster Artikel wird ${multiplier}x hinzugefügt.`);
                } else {
                    showMessage('Fehler', 'Ungültiger Multiplikator. Muss > 0 sein.');
                }
            } else if (func === 'zws') {
                // Zwischensumme (Subtotal) function - usually for quick check
                showMessage('Zwischensumme', `Aktuelle Zwischensumme: ${subtotalAmount.textContent}`);
                currentInput = '0.00'; // Reset input display
                updateInputDisplay(currentInput);
            } else if (func === 'bar') {
                // Bar (Cash) payment
                const total = parseFloat(totalAmount.textContent.replace('€', '').replace(',', '.'));
                if (inputValue > 0 && inputValue >= total) {
                    cashGiven = inputValue;
                    updateOrderDisplay();
                    showMessage('Zahlung Erfolgreich', `Total: ${formatCurrency(total)}\nGegeben: ${formatCurrency(cashGiven)}\nRückgeld: ${changeAmount.textContent}`, [
                        {
                            text: 'Rechnung & Wertbons drucken',
                            handler: () => {
                                printReceipt();
                                printWertbons(); // Call the new function to print individual wertbons
                                showNewOrderButtons();
                            }
                        },
                        {
                            text: 'Nur neue Bestellung',
                            handler: () => {
                                showNewOrderButtons();
                            }
                        }
                    ]);
                } else {
                    showMessage('Fehler', 'Eingegebener Betrag ist zu niedrig oder ungültig.');
                }
                currentInput = '0.00'; // Reset input display
                updateInputDisplay(currentInput);
            }
        }

        function showNewOrderButtons() {
            keypadArea.classList.add('hidden');
            newOrderArea.style.display = 'flex'; // Use style to override hidden for flexbox
        }

        function startNewOrder() {
            currentOrder = [];
            currentInput = '0.00';
            multiplier = 1;
            cashGiven = 0;
            updateOrderDisplay();
            updateInputDisplay(currentInput);
            keypadArea.classList.remove('hidden');
            newOrderArea.style.display = 'none'; // Hide the new order buttons
            updateLiveDisplay(); // Clear live display for new order
        }

        // --- Product Display Logic ---
        function renderProductCategories() {
            rightPanel.innerHTML = ''; // Clear previous content
            rightPanel.style.gridTemplateColumns = 'repeat(4, 1fr)'; // Ensure 4 columns for categories/products
            loadingMessage.classList.add('hidden'); // Hide loading message

            posData.categories.forEach(category => {
                const button = document.createElement('button');
                button.classList.add('product-button', category.color || 'gray');
                button.textContent = category.name;
                button.addEventListener('click', () => {
                    currentCategory = category.id;
                    renderProducts(category.id);
                });
                rightPanel.appendChild(button);
            });
        }

        function renderProducts(categoryId) {
            rightPanel.innerHTML = ''; // Clear previous content
            rightPanel.style.gridTemplateColumns = 'repeat(4, 1fr)'; // Ensure 4 columns for products
            loadingMessage.classList.add('hidden'); // Hide loading message

            // Add a "Back to Categories" button
            const backButton = document.createElement('button');
            backButton.classList.add('product-button', 'bg-gray-700', 'hover:bg-gray-800');
            backButton.textContent = 'Zurück zu Kategorien';
            backButton.addEventListener('click', () => {
                currentCategory = null;
                renderProductCategories();
            });
            rightPanel.appendChild(backButton);

            const productsIn betrayed = posData.products[categoryId] || [];
            productsIn betrayed.forEach(product => {
                const button = document.createElement('button');
                button.classList.add('product-button');
                button.textContent = `${product.name} (${formatCurrency(product.price)})`;
                button.addEventListener('click', () => addProductToOrder(product));
                rightPanel.appendChild(button);
            });
        }

        // --- Admin Mode Logic ---
        function enterAdminMode() {
            isAdminMode = true;
            adminLoginOverlay.classList.add('hidden');
            adminLoginBtn.classList.add('hidden');
            adminLogoutBtn.classList.remove('hidden');
            adminModeStatus.classList.remove('hidden');
            showMessage('Admin Modus', 'Sie sind jetzt im Admin-Modus.');
            renderAdminMainMenu();
        }

        function exitAdminMode() {
            isAdminMode = false;
            adminLoginBtn.classList.remove('hidden');
            adminLogoutBtn.classList.add('hidden');
            adminModeStatus.classList.add('hidden');
            showMessage('Admin Modus', 'Sie haben den Admin-Modus verlassen.');
            renderProductCategories(); // Go back to normal POS view
            currentAdminView = 'main'; // Reset admin view
        }

        function renderAdminMainMenu() {
            rightPanel.innerHTML = `
                <div class="admin-main-menu col-span-4">
                    <button class="menu-button" data-admin-action="manageCategories">Kategorien Verwalten</button>
                    <button class="menu-button" data-admin-action="manageProducts">Produkte Verwalten</button>
                    <button class="menu-button" data-admin-action="manageSellers">Verkäufer Verwalten</button>
                    <button class="menu-button bg-red-500 hover:bg-red-600" data-admin-action="exitAdmin">Admin Modus Verlassen</button>
                </div>
            `;
            rightPanel.style.gridTemplateColumns = '1fr'; // Single column for main menu
            rightPanel.querySelectorAll('.menu-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const action = event.target.dataset.adminAction;
                    if (action === 'manageCategories') {
                        currentAdminView = 'categories';
                        renderAdminCategories();
                    } else if (action === 'manageProducts') {
                        currentAdminView = 'products';
                        renderAdminProducts(); // Start with no category selected, show all or let user pick
                    } else if (action === 'manageSellers') {
                        currentAdminView = 'sellers';
                        renderAdminSellers();
                    } else if (action === 'exitAdmin') {
                        exitAdminMode();
                    }
                });
            });
        }

        // --- Admin Category Management ---
        function renderAdminCategories() {
            rightPanel.innerHTML = `
                <div class="admin-config-panel col-span-4 grid grid-cols-2 gap-4">
                    <div class="admin-config-section">
                        <h4>Kategorie hinzufügen</h4>
                        <input type="text" id="newCategoryName" placeholder="Kategoriename">
                        <input type="number" id="newCategoryOrder" placeholder="Reihenfolge (Zahl)" value="0">
                        <select id="newCategoryColor">
                            <option value="gray">Standard (Grau)</option>
                            <option value="yellow">Gelb</option>
                            <option value="orange">Orange</option>
                            <option value="purple">Lila</option>
                            <option value="green">Grün</option>
                            <option value="blue">Blau</option>
                            <option value="red">Rot</option>
                            <option value="light-blue">Hellblau</option>
                            <option value="pink">Pink</option>
                        </select>
                        <button id="addCategoryBtn">Hinzufügen</button>
                    </div>
                    <div class="admin-config-section">
                        <h4>Bestehende Kategorien</h4>
                        <div class="admin-config-list" id="categoryListAdmin">
                            </div>
                        <button id="backToAdminMenuBtn" class="mt-4 bg-gray-600 hover:bg-gray-700">Zurück zum Admin-Menü</button>
                    </div>
                </div>
            `;
            rightPanel.style.gridTemplateColumns = 'repeat(2, 1fr)'; // Two columns for config
            document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
            document.getElementById('backToAdminMenuBtn').addEventListener('click', renderAdminMainMenu);
            displayAdminCategories();
        }

        function displayAdminCategories() {
            const categoryListAdmin = document.getElementById('categoryListAdmin');
            categoryListAdmin.innerHTML = '';
            posData.categories.forEach(category => {
                const div = document.createElement('div');
                div.classList.add('admin-config-item');
                div.innerHTML = `
                    <span>${category.name} (Reihenfolge: ${category.order || 0})</span>
                    <div>
                        <button data-id="${category.id}" class="delete">Löschen</button>
                    </div>
                `;
                categoryListAdmin.appendChild(div);
            });

            categoryListAdmin.querySelectorAll('.delete').forEach(button => {
                button.addEventListener('click', (e) => deleteCategory(e.target.dataset.id));
            });
        }

        async function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const order = parseInt(document.getElementById('newCategoryOrder').value) || 0;
            const color = document.getElementById('newCategoryColor').value;

            if (!name) {
                showMessage('Fehler', 'Kategoriename darf nicht leer sein.');
                return;
            }

            try {
                const newCategoryId = doc(collection(db, 'categories')).id; // Generate a new ID
                await setDoc(doc(db, 'categories', newCategoryId), { name, order, color });
                showMessage('Erfolg', 'Kategorie erfolgreich hinzugefügt!');
                document.getElementById('newCategoryName').value = ''; // Clear input
                document.getElementById('newCategoryOrder').value = '0'; // Reset order
                document.getElementById('newCategoryColor').value = 'gray'; // Reset color
            } catch (e) {
                console.error("Error adding category: ", e);
                showMessage('Fehler', `Fehler beim Hinzufügen der Kategorie: ${e.message}`);
            }
        }

        async function deleteCategory(id) {
            if (!confirm('Soll diese Kategorie wirklich gelöscht werden? Alle Produkte in dieser Kategorie werden ebenfalls gelöscht!')) {
                return;
            }

            try {
                // Delete associated products first
                const productsToDeleteQuery = query(collection(db, 'products'), where('categoryId', '==', id));
                const productSnapshot = await getDocs(productsToDeleteQuery);
                const deleteProductPromises = productSnapshot.docs.map(productDoc => deleteDoc(doc(db, 'products', productDoc.id)));
                await Promise.all(deleteProductPromises);

                await deleteDoc(doc(db, 'categories', id));
                showMessage('Erfolg', 'Kategorie und zugehörige Produkte erfolgreich gelöscht!');
            } catch (e) {
                console.error("Error removing category: ", e);
                showMessage('Fehler', `Fehler beim Löschen der Kategorie: ${e.message}`);
            }
        }

        // --- Admin Product Management ---
        function renderAdminProducts(categoryId = null) {
            rightPanel.innerHTML = `
                <div class="admin-config-panel col-span-4 grid grid-cols-2 gap-4">
                    <div class="admin-config-section">
                        <h4>Produkt hinzufügen</h4>
                        <input type="text" id="newProductName" placeholder="Produktname">
                        <input type="number" id="newProductPrice" placeholder="Preis (€)" step="0.01">
                        <select id="newProductCategory">
                            <option value="">Kategorie auswählen</option>
                            ${posData.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
                        </select>
                        <button id="addProductBtn">Hinzufügen</button>
                    </div>
                    <div class="admin-config-section">
                        <h4>Bestehende Produkte</h4>
                        <select id="filterProductCategory" class="mb-2">
                            <option value="">Alle Kategorien</option>
                            ${posData.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
                        </select>
                        <div class="admin-config-list" id="productListAdmin">
                            </div>
                        <button id="backToAdminMenuBtn" class="mt-4 bg-gray-600 hover:bg-gray-700">Zurück zum Admin-Menü</button>
                    </div>
                </div>
            `;
            rightPanel.style.gridTemplateColumns = 'repeat(2, 1fr)';
            document.getElementById('addProductBtn').addEventListener('click', addProduct);
            document.getElementById('backToAdminMenuBtn').addEventListener('click', renderAdminMainMenu);
            const filterSelect = document.getElementById('filterProductCategory');
            filterSelect.addEventListener('change', (e) => displayAdminProducts(e.target.value));

            // Set initial selected category if provided
            if (categoryId) {
                filterSelect.value = categoryId;
            }
            displayAdminProducts(categoryId);
        }

        function displayAdminProducts(filterCategoryId = null) {
            const productListAdmin = document.getElementById('productListAdmin');
            productListAdmin.innerHTML = '';

            let productsToDisplay = [];
            if (filterCategoryId) {
                productsToDisplay = posData.products[filterCategoryId] || [];
            } else {
                // Flatten all products if no filter
                for (const catId in posData.products) {
                    productsToDisplay = productsToDisplay.concat(posData.products[catId]);
                }
            }

            productsToDisplay.forEach(product => {
                const div = document.createElement('div');
                div.classList.add('admin-config-item');
                const categoryName = posData.categories.find(cat => cat.id === product.categoryId)?.name || 'Unbekannt';
                div.innerHTML = `
                    <span>${product.name} (${formatCurrency(product.price)}) - ${categoryName}</span>
                    <div>
                        <button data-id="${product.id}" class="delete">Löschen</button>
                    </div>
                `;
                productListAdmin.appendChild(div);
            });

            productListAdmin.querySelectorAll('.delete').forEach(button => {
                button.addEventListener('click', (e) => deleteProduct(e.target.dataset.id));
            });
        }

        async function addProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);
            const categoryId = document.getElementById('newProductCategory').value;

            if (!name || isNaN(price) || price <= 0 || !categoryId) {
                showMessage('Fehler', 'Bitte alle Felder korrekt ausfüllen.');
                return;
            }

            try {
                const newProductId = doc(collection(db, 'products')).id;
                await setDoc(doc(db, 'products', newProductId), { name, price, categoryId });
                showMessage('Erfolg', 'Produkt erfolgreich hinzugefügt!');
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductPrice').value = '';
                document.getElementById('newProductCategory').value = '';
            } catch (e) {
                console.error("Error adding product: ", e);
                showMessage('Fehler', `Fehler beim Hinzufügen des Produkts: ${e.message}`);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Soll dieses Produkt wirklich gelöscht werden?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'products', id));
                showMessage('Erfolg', 'Produkt erfolgreich gelöscht!');
            } catch (e) {
                console.error("Error removing product: ", e);
                showMessage('Fehler', `Fehler beim Löschen des Produkts: ${e.message}`);
            }
        }

        // --- Admin Seller Management ---
        function renderAdminSellers() {
            rightPanel.innerHTML = `
                <div class="admin-config-panel col-span-4 grid grid-cols-2 gap-4">
                    <div class="admin-config-section">
                        <h4>Verkäufer hinzufügen</h4>
                        <input type="text" id="newSellerName" placeholder="Verkäufername (z.B. Frau Becker)">
                        <input type="text" id="newSellerUsername" placeholder="Benutzername (für Login)">
                        <input type="password" id="newSellerPassword" placeholder="Passwort">
                        <button id="addSellerBtn">Hinzufügen</button>
                    </div>
                    <div class="admin-config-section">
                        <h4>Bestehende Verkäufer</h4>
                        <div class="admin-config-list" id="sellerListAdmin">
                            </div>
                        <button id="backToAdminMenuBtn" class="mt-4 bg-gray-600 hover:bg-gray-700">Zurück zum Admin-Menü</button>
                    </div>
                </div>
            `;
            rightPanel.style.gridTemplateColumns = 'repeat(2, 1fr)';
            document.getElementById('addSellerBtn').addEventListener('click', addSeller);
            document.getElementById('backToAdminMenuBtn').addEventListener('click', renderAdminMainMenu);
            displayAdminSellers();
        }

        function displayAdminSellers() {
            const sellerListAdmin = document.getElementById('sellerListAdmin');
            sellerListAdmin.innerHTML = '';
            posData.sellers.forEach(seller => {
                const div = document.createElement('div');
                div.classList.add('admin-config-item');
                div.innerHTML = `
                    <span>${seller.name} (${seller.username})</span>
                    <div>
                        <button data-id="${seller.id}" class="delete">Löschen</button>
                    </div>
                `;
                sellerListAdmin.appendChild(div);
            });

            sellerListAdmin.querySelectorAll('.delete').forEach(button => {
                button.addEventListener('click', (e) => deleteSeller(e.target.dataset.id));
            });
        }

        async function addSeller() {
            const name = document.getElementById('newSellerName').value.trim();
            const username = document.getElementById('newSellerUsername').value.trim();
            const password = document.getElementById('newSellerPassword').value.trim();

            if (!name || !username || !password) {
                showMessage('Fehler', 'Bitte alle Verkäuferfelder ausfüllen.');
                return;
            }

            try {
                // In a real application, you'd hash the password on a server.
                // For this simple example, we'll store it as-is for demonstration.
                // DO NOT do this in production.
                const newSellerId = doc(collection(db, 'sellers')).id;
                await setDoc(doc(db, 'sellers', newSellerId), { name, username, password });
                showMessage('Erfolg', 'Verkäufer erfolgreich hinzugefügt!');
                document.getElementById('newSellerName').value = '';
                document.getElementById('newSellerUsername').value = '';
                document.getElementById('newSellerPassword').value = '';
            } catch (e) {
                console.error("Error adding seller: ", e);
                showMessage('Fehler', `Fehler beim Hinzufügen des Verkäufers: ${e.message}`);
            }
        }

        async function deleteSeller(id) {
            if (!confirm('Soll dieser Verkäufer wirklich gelöscht werden?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'sellers', id));
                showMessage('Erfolg', 'Verkäufer erfolgreich gelöscht!');
            } catch (e) {
                console.error("Error removing seller: ", e);
                showMessage('Fehler', `Fehler beim Löschen des Verkäufers: ${e.message}`);
            }
        }

        // --- Live Display Logic (Basic Example) ---
        async function updateLiveDisplay() {
            try {
                if (db) {
                    await setDoc(doc(db, 'liveDisplays', userId), {
                        order: currentOrder.map(item => ({ name: item.name, qty: item.qty, price: item.price })),
                        total: parseFloat(totalAmount.textContent.replace('€', '').replace(',', '.')),
                        timestamp: new Date()
                    });
                    console.log("Live display updated for user:", userId);
                }
            } catch (error) {
                console.error("Error updating live display:", error);
            }
        }

        function generateLiveDisplayUrl() {
            const baseUrl = window.location.origin; // Get the base URL of the current page
            // Assuming your live display page is live-display.html in the same directory
            // You might need to adjust this path based on your actual file structure
            return `${baseUrl}/live-display.html?userId=${userId}`;
        }

        // --- Print Functions ---
        function printReceipt() {
            const printWindow = window.open('', '', 'height=600,width=400');
            printWindow.document.write('<html><head><title>Rechnung</title>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: monospace; font-size: 12px; line-height: 1.4; color: #000; margin: 0; padding: 10mm; }
                h2, h3 { text-align: center; margin-bottom: 5px; }
                h2 { font-size: 18px; margin-bottom: 10px; }
                h3 { font-size: 14px; margin-bottom: 10px; }
                .info-line { display: flex; justify-content: space-between; margin-bottom: 2px; }
                .separator { border-top: 1px dashed #000; margin: 5px 0; }
                .solid-separator { border-top: 2px solid #000; margin: 5px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { padding: 2px 0; text-align: left; }
                th.right-align, td.right-align { text-align: right; }
                th.center-align, td.center-align { text-align: center; }
                .item-row td { border-bottom: 1px dashed #ccc; }
                .summary-row td { font-weight: bold; }
                .thank-you { text-align: center; margin-top: 15px; font-size: 14px; font-weight: bold; }
                .total-final { font-size: 16px; font-weight: bold; margin-top: 10px; }
            `);
            printWindow.document.write('</style></head><body>');

            let receiptContent = `
                <div class="receipt-print-area">
                    <h2>Ihr Unternehmen Logo</h2>
                    <h3>Kassenbon</h3>
                    <div class="info-line"><span>Datum:</span><span>${currentDateElem.textContent}</span></div>
                    <div class="info-line"><span>Zeit:</span><span>${currentTimeElem.textContent}</span></div>
                    <div class="info-line"><span>Kassierer:</span><span>Frau Becker</span></div>
                    <div class="separator"></div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width:15%">Menge</th>
                                <th style="width:55%">Artikel</th>
                                <th class="right-align" style="width:30%">Preis</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            currentOrder.forEach(item => {
                receiptContent += `
                    <tr class="item-row">
                        <td>${item.qty}x</td>
                        <td>${item.name}</td>
                        <td class="right-align">${formatCurrency(item.price * item.qty)}</td>
                    </tr>
                `;
            });

            receiptContent += `
                        </tbody>
                    </table>
                    <div class="solid-separator"></div>
                    <div class="info-line summary-row">
                        <span>ZWISCHENSUMME</span>
                        <span class="right-align">${subtotalAmount.textContent}</span>
                    </div>
                    <div class="info-line total-final">
                        <span>GESAMT</span>
                        <span class="right-align">${totalAmount.textContent}</span>
                    </div>
                    <div class="info-line">
                        <span>BAR BEZAHLT</span>
                        <span class="right-align">${cashAmount.textContent}</span>
                    </div>
                    <div class="info-line">
                        <span>RÜCKGELD</span>
                        <span class="right-align">${changeAmount.textContent}</span>
                    </div>
                    <div class="separator"></div>
                    <p class="thank-you">Vielen Dank für Ihren Einkauf!</p>
                </div>
            `;
            printWindow.document.write(receiptContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function printWertbons() {
            const printWindow = window.open('', '', 'height=600,width=400');
            printWindow.document.write('<html><head><title>Wertbons</title>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: monospace; font-size: 12px; line-height: 1.4; color: #000; margin: 0; padding: 0; }
                .wertbon-print-area {
                    width: 80mm;
                    padding: 10mm;
                    box-sizing: border-box;
                    page-break-after: always; /* Each bon on a new page/cut */
                    border: 1px solid #eee; /* Light border for visual separation in preview */
                    margin-bottom: 5mm; /* Space between bons for print preview */
                }
                .wertbon-print-area:last-child {
                    page-break-after: auto;
                    margin-bottom: 0;
                }
                h2, h3 { text-align: center; margin-bottom: 5px; }
                h2 { font-size: 18px; margin-bottom: 10px; }
                h3 { font-size: 14px; margin-bottom: 10px; }
                .info-line { display: flex; justify-content: space-between; margin-bottom: 2px; }
                .item-name {
                    font-size: 20px;
                    font-weight: bold;
                    text-align: center;
                    margin: 20px 0;
                    border: 2px solid #000;
                    padding: 10px;
                }
                .thank-you { text-align: center; margin-top: 15px; font-size: 14px; font-weight: bold; }
                .solid-separator { border-top: 2px solid #000; margin: 5px 0; }
            `);
            printWindow.document.write('</style></head><body>');

            let wertbonContent = '';
            currentOrder.forEach(item => {
                for (let i = 0; i < item.qty; i++) {
                    wertbonContent += `
                        <div class="wertbon-print-area">
                            <h2>Ihr Unternehmen Logo</h2>
                            <h3>Wertbon für:</h3>
                            <div class="item-name">${item.name}</div>
                            <div class="info-line"><span>Preis:</span><span>${formatCurrency(item.price)}</span></div>
                            <div class="solid-separator"></div>
                            <div class="info-line"><span>Bon ID:</span><span>${Math.random().toString(36).substr(2, 9).toUpperCase()}</span></div>
                            <div class="info-line"><span>Ausgestellt am:</span><span>${currentDateElem.textContent}</span></div>
                            <p class="thank-you">Gültig für einen Artikel von dieser Art.</p>
                        </div>
                    `;
                }
            });

            printWindow.document.write(wertbonContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase(); // Initialize Firebase when DOM is ready
            updateTime();
            setInterval(updateTime, 1000); // Update time every second

            // Keypad number and decimal buttons
            document.querySelectorAll('.num-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const input = e.target.dataset.input;
                    if (input === '.') {
                        handleDecimalInput();
                    } else {
                        handleNumberInput(input);
                    }
                });
            });

            // Action buttons
            document.querySelectorAll('.action-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    const func = e.target.dataset.function || e.target.dataset.input; // 'X' is also an action
                    if (action === 'function') {
                        handleFunction(func);
                    } else if (action === 'product' && !isAdminMode) {
                        // This path is for product buttons that might be dynamically generated
                        // For now, products are handled directly by their creation logic
                    }
                });
            });

            clearInputButton.addEventListener('click', handleClearInput);
            messageBoxClose.addEventListener('click', () => messageBoxOverlay.classList.add('hidden'));

            newOrderButton.addEventListener('click', startNewOrder);
            printWertbonsButton.addEventListener('click', printWertbons); // Event listener for the new button

            adminLoginBtn.addEventListener('click', () => adminLoginOverlay.classList.remove('hidden'));
            loginBtn.addEventListener('click', async () => {
                const username = adminUsernameInput.value;
                const password = adminPasswordInput.value;

                // For a real system, you'd verify these credentials against your backend/Firebase Auth
                // For this example, we'll check against the sellers collection
                const q = query(collection(db, 'sellers'), where('username', '==', username), where('password', '==', password));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Simulate custom token login (if you had a server to generate it)
                    // For a client-side only app, you'd typically just set a session variable
                    // or use Firebase's own email/password auth for admin.
                    // For simplicity, we'll just toggle isAdminMode directly here.
                    enterAdminMode();
                } else {
                    showMessage('Login Fehlgeschlagen', 'Ungültiger Benutzername oder Passwort.');
                }
            });
            cancelLoginBtn.addEventListener('click', () => adminLoginOverlay.classList.add('hidden'));
            adminLogoutBtn.addEventListener('click', exitAdminMode);

            // Live Display Button Handlers
            liveDisplayLinkBtn.addEventListener('click', () => {
                liveDisplayUrlInput.value = generateLiveDisplayUrl();
                liveDisplayOverlay.classList.remove('hidden');
            });
            copyLiveDisplayUrlBtn.addEventListener('click', () => {
                liveDisplayUrlInput.select();
                document.execCommand('copy');
                showMessage('Kopiert!', 'Link wurde in die Zwischenablage kopiert.');
            });
            closeLiveDisplayBtn.addEventListener('click', () => liveDisplayOverlay.classList.add('hidden'));

            // Initial render
            renderProductCategories();
            updateOrderDisplay(); // Initialize display
            updateInputDisplay(currentInput); // Initialize input display
        });

        function updateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            currentDateElem.textContent = now.toLocaleDateString('de-DE', dateOptions);
            currentTimeElem.textContent = now.toLocaleTimeString('de-DE', timeOptions);
        }

    </script>
</body>
</html>
