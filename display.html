<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kassensystem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .pos-container {
            width: 100%;
            max-width: 1024px;
            height: 768px; /* Fixed height for the entire POS system screen */
            background-color: #1a1a1a;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 5px solid #000;
        }
        .header-bar {
            background-color: #383838;
            color: #ccc;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            border-top-left-radius: 1.2rem;
            border-top-right-radius: 1.2rem;
            border-bottom: 1px solid #4a4a4a;
            height: 60px; /* Fixed height for the header */
        }
        .header-bar .user-badge {
            background-color: #007bff;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .header-bar .status-item {
            margin-left: 1.5rem;
            font-weight: 600;
        }
        .header-bar .change-display {
            color: #66ff66;
            font-weight: bold;
            font-size: 1.1rem;
            margin-left: 0.5rem;
        }
        .main-content {
            flex-grow: 1; /* Takes remaining height after header and footer */
            display: flex;
            padding: 1rem;
            gap: 1rem;
        }
        .left-panel {
            background-color: #2e2e2e;
            width: 350px; /* Fixed width for the left panel */
            flex-shrink: 0; /* Prevents it from shrinking */
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            color: #eee;
            border: 1px solid #4a4a4a;
            height: 100%; /* Takes 100% of main-content's height */
        }
        .order-list-header {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0.25rem;
            font-weight: bold;
            border-bottom: 1px solid #5a5a5a;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #bbb;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        .order-list-container {
            flex-grow: 1; /* Takes all available vertical space in left-panel */
            overflow-y: auto; /* Enable scrolling for overflow */
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0.25rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.1s ease;
        }
        .order-item:hover {
            background-color: #3b3b3b;
        }
        .order-item .qty { width: 10%; text-align: left; }
        .order-item .name { width: 60%; text-align: left; }
        .order-item .price { width: 30%; text-align: right; }
        .summary-section {
            padding-top: 1rem;
            font-size: 1.1rem;
            border-top: 1px solid #5a5a5a;
            flex-shrink: 0; /* Prevent summary from shrinking */
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        .summary-item.subtotal {
            font-size: 1.1rem;
            color: #ccc;
        }
        .summary-item.total {
            font-weight: bold;
            font-size: 1.5rem;
            color: #ffcc00;
        }
        .summary-item.cash {
            font-size: 1.1rem;
            color: #ccc;
        }
        .summary-item.change {
            font-weight: bold;
            font-size: 1.5rem;
            color: #66ff66;
        }
        .right-panel {
            flex: 1; /* Takes all remaining width */
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.7rem;
            align-content: start;
            height: 100%; /* Takes 100% of main-content's height */
        }
        .product-button {
            background-color: #555;
            color: white;
            padding: 1rem 0.5rem;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            height: 75px;
        }
        .product-button:hover {
            background-color: #666;
        }
        /* Color classes for dynamic categories */
        .product-button.yellow { background-color: #ffc107; color: #333; }
        .product-button.orange { background-color: #fd7e14; }
        .product-button.purple { background-color: #6f42c1; }
        .product-button.green { background-color: #28a745; }
        .product-button.blue { background-color: #007bff; }
        .product-button.red { background-color: #dc3545; }
        .product-button.light-blue { background-color: #17a2b8; }
        .product-button.pink { background-color: #e83e8c; }
        .product-button.gray { background-color: #6c757d; }


        .bottom-panel-container {
            background-color: #2e2e2e;
            padding: 1rem;
            border-bottom-left-radius: 1.2rem;
            border-bottom-right-radius: 1.2rem;
            color: white;
            border-top: 1px solid #4a4a4a;
            height: 300px; /* Sufficient height for dynamic content */
        }

        .input-display-area {
            display: flex;
            align-items: center;
            background-color: #1a1a1a;
            border-radius: 0.5rem;
            margin-bottom: 0.7rem;
            border: 1px solid #4a4a4a;
            min-height: 2.5rem; /* ~40px */
            padding-right: 1rem; /* Padding for the display text */
        }

        .input-display-line {
            flex-grow: 1; /* Takes up remaining space */
            color: #66ff66;
            font-size: 2rem;
            font-weight: bold;
            text-align: right;
            padding: 0.5rem 0; /* Padding handled by parent */
        }

        .clear-input-button {
            background-color: #dc3545; /* Red color for Clear */
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-left: 0.5rem; /* Space between button and display */
            height: 40px; /* Match height of input display roughly */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .clear-input-button:hover {
            background-color: #c82333;
        }

        .bottom-panel {
            display: grid;
            grid-template-columns: repeat(3, 0.8fr) 1fr 1.2fr;
            gap: 0.7rem;
        }
        
        .num-button, .action-button {
            height: 60px; /* Smaller consistent height for all buttons */
            border-radius: 0.75rem; /* Ensure rounded corners for consistency */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            padding: 0.5rem; /* Reduced padding for smaller buttons */
        }

        .num-button {
            background-color: #505050;
            font-size: 1.2rem; /* Smaller font size for numbers */
        }
        .num-button:hover {
            background-color: #606060;
        }
        .num-button.decimal {
            font-size: 1.8rem; /* Slightly larger font for decimal comma */
        }

        .action-button {
            background-color: #444;
            font-size: 1.2rem; /* Standard font size for action buttons (now smaller overall) */
        }
        .action-button:hover {
            background-color: #555;
        }

        .action-button[data-input="X"],
        .action-button[data-action="function"][data-function="zws"],
        .action-button[data-action="function"][data-function="bar"] {
            font-size: 1.6rem; /* Larger font size to make them stand out */
        }
        
        .action-button.yellow-func { background-color: #ffc107; color: #333; }
        .action-button.purple-func { background-color: #6f42c1; }
        .action-button.bar-func { background-color: #66ff66; color: #333; }

        /* New Order Button Styling */
        .new-order-button {
            background-color: #28a745; /* Green color */
            color: white;
            font-weight: bold;
            font-size: 2rem;
            padding: 1.5rem;
            border-radius: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
            height: 100%; /* Take full height of its container */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .new-order-button:hover {
            background-color: #218838;
        }

        /* Message Box Styling */
        .message-box-overlay, .admin-login-overlay, .live-display-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box, .admin-login-box, .live-display-box {
            background-color: #333;
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 2px solid #555;
        }
        .message-box h3, .admin-login-box h3, .live-display-box h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #ffcc00;
        }
        .message-box p, .admin-login-box p, .live-display-box p {
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        .message-box button, .admin-login-box button, .live-display-box button {
            background-color: #007bff;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .message-box button:hover, .admin-login-box button:hover, .live-display-box button:hover {
            background-color: #0056b3;
        }
        .admin-login-box input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            font-size: 1rem;
        }
        .admin-login-box button {
            margin: 0 10px;
        }
        .live-display-box input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            font-size: 1rem;
            text-align: center;
        }


        /* Admin Configuration Panel Specific Styles */
        .admin-config-panel {
            grid-template-columns: repeat(2, 1fr);
            overflow-y: auto;
        }
        .admin-config-section {
            background-color: #3b3b3b;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        .admin-config-section h4 {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #ffcc00;
        }
        .admin-config-section input, .admin-config-section select {
            width: calc(100% - 20px);
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
        }
        .admin-config-section button {
            background-color: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 5px;
            margin-right: 5px;
        }
        .admin-config-section button.delete {
            background-color: #dc3545;
        }
        .admin-config-section button:hover {
            background-color: #218838;
        }
        .admin-config-section button.delete:hover {
            background-color: #c82333;
        }
        .admin-config-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 5px;
            margin-top: 10px;
        }
        .admin-config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #4a4a4a;
        }
        .admin-config-item:last-child {
            border-bottom: none;
        }
        .admin-config-item button {
            padding: 3px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        /* Admin Main Menu specific styles */
        .admin-main-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            height: 100%; /* Take full height of right-panel */
        }
        .admin-main-menu .menu-button {
            width: 80%;
            max-width: 300px;
            height: 80px;
            font-size: 1.5rem;
            background-color: #007bff;
            color: white;
            border-radius: 1rem;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .admin-main-menu .menu-button:hover {
            background-color: #0056b3;
        }


        /* Wertbon Print Style */
        @media print {
            body * {
                visibility: hidden;
            }
            .wertbon-print-area, .wertbon-print-area * {
                visibility: visible;
            }
            .wertbon-print-area {
                position: relative; /* Changed to relative for stacking */
                left: 0;
                top: 0;
                width: 80mm; /* Common receipt printer width */
                padding: 10mm;
                font-family: 'monospace';
                font-size: 12px;
                line-height: 1.4;
                color: #000;
                box-sizing: border-box;
                page-break-after: always; /* Force a page break after each bon */
            }
            .wertbon-print-area:last-child {
                page-break-after: auto; /* No page break after the very last bon */
            }
            .wertbon-print-area h2, .wertbon-print-area h3 {
                text-align: center;
                margin-bottom: 5px;
            }
            .wertbon-print-area table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            /* Table Headers */
            .wertbon-print-area th {
                padding: 2px 0;
                text-align: left; /* Default left */
                font-weight: bold; /* Make headers bold */
            }
            .wertbon-print-area thead tr {
                border-bottom: 1px solid #000; /* Solid line under header row */
            }
            /* Table Data Cells */
            .wertbon-print-area td {
                padding: 2px 0;
                border-bottom: 1px dashed #ccc; /* Dashed line for items */
            }
            .wertbon-print-area tbody tr:last-child td {
                border-bottom: none; /* No dashed line after the last item if it's not the total */
            }

            /* Column alignments for print */
            .wertbon-print-area th:nth-child(1), .wertbon-print-area td:nth-child(1) { text-align: left; } /* Artikel */
            .wertbon-print-area th:nth-child(2), .wertbon-print-area td:nth-child(2) { text-align: left; } /* Menge */
            .wertbon-print-area th:nth-child(3), .wertbon-print-area td:nth-child(3) { text-align: right; } /* Einzelpreis */
            .wertbon-print-area th:nth-child(4), .wertbon-print-area td:nth-child(4) { text-align: right; } /* Gesamt */

            /* Total Line specific styling */
            .wertbon-print-area .total-line td {
                font-weight: bold;
                border-top: none; /* Override dashed line if present from previous row */
                border-bottom: 2px solid #000; /* Solid line after total */
                padding-top: 5px; /* Spacing above total */
                padding-bottom: 5px; /* Spacing below total */
            }
            .wertbon-print-area .summary-line {
                display: flex;
                justify-content: space-between;
                padding: 2px 0;
                margin-top: 2px; /* Small space after total line */
            }
            .wertbon-print-area .thank-you {
                text-align: center;
                margin-top: 15px;
                font-size: 14px;
                font-weight: bold;
            }
        }
    </style>
</head>
<body>
    <div class="pos-container">
        <div class="header-bar">
            <div class="flex items-center gap-2">
                <span class="user-badge">Frau Becker</span>
                <span id="displayUserId" class="text-sm text-gray-400 ml-2">[UserID: Laden...] (Kat./Prod. Geteilt)</span>
                <button id="liveDisplayLinkBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-full text-sm ml-4">Live Display Link</button>
                <button id="adminLoginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-full text-sm ml-4">Admin Login</button>
                <button id="adminLogoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full text-sm ml-4 hidden">Admin Logout</button>
                <span id="adminModeStatus" class="text-green-400 text-sm ml-2 hidden">Admin-Modus AN</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="status-item">Kasse:</span>
                <select id="cashRegisterSelect" class="bg-gray-700 text-white p-1 rounded">
                    <option value="register1">Kasse 1</option>
                    <option value="register2">Kasse 2</option>
                </select>
                <span class="status-item">RÜCKGELD</span>
                <span id="changeHeader" class="change-display">€0.00</span>
                <span id="currentTime" class="status-item"></span>
                <span id="currentDate" class="status-item"></span>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="order-list-header">
                    <span class="qty">Menge</span>
                    <span class="name">Artikel</span>
                    <span class="price">Preis</span>
                </div>
                <div class="order-list-container" id="orderList">
                    </div>
                <div class="summary-section">
                    <div class="summary-item subtotal">
                        <span>ZWISCHENSUMME</span>
                        <span id="subtotalAmount">€0.00</span>
                    </div>
                    <div class="summary-item total">
                        <span>TOTAL</span>
                        <span id="totalAmount">€0.00</span>
                    </div>
                    <div class="summary-item cash">
                        <span>BAR</span>
                        <span id="cashAmount">€0.00</span>
                    </div>
                    <div class="summary-item change">
                        <span>RÜCKGELD</span>
                        <span id="changeAmount">€0.00</span>
                    </div>
                </div>
            </div>

            <div class="right-panel" id="rightPanel">
                <div id="loadingMessage" class="col-span-4 text-center text-gray-400 text-lg hidden">Lade Daten...</div>
            </div>
        </div>

        <div class="bottom-panel-container">
            <div class="input-display-area">
                <div id="inputDisplay" class="input-display-line">0.00</div>
                <button id="clearInputButton" class="clear-input-button">C</button>
            </div>
            
            <div id="keypadArea" class="bottom-panel">
                <button class="num-button" data-input="7">7</button>
                <button class="num-button" data-input="8">8</button>
                <button class="num-button" data-input="9">9</button>
                <button class="num-button" data-input="0">0</button>
                <button class="action-button yellow-func" data-input="X">X</button>

                <button class="num-button" data-input="4">4</button>
                <button class="num-button" data-input="5">5</button>
                <button class="num-button" data-input="6">6</button>
                <button class="num-button" data-input="00">00</button>
                <button class="action-button purple-func" data-action="function" data-function="zws">ZWS</button>

                <button class="num-button" data-input="1">1</button>
                <button class="num-button" data-input="2">2</button>
                <button class="num-button" data-input="3">3</button>
                <button class="num-button decimal" data-input=".">,</button>
                <button class="action-button bar-func" data-action="function" data-function="bar">BAR</button>
            </div>

            <div id="newOrderArea" class="hidden" style="height: calc(100% - 2.5rem - 0.7rem);">
                <button id="newOrderButton" class="new-order-button">NEUE BESTELLUNG</button>
            </div>
        </div>
    </div>

    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <h3 id="messageBoxTitle">Nachricht</h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxClose">OK</button>
        </div>
    </div>

    <div id="adminLoginOverlay" class="admin-login-overlay hidden">
        <div class="admin-login-box">
            <h3>Admin Login</h3>
            <input type="text" id="adminUsername" placeholder="Benutzername" value="admin">
            <input type="password" id="adminPassword" placeholder="Passwort" value="admin123">
            <button id="loginBtn">Login</button>
            <button id="cancelLoginBtn">Abbrechen</button>
        </div>
    </div>

    <div id="liveDisplayOverlay" class="live-display-overlay hidden">
        <div class="live-display-box">
            <h3>Live Display Link</h3>
            <p>Öffne diesen Link auf dem zweiten iPad:</p>
            <input type="text" id="liveDisplayUrl" readonly>
            <button id="copyLiveDisplayUrlBtn">Link kopieren</button>
            <button id="closeLiveDisplayBtn">Schließen</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase app and services
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous until authenticated
        let currentRegisterId = 'register1'; // Default cash register

        // Firebase Configuration - REPLACE with your actual Firebase project config
        const firebaseConfig = {
          apiKey: "AIzaSyAyO_3QNTZq2IOdvBMm6ZLHYFv96H9F50I",
          authDomain: "verkaufssoftware.firebaseapp.com",
          projectId: "verkaufssoftware",
          storageBucket: "verkaufssoftware.firebasestorage.app",
          messagingSenderId: "268747007466",
          appId: "1:268747007466:web:c84a529f27a0f6849a3e93",
          measurementId: "G-RMX5KJK543"
        };
        // For GitHub deployment, use your projectId as appId
        const appId = firebaseConfig.projectId;


        // DOM Elements
        const orderList = document.getElementById('orderList');
        const subtotalAmount = document.getElementById('subtotalAmount');
        const totalAmount = document.getElementById('totalAmount');
        const cashAmount = document.getElementById('cashAmount');
        const changeAmount = document.getElementById('changeAmount');
        const changeHeader = document.getElementById('changeHeader');
        const currentDateElem = document.getElementById('currentDate');
        const currentTimeElem = document.getElementById('currentTime');
        const displayUserId = document.getElementById('displayUserId'); // New: Element to display userId
        const cashRegisterSelect = document.getElementById('cashRegisterSelect'); // New: Register selection

        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxClose = document.getElementById('messageBoxClose');

        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const adminModeStatus = document.getElementById('adminModeStatus');
        const adminLoginOverlay = document.getElementById('adminLoginOverlay');
        const adminUsernameInput = document.getElementById('adminUsername');
        const adminPasswordInput = document.getElementById('adminPassword');
        const loginBtn = document.getElementById('loginBtn');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn'); 

        const rightPanel = document.getElementById('rightPanel');
        const inputDisplay = document.getElementById('inputDisplay'); // Input display element
        const clearInputButton = document.getElementById('clearInputButton'); // New C button

        const keypadArea = document.getElementById('keypadArea'); // Numeric keypad and function buttons area
        const newOrderArea = document.getElementById('newOrderArea'); // "Neue Bestellung" button area
        const newOrderButton = document.getElementById('newOrderButton'); // The "Neue Bestellung" button

        // Live Display Elements
        const liveDisplayLinkBtn = document.getElementById('liveDisplayLinkBtn');
        const liveDisplayOverlay = document.getElementById('liveDisplayOverlay');
        const liveDisplayUrlInput = document.getElementById('liveDisplayUrl');
        const copyLiveDisplayUrlBtn = document.getElementById('copyLiveDisplayUrlBtn');
        const closeLiveDisplayBtn = document.getElementById('closeLiveDisplayBtn');
        const loadingMessage = document.getElementById('loadingMessage'); // Loading message


        // State variables
        let currentOrder = [];
        let currentInput = ''; // Initialize as empty string to allow natural number input
        let multiplier = 1;
        let cashGiven = 0;
        let isAdminMode = false;
        let currentCategory = null; // Stores the currently selected category for product display
        let currentAdminView = 'main'; // Tracks the current admin view: 'main', 'categories', 'products', 'sellers'

        // POS Data (now dynamically loaded from Firebase)
        let posData = {
            "categories": [],
            "products": {}, // Products will be grouped by category ID in this object
            "sellers": [] // New: Array to store seller data
        };

        // State to track if Firestore listeners have been set up
        let firestoreListenersSetup = false;

        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            try {
                if (firebaseConfig && Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    console.log("Firebase initialized.");

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            displayUserId.textContent = `[UserID: ${userId}] (Kat./Prod. Geteilt)`;
                            console.log("User authenticated. Current userId:", userId);
                            if (!firestoreListenersSetup) {
                                console.log("Authentication successful, calling setupFirestoreListeners.");
                                setupFirestoreListeners();
                                firestoreListenersSetup = true;
                            }
                        } else {
                            if (!firestoreListenersSetup) {
                                try {
                                    console.log("No user signed in, attempting signInAnonymously...");
                                    await signInAnonymously(auth);
                                } catch (anonSignInError) {
                                    console.error("Anonymous sign-in failed:", anonSignInError);
                                    userId = 'anonymous_fallback';
                                    displayUserId.textContent = `[UserID: ${userId} (Fehler)] (Kat./Prod. Geteilt)`;
                                    console.warn("Authentication failed, proceeding without persistent data storage for categories/products/sellers.");
                                    renderCategories(); // Still try to render in case of cached data or for UI consistency
                                    renderOrder();
                                    inputDisplay.textContent = formatInputDisplay(currentInput);
                                    firestoreListenersSetup = true;
                                }
                            }
                        }
                    });
                } else {
                    console.warn("Firebase configuration not provided or incomplete. Data will not be persisted.");
                    displayUserId.textContent = `[UserID: Nicht konfiguriert] (Kat./Prod. Geteilt)`;
                    renderCategories();
                    renderOrder();
                    inputDisplay.textContent = formatInputDisplay(currentInput);
                }
            } catch (error) {
                console.error("Fatal error during Firebase app initialization:", error);
                showMessageBox('Fehler', 'Schwerwiegender Fehler beim Initialisieren von Firebase. Die App wird ohne Datenspeicherung gestartet.');
                displayUserId.textContent = `[UserID: Fehler] (Kat./Prod. Geteilt)`;
                renderCategories();
                renderOrder();
                inputDisplay.textContent = formatInputDisplay(currentInput);
            }
        }

        // --- Firestore Data Listeners ---
        function setupFirestoreListeners() {
            if (!db || !auth.currentUser || auth.currentUser.uid === 'anonymous_fallback') {
                console.warn("Firestore, current user, or valid user ID not available at listener setup. Aborting listener setup.");
                loadingMessage.classList.add('hidden');
                return;
            }
            const currentAuthedUserId = auth.currentUser.uid;
            console.log("Proceeding with Firestore listeners. Auth User ID:", currentAuthedUserId);
            loadingMessage.classList.remove('hidden');
            rightPanel.innerHTML = ''; // Clear right panel content temporarily

            // Listener for Categories (Public/Shared)
            const categoriesRef = collection(db, `artifacts/${appId}/public/data/categories`);
            onSnapshot(categoriesRef, (snapshot) => {
                const fetchedCategories = [];
                snapshot.forEach(doc => {
                    fetchedCategories.push({ id: doc.id, ...doc.data() });
                });
                posData.categories = fetchedCategories;
                console.log("onSnapshot for categories triggered. Fetched categories:", fetchedCategories);
                if (!isAdminMode) {
                    renderCategories();
                } else {
                    if (currentAdminView === 'categories') {
                        console.log("Calling renderAdminCategoryManagement due to category snapshot update.");
                        renderAdminCategoryManagement();
                    } else if (currentAdminView === 'products') {
                        console.log("Calling renderAdminProductManagement due to category snapshot update (for dropdown).");
                        renderAdminProductManagement();
                    }
                }
                loadingMessage.classList.add('hidden');
            }, (error) => {
                console.error("Error fetching categories:", error);
                showMessageBox('Fehler', 'Kategorien konnten nicht geladen werden.');
                loadingMessage.classList.add('hidden');
            });

            // Listener for Products (Public/Shared)
            const productsRef = collection(db, `artifacts/${appId}/public/data/products`);
            onSnapshot(productsRef, (snapshot) => {
                const fetchedProducts = {};
                snapshot.forEach(doc => {
                    const productData = doc.data();
                    if (productData.categoryId) {
                        if (!fetchedProducts[productData.categoryId]) {
                            fetchedProducts[productData.categoryId] = [];
                        }
                        fetchedProducts[productData.categoryId].push({ id: doc.id, name: productData.name, price: productData.price });
                    }
                });
                posData.products = fetchedProducts;
                console.log("onSnapshot for products triggered. Fetched products:", fetchedProducts);
                if (!isAdminMode) {
                    if (currentCategory) {
                        renderProducts(currentCategory);
                    } else {
                        renderCategories(); // Re-render categories to ensure product counts are updated if displayed
                    }
                } else {
                    if (currentAdminView === 'products') {
                        console.log("Calling renderAdminProductManagement due to product snapshot update.");
                        renderAdminProductManagement();
                    }
                }
                loadingMessage.classList.add('hidden');
            }, (error) => {
                console.error("Error fetching products:", error);
                showMessageBox('Fehler', 'Produkte konnten nicht geladen werden.');
                loadingMessage.classList.add('hidden');
            });

            // Listener for Sellers (Private/User-specific)
            const sellersRef = collection(db, `artifacts/${appId}/users/${currentAuthedUserId}/sellers`);
            onSnapshot(sellersRef, (snapshot) => {
                const fetchedSellers = [];
                snapshot.forEach(doc => {
                    fetchedSellers.push({ id: doc.id, ...doc.data() });
                });
                posData.sellers = fetchedSellers;
                console.log("onSnapshot for sellers triggered. Fetched sellers:", fetchedSellers);
                if (isAdminMode && currentAdminView === 'sellers') {
                    console.log("Calling renderAdminSellerManagement due to seller snapshot update.");
                    renderAdminSellerManagement();
                }
                loadingMessage.classList.add('hidden');
            }, (error) => {
                console.error("Error fetching sellers:", error);
                showMessageBox('Fehler', 'Verkäufer konnten nicht geladen werden.');
                loadingMessage.classList.add('hidden');
            });
        }

        // --- Firebase Data Operations (CRUD) ---

        /**
         * Saves the current order for live display on a second screen.
         * This data is public, but now separated by register ID.
         */
        async function saveLiveOrderToFirestore() {
            if (!db || !auth.currentUser) {
                console.warn("Firestore or user not authenticated. Live order cannot be saved.");
                return;
            }
            try {
                // Combine relevant order data for display
                const orderToSave = {
                    items: currentOrder.map(item => ({ name: item.name, quantity: item.quantity, price: item.price })),
                    subtotal: parseFloat(subtotalAmount.textContent.replace('€', '')),
                    total: parseFloat(totalAmount.textContent.replace('€', '')),
                    timestamp: Date.now() // Add a timestamp for freshness
                };
                // Save to a fixed public document, incorporating the currentRegisterId
                const liveOrderDocRef = doc(db, `artifacts/${appId}/public/data/liveOrders`, currentRegisterId);
                await setDoc(liveOrderDocRef, orderToSave);
                console.log(`Live order for ${currentRegisterId} saved to Firestore:`, orderToSave);
            } catch (e) {
                console.error("Error saving live order:", e);
            }
        }

        /**
         * Adds or updates a category in Firestore (Public/Shared).
         * @param {object} category - { id, name, color, standName }
         */
        async function saveCategoryToFirestore(category) {
            if (!db || !auth.currentUser) {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Kategoriedaten können nicht gespeichert werden.');
                return;
            }
            try {
                console.log("Attempting to save category:", category, "to public Firestore path.");
                const categoryDocRef = doc(db, `artifacts/${appId}/public/data/categories`, category.id);
                await setDoc(categoryDocRef, category, { merge: true }); // Use merge to avoid overwriting entire document
                showMessageBox('Erfolg', `Kategorie "${category.name}" gespeichert.`);
            } catch (e) {
                console.error("Error saving category:", e);
                showMessageBox('Fehler', 'Fehler beim Speichern der Kategorie: ' + e.message);
            }
        }

        /**
         * Deletes a category from Firestore (Public/Shared).
         * @param {string} categoryId
         */
        async function deleteCategoryFromFirestore(categoryId) {
            if (!db || !auth.currentUser) {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Kategoriedaten können nicht gelöscht werden.');
                return;
            }
            try {
                // First, find and delete all products associated with this category
                const productsToDeleteQuery = query(collection(db, `artifacts/${appId}/public/data/products`), where("categoryId", "==", categoryId));
                const productSnapshot = await getDocs(productsToDeleteQuery);
                const deleteProductPromises = [];
                productSnapshot.forEach((productDoc) => {
                    deleteProductPromises.push(deleteDoc(doc(db, `artifacts/${appId}/public/data/products`, productDoc.id)));
                });
                await Promise.all(deleteProductPromises);
                console.log(`Deleted all products for category ${categoryId}.`);

                // Then delete the category itself
                const categoryDocRef = doc(db, `artifacts/${appId}/public/data/categories`, categoryId);
                await deleteDoc(categoryDocRef);
                showMessageBox('Erfolg', 'Kategorie und zugehörige Produkte gelöscht.');
            } catch (e) {
                console.error("Error deleting category:", e);
                showMessageBox('Fehler', 'Fehler beim Löschen der Kategorie: ' + e.message);
            }
        }

        /**
         * Adds or updates a product in Firestore (Public/Shared).
         * @param {object} product - { id, categoryId, name, price }
         */
        async function saveProductToFirestore(product) {
            if (!db || !auth.currentUser) {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Produktdaten können nicht gespeichert werden.');
                return;
            }
            try {
                console.log("Attempting to save product:", product, "to public Firestore path.");
                const productDocRef = doc(db, `artifacts/${appId}/public/data/products`, product.id);
                await setDoc(productDocRef, product, { merge: true });
                showMessageBox('Erfolg', `Produkt "${product.name}" gespeichert.`);
            } catch (e) {
                console.error("Error saving product:", e);
                showMessageBox('Fehler', 'Fehler beim Speichern des Produkts: ' + e.message);
            }
        }

        /**
         * Deletes a product from Firestore (Public/Shared).
         * @param {string} productId
         */
        async function deleteProductFromFirestore(productId) {
            if (!db || !auth.currentUser) {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Produktdaten können nicht gelöscht werden.');
                return;
            }
            try {
                const productDocRef = doc(db, `artifacts/${appId}/public/data/products`, productId);
                await deleteDoc(productDocRef);
                showMessageBox('Erfolg', 'Produkt gelöscht.');
            } catch (e) {
                console.error("Error deleting product:", e);
                showMessageBox('Fehler', 'Fehler beim Löschen des Produkts: ' + e.message);
            }
        }

        /**
         * Adds or updates a seller in Firestore (Private/User-specific).
         * @param {object} seller - { id, name }
         */
        async function saveSellerToFirestore(seller) {
            if (!db || !auth.currentUser) {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Verkäuferdaten können nicht gespeichert werden.');
                return;
            }
            try {
                const sellerDocRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/sellers`, seller.id);
                await setDoc(sellerDocRef, seller, { merge: true });
                showMessageBox('Erfolg', `Verkäufer "${seller.name}" gespeichert.`);
            } catch (e) {
                console.error("Error saving seller:", e);
                showMessageBox('Fehler', 'Fehler beim Speichern des Verkäufers: ' + e.message);
            }
        }

        /**
         * Deletes a seller from Firestore (Private/User-specific).
         * @param {string} sellerId
         */
        async function deleteSellerFromFirestore(sellerId) {
            if (!db || !auth.currentUser) {
                showMessageBox('Fehler', 'Datenbank ist nicht bereit oder Sie sind nicht authentifiziert. Verkäuferdaten können nicht gelöscht werden.');
                return;
            }
            try {
                const sellerDocRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/sellers`, sellerId);
                await deleteDoc(sellerDocRef);
                showMessageBox('Erfolg', 'Verkäufer gelöscht.');
            } catch (e) {
                console.error("Error deleting seller:", e);
                showMessageBox('Fehler', 'Fehler beim Löschen des Verkäufers: ' + e.message);
            }
        }

        // --- Core POS Logic ---

        /**
         * Adds a product to the current order.
         * @param {string} productName
         * @param {number} productPrice
         */
        function addProductToOrder(productName, productPrice) {
            const existingItemIndex = currentOrder.findIndex(item => item.name === productName);
            if (existingItemIndex > -1) {
                currentOrder[existingItemIndex].quantity += multiplier;
            } else {
                currentOrder.push({ name: productName, price: productPrice, quantity: multiplier });
            }
            multiplier = 1; // Reset multiplier after use
            currentInput = ''; // Clear input after adding product
            inputDisplay.textContent = formatInputDisplay(currentInput);
            renderOrder();
            saveLiveOrderToFirestore(); // Update live display
        }

        /**
         * Removes or decreases quantity of an item in the order.
         * @param {number} index
         */
        function removeItemFromOrder(index) {
            if (currentOrder[index].quantity > 1) {
                currentOrder[index].quantity--;
            } else {
                currentOrder.splice(index, 1);
            }
            renderOrder();
            saveLiveOrderToFirestore(); // Update live display
        }

        /**
         * Renders the current order list and updates totals.
         */
        function renderOrder() {
            orderList.innerHTML = '';
            let subtotal = 0;
            currentOrder.forEach((item, index) => {
                const listItem = document.createElement('div');
                listItem.classList.add('order-item');
                listItem.innerHTML = `
                    <span class="qty">${item.quantity}x</span>
                    <span class="name">${item.name}</span>
                    <span class="price">€${(item.quantity * item.price).toFixed(2)}</span>
                `;
                listItem.addEventListener('click', () => removeItemFromOrder(index)); // Make item clickable to remove/decrease
                orderList.appendChild(listItem);
                subtotal += item.quantity * item.price;
            });

            subtotalAmount.textContent = `€${subtotal.toFixed(2)}`;
            totalAmount.textContent = `€${subtotal.toFixed(2)}`; // Total is initially subtotal
            cashAmount.textContent = `€${cashGiven.toFixed(2)}`;
            updateChange(); // Update change based on new total/cash
        }

        /**
         * Updates the change amount displayed.
         */
        function updateChange() {
            const total = parseFloat(totalAmount.textContent.replace('€', ''));
            const change = cashGiven - total;
            changeAmount.textContent = `€${Math.max(0, change).toFixed(2)}`;
            changeHeader.textContent = `€${Math.max(0, change).toFixed(2)}`;
        }

        /**
         * Processes the payment and prints a receipt.
         */
        function processPayment() {
            if (currentOrder.length === 0) {
                showMessageBox('Hinweis', 'Die Bestellung ist leer.');
                return;
            }

            const total = parseFloat(totalAmount.textContent.replace('€', ''));
            if (cashGiven < total) {
                showMessageBox('Hinweis', 'Der gegebene Betrag ist zu gering.');
                return;
            }

            printReceipt(currentOrder, total, cashGiven, parseFloat(changeAmount.textContent.replace('€', '')));
            
            // Clear order and reset state after successful payment
            currentOrder = [];
            currentInput = ''; // Reset input to empty
            multiplier = 1;
            cashGiven = 0;
            renderOrder();
            inputDisplay.textContent = formatInputDisplay(currentInput);
            saveLiveOrderToFirestore(); // Clear live display
            showNewOrderButton();
            showMessageBox('Erfolg', 'Bestellung abgeschlossen und Bon gedruckt.');
        }

        /**
         * Generates and prints the receipt.
         * @param {Array<Object>} orderItems - The list of items in the order.
         * @param {number} total - The total amount.
         * @param {number} cash - The cash given.
         * @param {number} change - The change amount.
         */
        function printReceipt(orderItems, total, cash, change) {
            const receiptWindow = window.open('', '_blank');
            const receiptHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Bon</title>
                    <style>
                        body { font-family: 'monospace'; font-size: 12px; line-height: 1.4; color: #000; }
                        .wertbon-print-area { width: 80mm; padding: 10mm; box-sizing: border-box; }
                        h2, h3 { text-align: center; margin-bottom: 5px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }

                        /* Table Headers */
                        th {
                            padding: 2px 0;
                            text-align: left; /* Default left */
                            font-weight: bold; /* Make headers bold */
                        }
                        thead tr {
                            border-bottom: 1px solid #000; /* Solid line under header row */
                        }

                        /* Table Data Cells */
                        td {
                            padding: 2px 0;
                            border-bottom: 1px dashed #ccc; /* Dashed line for items */
                        }
                        tbody tr:last-child td {
                            border-bottom: none; /* No dashed line after the last item if it's not the total */
                        }

                        /* Column alignments */
                        th:nth-child(1), td:nth-child(1) { text-align: left; } /* Artikel */
                        th:nth-child(2), td:nth-child(2) { text-align: left; } /* Menge */
                        th:nth-child(3), td:nth-child(3) { text-align: right; } /* Einzelpreis */
                        th:nth-child(4), td:nth-child(4) { text-align: right; } /* Gesamt */

                        /* Total Line specific styling */
                        .total-line td {
                            font-weight: bold;
                            border-top: none; /* Override dashed line if present from previous row */
                            border-bottom: 2px solid #000; /* Solid line after total */
                            padding-top: 5px; /* Spacing above total */
                            padding-bottom: 5px; /* Spacing below total */
                        }
                        .summary-line {
                            display: flex;
                            justify-content: space-between;
                            padding: 2px 0;
                            margin-top: 2px; /* Small space after total line */
                        }
                        .thank-you {
                            text-align: center;
                            margin-top: 15px;
                            font-size: 14px;
                            font-weight: bold;
                        }
                    </style>
                </head>
                <body>
                    <div class="wertbon-print-area">
                        <h2>*** KASSENBON ***</h2>
                        <h3>Schulfest 28.07.2025</h3>
                        <p>Kasse: ${currentRegisterId.replace('register', 'Kasse ')}</p>
                        <p>Datum: ${currentDateElem.textContent}</p>
                        <p>Uhrzeit: ${currentTimeElem.textContent}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Artikel</th>
                                    <th>Menge</th>
                                    <th>Einzelpreis</th>
                                    <th>Gesamt</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${orderItems.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>€${item.price.toFixed(2)}</td>
                                        <td>€${(item.quantity * item.price).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                                <tr class="total-line">
                                    <td colspan="3">TOTAL</td>
                                    <td>€${total.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="summary-line">
                            <span>Gegeben:</span>
                            <span>€${cash.toFixed(2)}</span>
                        </div>
                        <div class="summary-line">
                            <span>Rückgeld:</span>
                            <span>€${change.toFixed(2)}</span>
                        </div>
                        <p class="thank-you">Vielen Dank für Ihren Einkauf!</p>
                    </div>
                </body>
                </html>
            `;
            receiptWindow.document.write(receiptHtml);
            receiptWindow.document.close();
            receiptWindow.print();
            receiptWindow.close();
        }

        // --- Render Functions (UI Updates) ---

        /**
         * Formats the current input string for display.
         * Ensures two decimal places when a decimal point is present or when clearing.
         */
        function formatInputDisplay(input) {
            if (input === '') {
                return '0.00';
            }
            if (input.includes('.')) {
                return input; // Display as is while typing decimals
            }
            // If no decimal, just display the number as is (e.g., "1", "123")
            // Convert to number and then to string to handle leading zeros correctly for integers (e.g., "01" -> "1")
            return parseFloat(input).toString();
        }

        /**
         * Renders product categories as buttons.
         */
        function renderCategories() {
            rightPanel.innerHTML = '';
            rightPanel.classList.remove('admin-config-panel'); // Ensure correct grid for products/categories
            rightPanel.classList.add('grid');
            loadingMessage.classList.add('hidden'); // Hide loading message once data is rendered

            if (posData.categories.length === 0) {
                rightPanel.innerHTML = `<p class="col-span-4 text-center text-gray-400 text-lg">Keine Kategorien verfügbar. Bitte im Admin-Modus hinzufügen.</p>`;
                return;
            }

            posData.categories.forEach(category => {
                const button = document.createElement('button');
                button.classList.add('product-button', category.color || 'gray');
                button.textContent = category.name;
                button.addEventListener('click', () => {
                    currentCategory = category;
                    renderProducts(category);
                });
                rightPanel.appendChild(button);
            });
        }

        /**
         * Renders products for a given category.
         * @param {object} category
         */
        function renderProducts(category) {
            rightPanel.innerHTML = '';
            rightPanel.classList.remove('admin-config-panel');
            rightPanel.classList.add('grid');

            // Add a "Back to Categories" button
            const backButton = document.createElement('button');
            backButton.classList.add('product-button', 'gray', 'col-span-4'); // Make it span all columns
            backButton.textContent = `← Zurück zu Kategorien`;
            backButton.addEventListener('click', () => {
                currentCategory = null;
                renderCategories();
            });
            rightPanel.appendChild(backButton);

            const productsInCategory = posData.products[category.id] || [];
            if (productsInCategory.length === 0) {
                const noProductsMessage = document.createElement('p');
                noProductsMessage.classList.add('col-span-4', 'text-center', 'text-gray-400', 'text-lg');
                noProductsMessage.textContent = `Keine Produkte in Kategorie "${category.name}".`;
                rightPanel.appendChild(noProductsMessage);
            } else {
                productsInCategory.sort((a, b) => a.name.localeCompare(b.name)); // Sort products alphabetically
                productsInCategory.forEach(product => {
                    const button = document.createElement('button');
                    button.classList.add('product-button');
                    button.textContent = `${product.name} (€${product.price.toFixed(2)})`;
                    button.addEventListener('click', () => addProductToOrder(product.name, product.price));
                    rightPanel.appendChild(button);
                });
            }
        }

        /**
         * Displays the message box.
         * @param {string} title
         * @param {string} content
         */
        function showMessageBox(title, content) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = content;
            messageBoxOverlay.classList.remove('hidden');
        }

        /**
         * Hides the message box.
         */
        function hideMessageBox() {
            messageBoxOverlay.classList.add('hidden');
        }

        /**
         * Shows the "Neue Bestellung" button and hides the keypad.
         */
        function showNewOrderButton() {
            keypadArea.classList.add('hidden');
            newOrderArea.classList.remove('hidden');
        }

        /**
         * Shows the keypad and hides the "Neue Bestellung" button.
         */
        function showKeypad() {
            keypadArea.classList.remove('hidden');
            newOrderArea.classList.add('hidden');
        }

        // --- Admin Mode Functions ---

        /**
         * Enters admin mode.
         */
        function enterAdminMode() {
            isAdminMode = true;
            adminLoginBtn.classList.add('hidden');
            adminLogoutBtn.classList.remove('hidden');
            adminModeStatus.classList.remove('hidden');
            renderAdminMainMenu();
        }

        /**
         * Exits admin mode.
         */
        function exitAdminMode() {
            isAdminMode = false;
            adminLoginBtn.classList.remove('hidden');
            adminLogoutBtn.classList.add('hidden');
            adminModeStatus.classList.add('hidden');
            currentAdminView = 'main'; // Reset admin view
            renderCategories(); // Go back to normal product view
        }

        /**
         * Renders the admin main menu.
         */
        function renderAdminMainMenu() {
            rightPanel.innerHTML = `
                <div class="admin-main-menu col-span-4">
                    <button class="menu-button" id="manageCategoriesBtn">Kategorien verwalten</button>
                    <button class="menu-button" id="manageProductsBtn">Produkte verwalten</button>
                    <button class="menu-button" id="manageSellersBtn">Verkäufer verwalten</button>
                    <button class="menu-button bg-red-500 hover:bg-red-600" id="exitAdminMenuBtn">Admin-Modus verlassen</button>
                </div>
            `;
            document.getElementById('manageCategoriesBtn').addEventListener('click', () => {
                currentAdminView = 'categories';
                renderAdminCategoryManagement();
            });
            document.getElementById('manageProductsBtn').addEventListener('click', () => {
                currentAdminView = 'products';
                renderAdminProductManagement();
            });
            document.getElementById('manageSellersBtn').addEventListener('click', () => {
                currentAdminView = 'sellers';
                renderAdminSellerManagement();
            });
            document.getElementById('exitAdminMenuBtn').addEventListener('click', exitAdminMode);
        }

        /**
         * Renders the category management interface.
         */
        function renderAdminCategoryManagement() {
            rightPanel.innerHTML = `
                <div class="admin-config-panel col-span-4">
                    <div class="admin-config-section">
                        <h4>Kategorie hinzufügen/bearbeiten</h4>
                        <input type="hidden" id="categoryIdInput">
                        <input type="text" id="categoryNameInput" placeholder="Kategoriename">
                        <select id="categoryColorSelect">
                            <option value="">Farbe auswählen</option>
                            <option value="yellow">Gelb</option>
                            <option value="orange">Orange</option>
                            <option value="purple">Lila</option>
                            <option value="green">Grün</option>
                            <option value="blue">Blau</option>
                            <option value="red">Rot</option>
                            <option value="light-blue">Hellblau</option>
                            <option value="pink">Pink</option>
                            <option value="gray">Grau</option>
                        </select>
                        <input type="text" id="categoryStandNameInput" placeholder="Standname (optional)">
                        <button id="saveCategoryBtn">Speichern</button>
                        <button id="cancelEditCategoryBtn" class="bg-gray-500 hidden">Abbrechen</button>
                    </div>
                    <div class="admin-config-section">
                        <h4>Vorhandene Kategorien</h4>
                        <div id="categoryList" class="admin-config-list">
                            </div>
                    </div>
                    <button class="menu-button bg-gray-500 hover:bg-gray-600 col-span-4" id="backToAdminMenuBtn">← Zurück zum Admin-Menü</button>
                </div>
            `;

            const categoryIdInput = document.getElementById('categoryIdInput');
            const categoryNameInput = document.getElementById('categoryNameInput');
            const categoryColorSelect = document.getElementById('categoryColorSelect');
            const categoryStandNameInput = document.getElementById('categoryStandNameInput');
            const saveCategoryBtn = document.getElementById('saveCategoryBtn');
            const cancelEditCategoryBtn = document.getElementById('cancelEditCategoryBtn');
            const categoryList = document.getElementById('categoryList');
            document.getElementById('backToAdminMenuBtn').addEventListener('click', renderAdminMainMenu);

            function populateCategoryList() {
                categoryList.innerHTML = '';
                posData.categories.forEach(category => {
                    const item = document.createElement('div');
                    item.classList.add('admin-config-item');
                    item.innerHTML = `
                        <span>${category.name} (${category.color})</span>
                        <div>
                            <button data-id="${category.id}" class="edit-category-btn bg-blue-500 hover:bg-blue-600">Bearbeiten</button>
                            <button data-id="${category.id}" class="delete-category-btn delete">Löschen</button>
                        </div>
                    `;
                    categoryList.appendChild(item);
                });

                document.querySelectorAll('.edit-category-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const categoryToEdit = posData.categories.find(c => c.id === id);
                        if (categoryToEdit) {
                            categoryIdInput.value = categoryToEdit.id;
                            categoryNameInput.value = categoryToEdit.name;
                            categoryColorSelect.value = categoryToEdit.color || '';
                            categoryStandNameInput.value = categoryToEdit.standName || '';
                            cancelEditCategoryBtn.classList.remove('hidden');
                            saveCategoryBtn.textContent = 'Aktualisieren';
                        }
                    });
                });

                document.querySelectorAll('.delete-category-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        if (confirm('Sicher, dass Sie diese Kategorie und alle zugehörigen Produkte löschen möchten?')) {
                            deleteCategoryFromFirestore(id);
                        }
                    });
                });
            }

            saveCategoryBtn.addEventListener('click', () => {
                const id = categoryIdInput.value || doc(collection(db, `artifacts/${appId}/public/data/categories`)).id; // Generate new ID if not editing
                const name = categoryNameInput.value.trim();
                const color = categoryColorSelect.value;
                const standName = categoryStandNameInput.value.trim();

                if (!name) {
                    showMessageBox('Fehler', 'Kategoriename darf nicht leer sein.');
                    return;
                }
                saveCategoryToFirestore({ id, name, color, standName });
                categoryIdInput.value = '';
                categoryNameInput.value = '';
                categoryColorSelect.value = '';
                categoryStandNameInput.value = '';
                cancelEditCategoryBtn.classList.add('hidden');
                saveCategoryBtn.textContent = 'Speichern';
            });

            cancelEditCategoryBtn.addEventListener('click', () => {
                categoryIdInput.value = '';
                categoryNameInput.value = '';
                categoryColorSelect.value = '';
                categoryStandNameInput.value = '';
                cancelEditCategoryBtn.classList.add('hidden');
                saveCategoryBtn.textContent = 'Speichern';
            });

            populateCategoryList(); // Initial population
        }

        /**
         * Renders the product management interface.
         */
        function renderAdminProductManagement() {
            rightPanel.innerHTML = `
                <div class="admin-config-panel col-span-4">
                    <div class="admin-config-section">
                        <h4>Produkt hinzufügen/bearbeiten</h4>
                        <input type="hidden" id="productIdInput">
                        <select id="productCategorySelect">
                            <option value="">Kategorie auswählen</option>
                        </select>
                        <input type="text" id="productNameInput" placeholder="Produktname">
                        <input type="number" id="productPriceInput" placeholder="Preis (€)" step="0.01">
                        <button id="saveProductBtn">Speichern</button>
                        <button id="cancelEditProductBtn" class="bg-gray-500 hidden">Abbrechen</button>
                    </div>
                    <div class="admin-config-section">
                        <h4>Vorhandene Produkte</h4>
                        <div id="productList" class="admin-config-list">
                            </div>
                    </div>
                    <button class="menu-button bg-gray-500 hover:bg-gray-600 col-span-4" id="backToAdminMenuBtn">← Zurück zum Admin-Menü</button>
                </div>
            `;

            const productIdInput = document.getElementById('productIdInput');
            const productCategorySelect = document.getElementById('productCategorySelect');
            const productNameInput = document.getElementById('productNameInput');
            const productPriceInput = document.getElementById('productPriceInput');
            const saveProductBtn = document.getElementById('saveProductBtn');
            const cancelEditProductBtn = document.getElementById('cancelEditProductBtn');
            const productList = document.getElementById('productList');
            document.getElementById('backToAdminMenuBtn').addEventListener('click', renderAdminMainMenu);

            // Populate category dropdown
            productCategorySelect.innerHTML = '<option value="">Kategorie auswählen</option>'; // Clear existing and add default
            posData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                productCategorySelect.appendChild(option);
            });

            function populateProductList() {
                productList.innerHTML = '';
                // Iterate through products grouped by category
                // Sort categories by name for consistent display
                const sortedCategories = [...posData.categories].sort((a, b) => a.name.localeCompare(b.name));

                if (sortedCategories.length === 0) {
                    productList.innerHTML = '<p class="text-center text-gray-500 mt-4">Bitte zuerst Kategorien hinzufügen.</p>';
                    return;
                }

                sortedCategories.forEach(category => {
                    const categoryId = category.id;
                    const categoryName = category.name;
                    const categoryHeader = document.createElement('h5');
                    categoryHeader.classList.add('font-bold', 'text-sm', 'mt-2', 'mb-1', 'text-yellow-300'); // Highlight category name
                    categoryHeader.textContent = categoryName;
                    productList.appendChild(categoryHeader);

                    const productsInCategory = posData.products[categoryId] || [];
                    if (productsInCategory.length === 0) {
                        const noProductsMessage = document.createElement('p');
                        noProductsMessage.classList.add('text-sm', 'text-gray-500', 'ml-4', 'mb-2');
                        noProductsMessage.textContent = `(Keine Produkte in dieser Kategorie)`;
                        productList.appendChild(noProductsMessage);
                    } else {
                        productsInCategory.sort((a, b) => a.name.localeCompare(b.name)).forEach(product => {
                            const item = document.createElement('div');
                            item.classList.add('admin-config-item');
                            item.innerHTML = `
                                <span>${product.name} (€${product.price.toFixed(2)})</span>
                                <div>
                                    <button data-id="${product.id}" class="edit-product-btn bg-blue-500 hover:bg-blue-600">Bearbeiten</button>
                                    <button data-id="${product.id}" class="delete-product-btn delete">Löschen</button>
                                </div>
                            `;
                            productList.appendChild(item);
                        });
                    }
                });
                

                document.querySelectorAll('.edit-product-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        // Find product across all categories
                        let productToEdit = null;
                        for (const catId in posData.products) {
                            productToEdit = posData.products[catId].find(p => p.id === id);
                            if (productToEdit) break;
                        }

                        if (productToEdit) {
                            productIdInput.value = productToEdit.id;
                            productCategorySelect.value = productToEdit.categoryId;
                            productNameInput.value = productToEdit.name;
                            productPriceInput.value = productToEdit.price;
                            cancelEditProductBtn.classList.remove('hidden');
                            saveProductBtn.textContent = 'Aktualisieren';
                        }
                    });
                });

                document.querySelectorAll('.delete-product-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        if (confirm('Sicher, dass Sie dieses Produkt löschen möchten?')) {
                            deleteProductFromFirestore(id);
                        }
                    });
                });
            }

            saveProductBtn.addEventListener('click', () => {
                const id = productIdInput.value || doc(collection(db, `artifacts/${appId}/public/data/products`)).id;
                const categoryId = productCategorySelect.value;
                const name = productNameInput.value.trim();
                const price = parseFloat(productPriceInput.value);

                if (!categoryId) {
                    showMessageBox('Fehler', 'Bitte wählen Sie eine Kategorie aus.');
                    return;
                }
                if (!name) {
                    showMessageBox('Fehler', 'Produktname darf nicht leer sein.');
                    return;
                }
                if (isNaN(price) || price <= 0) {
                    showMessageBox('Fehler', 'Preis muss eine positive Zahl sein.');
                    return;
                }

                saveProductToFirestore({ id, categoryId, name, price });
                productIdInput.value = '';
                productCategorySelect.value = '';
                productNameInput.value = '';
                productPriceInput.value = '';
                cancelEditProductBtn.classList.add('hidden');
                saveProductBtn.textContent = 'Speichern';
            });

            cancelEditProductBtn.addEventListener('click', () => {
                productIdInput.value = '';
                productCategorySelect.value = '';
                productNameInput.value = '';
                productPriceInput.value = '';
                cancelEditProductBtn.classList.add('hidden');
                saveProductBtn.textContent = 'Speichern';
            });

            populateProductList(); // Initial population
        }

        /**
         * Renders the seller management interface.
         */
        function renderAdminSellerManagement() {
            rightPanel.innerHTML = `
                <div class="admin-config-panel col-span-4">
                    <div class="admin-config-section">
                        <h4>Verkäufer hinzufügen/bearbeiten</h4>
                        <input type="hidden" id="sellerIdInput">
                        <input type="text" id="sellerNameInput" placeholder="Verkäufername">
                        <button id="saveSellerBtn">Speichern</button>
                        <button id="cancelEditSellerBtn" class="bg-gray-500 hidden">Abbrechen</button>
                    </div>
                    <div class="admin-config-section">
                        <h4>Vorhandene Verkäufer</h4>
                        <div id="sellerList" class="admin-config-list">
                            </div>
                    </div>
                    <button class="menu-button bg-gray-500 hover:bg-gray-600 col-span-4" id="backToAdminMenuBtn">← Zurück zum Admin-Menü</button>
                </div>
            `;

            const sellerIdInput = document.getElementById('sellerIdInput');
            const sellerNameInput = document.getElementById('sellerNameInput');
            const saveSellerBtn = document.getElementById('saveSellerBtn');
            const cancelEditSellerBtn = document.getElementById('cancelEditSellerBtn');
            const sellerList = document.getElementById('sellerList');
            document.getElementById('backToAdminMenuBtn').addEventListener('click', renderAdminMainMenu);

            function populateSellerList() {
                sellerList.innerHTML = '';
                posData.sellers.forEach(seller => {
                    const item = document.createElement('div');
                    item.classList.add('admin-config-item');
                    item.innerHTML = `
                        <span>${seller.name}</span>
                        <div>
                            <button data-id="${seller.id}" class="edit-seller-btn bg-blue-500 hover:bg-blue-600">Bearbeiten</button>
                            <button data-id="${seller.id}" class="delete-seller-btn delete">Löschen</button>
                        </div>
                    `;
                    sellerList.appendChild(item);
                });

                document.querySelectorAll('.edit-seller-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const sellerToEdit = posData.sellers.find(s => s.id === id);
                        if (sellerToEdit) {
                            sellerIdInput.value = sellerToEdit.id;
                            sellerNameInput.value = sellerToEdit.name;
                            cancelEditSellerBtn.classList.remove('hidden');
                            saveSellerBtn.textContent = 'Aktualisieren';
                        }
                    });
                });

                document.querySelectorAll('.delete-seller-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        if (confirm('Sicher, dass Sie diesen Verkäufer löschen möchten?')) {
                            deleteSellerFromFirestore(id);
                        }
                    });
                });
            }

            saveSellerBtn.addEventListener('click', () => {
                const id = sellerIdInput.value || doc(collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/sellers`)).id;
                const name = sellerNameInput.value.trim();

                if (!name) {
                    showMessageBox('Fehler', 'Verkäufername darf nicht leer sein.');
                    return;
                }
                saveSellerToFirestore({ id, name });
                sellerIdInput.value = '';
                sellerNameInput.value = '';
                cancelEditSellerBtn.classList.add('hidden');
                saveSellerBtn.textContent = 'Speichern';
            });

            cancelEditSellerBtn.addEventListener('click', () => {
                sellerIdInput.value = '';
                sellerNameInput.value = '';
                cancelEditSellerBtn.classList.add('hidden');
                saveSellerBtn.textContent = 'Speichern';
            });

            populateSellerList(); // Initial population
        }

        // --- Event Listeners ---

        messageBoxClose.addEventListener('click', hideMessageBox);

        // Numeric and action button handling
        document.querySelectorAll('.num-button, .action-button').forEach(button => {
            button.addEventListener('click', () => {
                const input = button.dataset.input;
                const action = button.dataset.action;
                const func = button.dataset.function;

                if (input) {
                    if (input === 'X') {
                        // When 'X' is pressed, the currentInput becomes the multiplier
                        multiplier = parseFloat(currentInput || '1'); // If input is empty, default to 1
                        if (isNaN(multiplier) || multiplier <= 0) {
                            multiplier = 1; // Default to 1 if invalid input
                            showMessageBox('Hinweis', 'Ungültiger Multiplikator. Setze auf 1.');
                        }
                        currentInput = ''; // Clear input display after setting multiplier
                    } else if (input === '.') {
                        if (!currentInput.includes('.')) {
                            currentInput += '.';
                        }
                    } else if (input === '00') {
                        // Append 00, but handle initial empty or zero state
                        if (currentInput === '' || currentInput === '0') {
                            currentInput = '0'; // Keep as '0' or empty if no other digits
                        } else {
                            currentInput += input;
                        }
                    } else { // For digits 0-9
                        if (currentInput === '0' && input !== '.') { // Prevent multiple leading zeros, unless it's a decimal
                            currentInput = input;
                        } else {
                            currentInput += input;
                        }
                    }
                } else if (action === 'function') {
                    if (func === 'zws') {
                        // Zwischensumme logic, currently same as total
                        totalAmount.textContent = subtotalAmount.textContent;
                        cashGiven = 0; // Reset cash given for new total
                        updateChange();
                        currentInput = ''; // Clear input display after ZWS
                    } else if (func === 'bar') {
                        cashGiven = parseFloat(currentInput || '0'); // Use 0 if input is empty
                        if (isNaN(cashGiven) || cashGiven < 0) {
                            cashGiven = 0;
                            showMessageBox('Hinweis', 'Ungültiger Barbetrag.');
                        }
                        updateChange();
                        currentInput = ''; // Reset input display after BAR
                        processPayment();
                    }
                }
                inputDisplay.textContent = formatInputDisplay(currentInput);
            });
        });

        clearInputButton.addEventListener('click', () => {
            currentInput = ''; // Changed to empty string for true clear
            inputDisplay.textContent = formatInputDisplay(currentInput); // Will display "0.00"
            multiplier = 1; // Also reset multiplier
            cashGiven = 0; // Reset cash given
            updateChange(); // Update change display
        });

        newOrderButton.addEventListener('click', () => {
            showKeypad();
            saveLiveOrderToFirestore(); // Clear live display
        });

        // Admin login/logout
        adminLoginBtn.addEventListener('click', () => {
            adminLoginOverlay.classList.remove('hidden');
        });

        cancelLoginBtn.addEventListener('click', () => {
            adminLoginOverlay.classList.add('hidden');
            adminUsernameInput.value = 'admin'; // Reset for next time
            adminPasswordInput.value = 'admin123'; // Reset for next time
        });

        loginBtn.addEventListener('click', async () => {
            const username = adminUsernameInput.value;
            const password = adminPasswordInput.value;

            // Simple hardcoded admin check (for demonstration)
            // In a real application, you'd verify these credentials against a secure backend/Firebase Auth
            if (username === 'admin' && password === 'admin123') {
                adminLoginOverlay.classList.add('hidden');
                showMessageBox('Erfolg', 'Admin-Modus aktiviert.');
                enterAdminMode();
            } else {
                showMessageBox('Fehler', 'Ungültige Anmeldeinformationen.');
            }
        });

        adminLogoutBtn.addEventListener('click', () => {
            exitAdminMode();
            showMessageBox('Info', 'Admin-Modus deaktiviert.');
        });

        // Live Display Link Generation
        liveDisplayLinkBtn.addEventListener('click', () => {
            let displayUrl = '';
            // Determine the base path correctly for both local file system and web servers
            if (window.location.protocol === 'file:') {
                // For local file system, assume display.html is in the same directory
                const currentPath = window.location.href;
                const lastSlashIndex = currentPath.lastIndexOf('/');
                const basePath = currentPath.substring(0, lastSlashIndex + 1);
                displayUrl = `${basePath}display.html?appId=${appId}&registerId=${currentRegisterId}`;
            } else {
                // For web servers (like GitHub Pages)
                const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '');
                displayUrl = `${baseUrl}display.html?appId=${appId}&registerId=${currentRegisterId}`;
            }
            liveDisplayUrlInput.value = displayUrl;
            liveDisplayOverlay.classList.remove('hidden');
            console.log("Live Display Link generated:", displayUrl);
        });

        copyLiveDisplayUrlBtn.addEventListener('click', () => {
            liveDisplayUrlInput.select();
            document.execCommand('copy');
            showMessageBox('Kopiert!', 'Der Link wurde in die Zwischenablage kopiert.');
            liveDisplayOverlay.classList.add('hidden'); // Close after copying
        });

        closeLiveDisplayBtn.addEventListener('click', () => {
            liveDisplayOverlay.classList.add('hidden');
        });

        // Cash Register Selection
        cashRegisterSelect.addEventListener('change', (event) => {
            currentRegisterId = event.target.value;
            showMessageBox('Kasse gewechselt', `Sie nutzen jetzt ${cashRegisterSelect.options[cashRegisterSelect.selectedIndex].text}.`);
            
            // Clear current order on register switch to avoid confusion
            currentOrder = [];
            renderOrder();
            // Trigger a save to clear the display associated with the *old* register ID
            // And then the next save will be for the *new* register ID.
            saveLiveOrderToFirestore(); // This will use the *new* currentRegisterId
        });


        // Initial rendering of categories when the page loads
        initializeFirebase();
        renderOrder(); // Render initial empty order
        inputDisplay.textContent = formatInputDisplay(currentInput); // Set initial display to "0.00"

        // Time and Date Update
        function updateDateTime() {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
            currentTimeElem.textContent = now.toLocaleTimeString('de-DE', timeOptions);
            currentDateElem.textContent = now.toLocaleDateString('de-DE', dateOptions);
        }
        setInterval(updateDateTime, 1000); // Update every second
        updateDateTime(); // Initial call
    </script>
</body>
</html>
